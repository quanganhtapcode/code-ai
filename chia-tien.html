<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chia tiền ăn</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-light: #f0f7ff;
            --primary-dark: #1e40af;
            --text-color: #333;
            --text-light: #6c757d;
            --border-color: #ddd;
            --background-color: #f8fafc;
            --container-bg: white;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --error-color: #dc3545;
            --success-color: #198754;
            --radius: 8px;
            --progress-bg: #e9ecef;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            font-size: 16px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #3b82f6;
                --primary-light: #1e3a8a;
                --primary-dark: #60a5fa;
                --text-color: #e5e7eb;
                --text-light: #9ca3af;
                --border-color: #374151;
                --background-color: #111827;
                --container-bg: #1f2937;
                --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
                --progress-bg: #374151;
            }
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family); margin: 0 auto; padding: 15px;
            background-color: var(--background-color); color: var(--text-color);
            line-height: 1.6; -webkit-text-size-adjust: 100%; text-size-adjust: 100%;
        }
        .container {
            background-color: var(--container-bg); border-radius: var(--radius);
            max-width: 750px; margin: 0 auto; padding: 20px; box-shadow: var(--shadow);
        }
        h1 { font-size: 1.75rem; }
        h1, h2, h3 { text-align: center; color: var(--text-color); margin-bottom: 20px; line-height: 1.3; }
        h4 {
            display: flex; justify-content: space-between; align-items: center;
            text-align: center; margin-bottom: 15px; font-size: 1.1rem;
        }
        .tab-navigation {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid var(--border-color); gap: 10px;
        }
        .tab-buttons { display: flex; flex-wrap: wrap; gap: 5px; }
        .tab-button {
            padding: 8px 15px; background-color: transparent; border: 1px solid var(--border-color);
            border-bottom: none; border-radius: var(--radius) var(--radius) 0 0; cursor: pointer;
            color: var(--text-color); transition: all 0.2s ease; min-height: 44px; display: inline-flex;
            align-items: center; justify-content: center; text-align: center; font-size: 0.95rem;
        }
        .tab-button:hover { background-color: var(--primary-light); }
        .tab-button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .reset-btn {
            padding: 8px 12px; background-color: var(--primary-color); color: white; border: none;
            border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.2s ease;
            line-height: 1; min-height: 44px; min-width: 44px; display: inline-flex;
            align-items: center; justify-content: center;
        }
        .reset-btn:hover { background-color: var(--primary-dark); }
        #resetPaymentInfoBtn {
            font-size: 0.8rem; padding: 4px 8px; background-color: var(--text-light);
            min-height: auto; min-width: auto;
        }
         #resetPaymentInfoBtn:hover { background-color: var(--error-color); }
         table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.95rem; }
        th, td {
            padding: 10px 8px; text-align: left; border-bottom: 1px solid var(--border-color);
            word-wrap: break-word; vertical-align: middle;
        }
        th { background-color: var(--progress-bg); font-weight: 600; white-space: nowrap; }
        .form-group { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 15px; }
        label { margin-bottom: 5px; font-weight: 500; display: block; }
        .input-wrapper { width: 100%; position: relative; }
        input, select, textarea {
            width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid var(--border-color);
            border-radius: 4px; background-color: var(--container-bg); color: var(--text-color);
            transition: border 0.2s ease; font-size: 1rem;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); }
        input[type="number"] { -moz-appearance: textfield; }
        input.error { border-color: var(--error-color); }
        .error-message { color: var(--error-color); font-size: 0.85rem; margin-top: 4px; display: block; }
        .progress-container {
            margin: 20px 0; background-color: var(--progress-bg); border-radius: var(--radius);
            height: 20px; overflow: hidden;
        }
        .progress-bar { height: 100%; background-color: var(--primary-color); transition: width 0.5s; }
        .progress-text { text-align: center; margin-top: 5px; color: var(--text-color); font-size: 0.9rem; }
        .result { margin-top: 20px; padding: 15px; background-color: var(--primary-light); border-radius: var(--radius); text-align: center; }
        .result-value { font-size: 1.75rem; font-weight: bold; color: var(--primary-color); display: block; margin: 10px 0; word-wrap: break-word; }
        .helper-text { font-size: 0.9rem; color: var(--text-light); margin-top: 5px; line-height: 1.6; }
        .transaction-line {
            display: flex; flex-direction: column; align-items: flex-start; padding: 10px 0;
            border-bottom: 1px dashed var(--border-color); font-size: 1rem; gap: 8px;
        }
        .transaction-line:last-child { border-bottom: none; }
        .transaction-text { /* width: 100%; */ }
         .transaction-line .btn { align-self: flex-start; }
        .credit { text-align: center; margin-top: 20px; font-size: 0.8rem; color: var(--text-light); }
        .btn {
            padding: 12px 18px; background-color: var(--primary-color); color: white; border: none;
            border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.2s ease;
            white-space: nowrap; line-height: 1.2; min-height: 44px; display: inline-flex;
            align-items: center; justify-content: center; text-align: center;
        }
        .btn:hover { background-color: var(--primary-dark); }
        .btn:disabled { background-color: var(--text-light); cursor: not-allowed; opacity: 0.7; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; min-height: 36px; }
        .btn-qr-action { margin: 0 5px; }
        #itemizedForm { margin: 20px 0; }
        .itemized-table-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 10px; }
        #itemsTable th, #itemsTable td { padding: 8px 6px; vertical-align: middle; }
        #itemsTable th:nth-child(1), #itemsTable td:nth-child(1) { min-width: 100px; }
        #itemsTable th:nth-child(2), #itemsTable td:nth-child(2) { min-width: 60px; }
        #itemsTable th:nth-child(3), #itemsTable td:nth-child(3) { min-width: 150px; }
        #itemsTable th:nth-child(4), #itemsTable td:nth-child(4) { min-width: 150px; }
        #itemsTable th:nth-child(5), #itemsTable td:nth-child(5) { text-align: center; }
        #addItemBtn, #addPersonBtn, #takeawayAddPersonBtn { margin-bottom: 10px; margin-right: 5px; } /* Added takeawayAddPersonBtn */
        .delete-btn { /* General delete button style */
            background-color: var(--error-color); padding: 4px 8px; border-radius: 4px; border: none; color: white;
            cursor: pointer; min-height: auto; min-width: 30px; line-height: 1;
        }
         .delete-btn:hover { background-color: #b02a37; }
         .delete-btn:disabled { background-color: var(--text-light); cursor: not-allowed; opacity: 0.5; }
        .people-selector { display: flex; flex-wrap: wrap; gap: 5px; }
        .person-tag {
            background-color: var(--primary-light); color: var(--primary-color); padding: 3px 10px; border-radius: 15px;
            font-size: 0.85rem; cursor: pointer; border: 1px solid var(--primary-color); white-space: nowrap;
            line-height: 1.4; transition: background-color 0.2s, color 0.2s;
        }
         .person-tag:hover { background-color: #dbeafe; }
        @media (prefers-color-scheme: dark) {
            .person-tag { background-color: #374151; color: #9ca3af; border-color: #4b5563; }
             .person-tag:hover { background-color: #4b5563; }
        }
        .person-tag.selected { background-color: var(--primary-color); color: white; }
         @media (prefers-color-scheme: dark) { .person-tag.selected { background-color: var(--primary-color); color: white; } }
        .payment-options-container { margin-top: 20px; padding: 15px; background-color: var(--primary-light); border-radius: var(--radius); }
        .payment-buttons { display: flex; justify-content: space-around; margin-top: 15px; gap: 10px; flex-wrap: wrap; }
        #paymentOptions { padding: 15px; background-color: var(--container-bg); border-radius: var(--radius); margin-top: 20px; }
        #qrCodeContainer {
            text-align: center; margin-top: 20px; padding: 15px; background-color: var(--container-bg);
            border-radius: var(--radius); min-height: 150px; display: none; box-shadow: var(--shadow);
        }
        #qrCodeImage { display: block; max-width: 280px; width: 100%; height: auto; margin: 10px auto 15px auto; border: 1px solid var(--border-color); background-color: var(--progress-bg); }
        .qr-loading-text { font-style: italic; color: var(--text-light); margin-top: 10px; }
        #qrCodeContainer p { margin-bottom: 8px; word-wrap: break-word; }
        #qrActionsContainer { margin-top: 15px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }


        /* --- START: Mobile Table Stacking CSS --- */
        @media (max-width: 599px) {
            /* Hide table headers */
            #itemsTable thead,
            #takeawayPeopleTable thead {
		border: none;
		clip: rect(0 0 0 0);
		height: 1px;
		margin: -1px;
		overflow: hidden;
		padding: 0;
		position: absolute;
		width: 1px;
            }

            /* Make table/rows/cells block-level */
            .itemized-table-container {
		overflow-x: hidden; /* Prevent horizontal scroll */
            }
            #itemsTable,
            #itemsTable tbody,
            #itemsTable tr,
            #takeawayPeopleTable,
            #takeawayPeopleTable tbody,
            #takeawayPeopleTable tr {
		display: block;
		width: 100%;
            }

            #itemsTable tr,
            #takeawayPeopleTable tr {
		border: 1px solid var(--border-color);
		border-radius: var(--radius);
		margin-bottom: 15px;
		padding: 10px;
		background-color: var(--container-bg);
            }

            /* Stack table cells */
            #itemsTable td,
            #takeawayPeopleTable td {
		display: block;
		text-align: left; /* Default to left */
		padding-left: 10px; /* Base left padding */
		padding-right: 10px; /* Base right padding */
		position: relative;
		border-bottom: 1px dashed var(--border-color);
		padding-top: 8px;
		padding-bottom: 8px;
		min-height: 44px; /* Ensure minimum touch target size */
		word-wrap: break-word;
            }

            /* Remove border from last cell in stacked view */
            #itemsTable tr td:last-child,
            #takeawayPeopleTable tr td:last-child {
		border-bottom: none;
            }

            /* Add labels using ::before */
            #itemsTable td::before,
            #takeawayPeopleTable td::before {
		content: attr(data-label);
		position: absolute;
		left: 10px;
		width: 40%; /* Increased width for clarity */
		text-align: left;
		font-weight: bold;
		color: var(--text-light);
		white-space: normal;
		word-wrap: break-word;
		top: 50%; /* Center vertically */
		transform: translateY(-50%); /* Adjust for perfect centering */
            }

            /* Adjust inputs to avoid label overlap */
            #itemsTable td[data-label="Món ăn"] input,
            #itemsTable td[data-label^="Giá"] input,
            #takeawayPeopleTable td[data-label="Tên người order"] input,
            #takeawayPeopleTable td[data-label="Tiền ăn"] input {
		width: 100%;
		box-sizing: border-box;
		padding-left: calc(40% + 15px); /* Adjusted to match label width + gap */
		text-align: left;
            }

            /* Specific alignment for number inputs */
            #takeawayPeopleTable td[data-label="Tiền ăn"] input,
            #itemsTable td[data-label^="Giá"] input {
		text-align: right; /* Align currency to the right */
            }

            /* People selector grid adjustment */
            #itemsTable td[data-label="Người ăn"] .people-selector,
            #itemsTable td[data-label="Người trả"] .people-selector {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
		gap: 5px;
		margin-left: calc(40% + 15px); /* Match input padding */
		max-width: none;
		padding-top: 4px;
            }

            /* Adjust label vertical position for cells containing selectors */
            #itemsTable td[data-label="Người ăn"]::before,
            #itemsTable td[data-label="Người trả"]::before {
		top: 8px; /* Align label closer to top for selector cells */
		transform: none; /* Remove transform since top is absolute */
            }

            /* Delete button cell alignment */
            #itemsTable td[data-label="Xoá"],
            #takeawayPeopleTable td[data-label="Xoá"] {
		text-align: center;
		padding-left: 10px;
		padding-right: 10px;
		display: flex;
		justify-content: center;
		align-items: center;
		min-height: 44px;
            }

            /* Hide label for delete cell */
            #itemsTable td[data-label="Xoá"]::before,
            #takeawayPeopleTable td[data-label="Xoá"]::before {
		display: none;
            }
        }
        /* --- END: Mobile Table Stacking CSS --- */


        /* --- Media Query for Larger Screens --- */
        @media (min-width: 600px) {
            body { padding: 20px; }
            .container { padding: 30px; }
            h1 { font-size: 2rem; }
            .tab-navigation { flex-wrap: nowrap; }
            .tab-buttons { flex-wrap: nowrap; gap: 0; }
            .tab-button { padding: 10px 20px; margin-right: 5px; font-size: 1rem; }
            .tab-button:last-child { margin-right: 0; }
            .reset-btn { padding: 10px; }

            /* Restore 2-column layout for simple forms (Takeaway SHARED cost table, DineIn table) */
            /* Selecting the specific tables */
            #takeawayForm > table td:first-child, /* Target direct child table only */
            #dineInForm table td:first-child {
                width: 150px; text-align: right; padding-right: 15px;
                font-weight: 500; border-bottom: none;
            }
            #takeawayForm > table td:last-child,
            #dineInForm table td:last-child {
                 border-bottom: 1px solid var(--border-color);
            }
             #takeawayForm > table tr:last-child td:last-child,
             #dineInForm table tr:last-child td:last-child { border-bottom: none; }

             /* Payment form group layout */
            .form-group { flex-direction: row; align-items: center; margin-bottom: 10px; }
            .form-group label { flex: 0 0 120px; margin-right: 10px; margin-bottom: 0; text-align: right; }
            .form-group .input-wrapper { flex: 1 1 auto; width: auto; }

            .transaction-line { flex-direction: row; align-items: center; gap: 15px; }
            .transaction-text { flex-grow: 1; margin-right: 10px; }
            .transaction-line .btn { margin-top: 0; align-self: center; flex-shrink: 0; }
            #qrCodeImage { max-width: 300px; }
            #qrActionsContainer { flex-wrap: nowrap; }
            .itemized-table-container { overflow-x: auto; } /* Allow horizontal scroll on desktop for itemized table */
        }

        /* --- Add CSS for Takeaway People Table --- */
        /* Inherits general table styles */
        #takeawayPeopleTable th,
        #takeawayPeopleTable td {
            /* Padding handled by general/mobile styles */
            vertical-align: middle;
            /* border-bottom is handled by general td style */
        }
        /* Define min-widths for columns on larger screens */
        @media (min-width: 600px) {
            #takeawayPeopleTable th:nth-child(1), #takeawayPeopleTable td:nth-child(1) { min-width: 150px; width: 60%; } /* Name */
            #takeawayPeopleTable th:nth-child(2), #takeawayPeopleTable td:nth-child(2) { min-width: 100px; width: 30%; } /* Cost */
            #takeawayPeopleTable th:nth-child(3), #takeawayPeopleTable td:nth-child(3) { width: 10%; text-align: center; } /* Delete */
            /* Ensure inputs inside cells have appropriate padding on desktop */
            #takeawayPeopleTable td input {
                padding: 10px; /* Adjust desktop padding if needed */
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Chia tiền ăn</h1>

        <!-- Tab Navigation -->
        <div class="tab-navigation" role="tablist">
            <div class="tab-buttons">
                <button id="takeawayTab" class="tab-button active" role="tab" aria-selected="true" aria-controls="takeawayForm">Order về</button>
                <button id="dineInTab" class="tab-button" role="tab" aria-selected="false" aria-controls="dineInForm">Ăn tại quán</button>
                <button id="itemizedTab" class="tab-button" role="tab" aria-selected="false" aria-controls="itemizedForm">Tính từng món</button>
            </div>
            <button id="resetActiveTabBtn" class="reset-btn" title="Làm mới dữ liệu tab hiện tại">↻</button>
        </div>

        <!-- Takeaway Form - MODIFIED -->
        <div id="takeawayForm" role="tabpanel" aria-labelledby="takeawayTab">
            <!-- Section for adding people and their food costs -->
            <div style="margin-bottom: 15px;">
                <h4>Danh sách người order & Tiền ăn</h4>
                <button id="takeawayAddPersonBtn" class="btn btn-sm">+ Thêm người</button>
            </div>
            <div class="itemized-table-container"> <!-- Reuse styling/scrolling container -->
                <table id="takeawayPeopleTable">
                    <thead>
                        <tr>
                            <th>Tên người order</th>
                            <th>Tiền ăn (x1000)</th>
                            <th>Xoá</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- People rows will be added dynamically here by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Section for shared costs -->
            <h4 style="margin-top: 20px;">Chi phí chung</h4>
            <table> <!-- Use a simple table for shared costs -->
                <tbody>
                    <tr>
                        <td><label for="takeawayShippingCost">Tổng tiền ship</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="takeawayShippingCost" placeholder="VND x1000. VD: 15" min="0" step="any" inputmode="decimal">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="takeawayDiscount">Tổng giảm giá</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="takeawayDiscount" placeholder="VND x1000. VD: 5" min="0" step="any" inputmode="decimal">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

             <!-- Keep payment button - triggers payment info form -->
             <div class="payment-buttons">
                 <button id="openPaymentTakeaway" class="btn">Nhập thông tin thanh toán</button>
             </div>
        </div>

        <!-- Dine-in Form (Unchanged) -->
        <div id="dineInForm" role="tabpanel" aria-labelledby="dineInTab" style="display: none;">
            <table>
                 <tbody>
                    <tr>
                        <td><label for="totalFoodCost">Tổng tiền ăn</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="totalFoodCost" placeholder="VND x1000. VD: 100" min="0" step="any" inputmode="decimal">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="notEatenCost">Món không ăn</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="notEatenCost" placeholder="VND x1000. VD: 0" min="0" step="any" inputmode="decimal">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="numDiners">Số người ăn (chung)</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="numDiners" placeholder="VD: 3" min="1" step="1" inputmode="numeric">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
             <div class="payment-buttons">
                 <button id="openPaymentDineIn" class="btn">Thanh toán</button>
             </div>
        </div>

        <!-- Itemized Form (Unchanged) -->
        <div id="itemizedForm" role="tabpanel" aria-labelledby="itemizedTab" style="display: none;">
            <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
                <button id="addItemBtn" class="btn btn-sm">+ Thêm món</button>
                <button id="addPersonBtn" class="btn btn-sm">+ Thêm người</button>
            </div>
            <div class="itemized-table-container">
                <table id="itemsTable">
                    <thead>
                        <tr>
                            <th>Món ăn</th>
                            <th>Giá (x1000)</th>
                            <th>Người ăn</th>
                            <th>Người trả</th>
                            <th>Xoá</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="helper-text" style="margin-top:0;">Chọn người ăn và người đã trả tiền cho từng món.</div>
        </div>

        <!-- Progress & Result (Unchanged Structure) -->
        <div class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progressText" class="progress-text"></div>

        <div class="result">
            <span id="amountToPay" class="result-value"></span> <!-- Title/Main result line -->
            <div id="itemizedResultDetails"></div> <!-- Detailed breakdown for Takeaway/Itemized -->
            <p id="additionalInfo" class="helper-text"></p>
        </div>

         <!-- Payment Section (Unchanged Structure) -->
        <div class="payment-options-container">
             <!-- Trigger button for Itemized tab remains -->
             <div id="itemizedPaymentTrigger" class="payment-buttons" style="display: none;">
                 <button id="openPaymentItemized" class="btn">Nhập thông tin thanh toán</button>
             </div>

             <div id="paymentOptions" style="display: none;">
                 <h4>
                     <span style="flex-grow: 1;">Nhập thông tin người nhận</span>
                     <button id="resetPaymentInfoBtn" class="reset-btn btn-sm" title="Làm mới thông tin thanh toán">↻</button>
                 </h4>
                <p class="helper-text" style="text-align:center; margin-bottom:15px;">(Dùng để tạo mã QR)</p>
                <div class="form-group">
                    <label for="bankSelect">Ngân hàng:</label>
                    <div class="input-wrapper"><select id="bankSelect" aria-label="Chọn ngân hàng"></select></div>
                </div>
                <div class="form-group">
                    <label for="accountNo">Số tài khoản:</label>
                     <div class="input-wrapper"><input type="text" id="accountNo" inputmode="numeric" placeholder="Nhập số tài khoản người nhận"></div>
                </div>
                <div class="form-group">
                    <label for="accountName">Tên tài khoản:</label>
                     <div class="input-wrapper"><input type="text" id="accountName" placeholder="Tên tài khoản (không dấu, viết hoa)"></div>
                </div>
                 <div class="payment-buttons">
                     <!-- This button's visibility/text is controlled by JS -->
                     <button id="generateBankQR" class="btn" disabled>Tạo QR Thanh toán (Tổng)</button>
                </div>
                <p class="helper-text" style="text-align:center; margin-top:10px;">Tạo QR cho tổng tiền (chỉ tab Ăn Tại Quán) hoặc dùng nút "Tạo QR" bên cạnh mỗi giao dịch.</p>
            </div>

             <div id="qrCodeContainer">
                 <p id="qrLoadingText" class="qr-loading-text" style="display: none;">Đang tải mã QR...</p>
                 <img id="qrCodeImage" alt="VietQR Code" style="display: none;">
                 <p>Quét mã để thanh toán: <strong id="qrAmount"></strong></p>
                 <p class="helper-text" id="qrInfoText">(Mã QR được tạo cho giao dịch/số tiền được yêu cầu)</p>
                 <!-- Action buttons (Share/Save) will be added here by JS -->
             </div>
        </div>

        <div class="credit">Created by quanganhdeptrai</div>
    </div>

    <script>
        // Bank Data (Compressed for brevity)
        const banks = [{"id":17,"name":"Ngân hàng TMCP Công thương Việt Nam","code":"ICB","bin":"970415","shortName":"VietinBank"},{"id":43,"name":"Ngân hàng TMCP Ngoại Thương Việt Nam","code":"VCB","bin":"970436","shortName":"Vietcombank"},{"id":4,"name":"Ngân hàng TMCP Đầu tư và Phát triển Việt Nam","code":"BIDV","bin":"970418","shortName":"BIDV"},{"id":42,"name":"Ngân hàng Nông nghiệp và Phát triển Nông thôn Việt Nam","code":"VBA","bin":"970405","shortName":"Agribank"},{"id":26,"name":"Ngân hàng TMCP Phương Đông","code":"OCB","bin":"970448","shortName":"OCB"},{"id":21,"name":"Ngân hàng TMCP Quân đội","code":"MB","bin":"970422","shortName":"MBBank"},{"id":38,"name":"Ngân hàng TMCP Kỹ thương Việt Nam","code":"TCB","bin":"970407","shortName":"Techcombank"},{"id":2,"name":"Ngân hàng TMCP Á Châu","code":"ACB","bin":"970416","shortName":"ACB"},{"id":47,"name":"Ngân hàng TMCP Việt Nam Thịnh Vượng","code":"VPB","bin":"970432","shortName":"VPBank"},{"id":39,"name":"Ngân hàng TMCP Tiên Phong","code":"TPB","bin":"970423","shortName":"TPBank"},{"id":36,"name":"Ngân hàng TMCP Sài Gòn Thương Tín","code":"STB","bin":"970403","shortName":"Sacombank"},{"id":12,"name":"Ngân hàng TMCP Phát triển Thành phố Hồ Chí Minh","code":"HDB","bin":"970437","shortName":"HDBank"},{"id":44,"name":"Ngân hàng TMCP Bản Việt","code":"VCCB","bin":"970454","shortName":"VietCapitalBank"},{"id":31,"name":"Ngân hàng TMCP Sài Gòn","code":"SCB","bin":"970429","shortName":"SCB"},{"id":45,"name":"Ngân hàng TMCP Quốc tế Việt Nam","code":"VIB","bin":"970441","shortName":"VIB"},{"id":35,"name":"Ngân hàng TMCP Sài Gòn - Hà Nội","code":"SHB","bin":"970443","shortName":"SHB"},{"id":10,"name":"Ngân hàng TMCP Xuất Nhập khẩu Việt Nam","code":"EIB","bin":"970431","shortName":"Eximbank"},{"id":22,"name":"Ngân hàng TMCP Hàng Hải","code":"MSB","bin":"970426","shortName":"MSB"},{"id":53,"name":"TMCP Việt Nam Thịnh Vượng - Ngân hàng số CAKE by VPBank","code":"CAKE","bin":"546034","shortName":"CAKE"},{"id":54,"name":"TMCP Việt Nam Thịnh Vượng - Ngân hàng số Ubank by VPBank","code":"Ubank","bin":"546035","shortName":"Ubank"},{"id":58,"name":"Ngân hàng số Timo by Ban Viet Bank (Timo)","code":"TIMO","bin":"963388","shortName":"Timo"},{"id":57,"name":"Tổng Công ty Dịch vụ số Viettel - Chi nhánh tập đoàn công nghiệp viễn thông Quân Đội","code":"VTLMONEY","bin":"971005","shortName":"ViettelMoney"},{"id":56,"name":"VNPT Money","code":"VNPTMONEY","bin":"971011","shortName":"VNPTMoney"},{"id":34,"name":"Ngân hàng TMCP Sài Gòn Công Thương","code":"SGICB","bin":"970400","shortName":"SaigonBank"},{"id":3,"name":"Ngân hàng TMCP Bắc Á","code":"BAB","bin":"970409","shortName":"BacABank"},{"id":30,"name":"Ngân hàng TMCP Đại Chúng Việt Nam","code":"PVCB","bin":"970412","shortName":"PVcomBank"},{"id":27,"name":"Ngân hàng Thương mại TNHH MTV Đại Dương","code":"Oceanbank","bin":"970414","shortName":"Oceanbank"},{"id":24,"name":"Ngân hàng TMCP Quốc Dân","code":"NCB","bin":"970419","shortName":"NCB"},{"id":37,"name":"Ngân hàng TNHH MTV Shinhan Việt Nam","code":"SHBVN","bin":"970424","shortName":"ShinhanBank"},{"id":1,"name":"Ngân hàng TMCP An Bình","code":"ABB","bin":"970425","shortName":"ABBANK"},{"id":41,"name":"Ngân hàng TMCP Việt Á","code":"VAB","bin":"970427","shortName":"VietABank"},{"id":23,"name":"Ngân hàng TMCP Nam Á","code":"NAB","bin":"970428","shortName":"NamABank"},{"id":29,"name":"Ngân hàng TMCP Xăng dầu Petrolimex","code":"PGB","bin":"970430","shortName":"PGBank"},{"id":46,"name":"Ngân hàng TMCP Việt Nam Thương Tín","code":"VIETBANK","bin":"970433","shortName":"VietBank"},{"id":5,"name":"Ngân hàng TMCP Bảo Việt","code":"BVB","bin":"970438","shortName":"BaoVietBank"},{"id":33,"name":"Ngân hàng TMCP Đông Nam Á","code":"SEAB","bin":"970440","shortName":"SeABank"},{"id":52,"name":"Ngân hàng Hợp tác xã Việt Nam","code":"COOPBANK","bin":"970446","shortName":"COOPBANK"},{"id":20,"name":"Ngân hàng TMCP Lộc Phát Việt Nam","code":"LPB","bin":"970449","shortName":"LPBank"},{"id":19,"name":"Ngân hàng TMCP Kiên Long","code":"KLB","bin":"970452","shortName":"KienLongBank"},{"id":55,"name":"Ngân hàng Đại chúng TNHH Kasikornbank (KBank)","code":"KBank","bin":"668888","shortName":"KBank"},{"id":50,"name":"Ngân hàng Kookmin - Chi nhánh Hà Nội","code":"KBHN","bin":"970462","shortName":"KookminHN"},{"id":60,"name":"Ngân hàng KEB Hana – Chi nhánh Thành phố Hồ Chí Minh","code":"KEBHANAHCM","bin":"970466","shortName":"KEBHanaHCM"},{"id":61,"name":"Ngân hàng KEB Hana – Chi nhánh Hà Nội","code":"KEBHANAHN","bin":"970467","shortName":"KEBHANAHN"},{"id":62,"name":"Công ty Tài chính TNHH MTV Mirae Asset (Việt Nam)","code":"MAFC","bin":"977777","shortName":"MAFC"},{"id":59,"name":"Ngân hàng Citibank, N.A. - Chi nhánh Hà Nội","code":"CITIBANK","bin":"533948","shortName":"Citibank"},{"id":51,"name":"Ngân hàng Kookmin - Chi nhánh Thành phố Hồ Chí Minh","code":"KBHCM","bin":"970463","shortName":"KookminHCM"},{"id":63,"name":"Ngân hàng Chính sách Xã hội","code":"VBSP","bin":"999888","shortName":"VBSP"},{"id":49,"name":"Ngân hàng TNHH MTV Woori Việt Nam","code":"WVN","bin":"970457","shortName":"Woori"},{"id":48,"name":"Ngân hàng Liên doanh Việt - Nga","code":"VRB","bin":"970421","shortName":"VRB"},{"id":40,"name":"Ngân hàng United Overseas - Chi nhánh TP. Hồ Chí Minh","code":"UOB","bin":"970458","shortName":"UnitedOverseas"},{"id":32,"name":"Ngân hàng TNHH MTV Standard Chartered Bank Việt Nam","code":"SCVN","bin":"970410","shortName":"StandardChartered"},{"id":28,"name":"Ngân hàng TNHH MTV Public Việt Nam","code":"PBVN","bin":"970439","shortName":"PublicBank"},{"id":25,"name":"Ngân hàng Nonghyup - Chi nhánh Hà Nội","code":"NHB HN","bin":"801011","shortName":"Nonghyup"},{"id":18,"name":"Ngân hàng TNHH Indovina","code":"IVB","bin":"970434","shortName":"IndovinaBank"},{"id":16,"name":"Ngân hàng Công nghiệp Hàn Quốc - Chi nhánh TP. Hồ Chí Minh","code":"IBK - HCM","bin":"970456","shortName":"IBKHCM"},{"id":15,"name":"Ngân hàng Công nghiệp Hàn Quốc - Chi nhánh Hà Nội","code":"IBK - HN","bin":"970455","shortName":"IBKHN"},{"id":14,"name":"Ngân hàng TNHH MTV HSBC (Việt Nam)","code":"HSBC","bin":"458761","shortName":"HSBC"},{"id":13,"name":"Ngân hàng TNHH MTV Hong Leong Việt Nam","code":"HLBVN","bin":"970442","shortName":"HongLeong"},{"id":11,"name":"Ngân hàng Thương mại TNHH MTV Dầu Khí Toàn Cầu","code":"GPB","bin":"970408","shortName":"GPBank"},{"id":9,"name":"Ngân hàng TMCP Đông Á","code":"DOB","bin":"970406","shortName":"DongABank"},{"id":8,"name":"DBS Bank Ltd - Chi nhánh Thành phố Hồ Chí Minh","code":"DBS","bin":"796500","shortName":"DBSBank"},{"id":7,"name":"Ngân hàng TNHH MTV CIMB Việt Nam","code":"CIMB","bin":"422589","shortName":"CIMB"},{"id":6,"name":"Ngân hàng Thương mại TNHH MTV Xây dựng Việt Nam","code":"CBB","bin":"970444","shortName":"CBBank"}];

        class BillSplitter {
            constructor() {
                this.activeTab = 'takeaway';
                this.people = ['Người 1', 'Người 2', 'Người 3']; // For Itemized Tab
                this.items = []; // For Itemized Tab

                // Data for Takeaway Tab
                this.takeawayPeople = [{ name: 'Người 1', foodCost: '' }];
                this.takeawayShared = { shippingCost: '', discount: '' };

                this.lastCalculatedAmount = 0; // Primarily for DineIn tab total
                this.currentQrImageUrl = null;
                this.currentTriggerButton = null; // For QR button state

                this.initElements();
                this.initPaymentElements();

                // Populate banks FIRST, then Load data, then Init listeners
                this.populateBankSelect();
                this.loadSavedData(); // Load data (will now load takeawayPeople etc.)
                this.initEventListeners();
                // Render initial state of takeaway table AFTER loading data
                this.renderTakeawayTable();
                this.switchTab(this.activeTab); // Switch to loaded/default tab + run initial calc
            }

            initElements() {
                this.tabs = { takeaway: document.getElementById('takeawayTab'), dineIn: document.getElementById('dineInTab'), itemized: document.getElementById('itemizedTab') };
                this.forms = { takeaway: document.getElementById('takeawayForm'), dineIn: document.getElementById('dineInForm'), itemized: document.getElementById('itemizedForm') };

                // Takeaway Inputs (Modified)
                this.takeawayInputs = {
                    addPersonBtn: document.getElementById('takeawayAddPersonBtn'),
                    peopleTableBody: document.getElementById('takeawayPeopleTable')?.querySelector('tbody'),
                    shippingCost: document.getElementById('takeawayShippingCost'), // Shared cost
                    discount: document.getElementById('takeawayDiscount')         // Shared cost
                };

                this.dineInInputs = { totalFoodCost: document.getElementById('totalFoodCost'), notEatenCost: document.getElementById('notEatenCost'), numDiners: document.getElementById('numDiners') };
                this.itemizedElements = { addItemBtn: document.getElementById('addItemBtn'), addPersonBtn: document.getElementById('addPersonBtn'), itemsTableContainer: document.querySelector('#itemizedForm .itemized-table-container'), itemsTable: document.getElementById('itemsTable')?.querySelector('tbody'), itemizedPaymentTrigger: document.getElementById('itemizedPaymentTrigger'), };
                this.resultElements = { amountToPay: document.getElementById('amountToPay'), itemizedResultDetails: document.getElementById('itemizedResultDetails'), progressBar: document.getElementById('progressBar'), progressText: document.getElementById('progressText'), additionalInfo: document.getElementById('additionalInfo') };
                this.resetBtn = document.getElementById('resetActiveTabBtn');
            }

            initPaymentElements() {
                this.paymentElements = {
                    openPaymentTakeaway: document.getElementById('openPaymentTakeaway'), openPaymentDineIn: document.getElementById('openPaymentDineIn'), openPaymentItemized: document.getElementById('openPaymentItemized'),
                    paymentOptions: document.getElementById('paymentOptions'), bankSelect: document.getElementById('bankSelect'), accountNo: document.getElementById('accountNo'), accountName: document.getElementById('accountName'),
                    generateBankQR: document.getElementById('generateBankQR'), resetPaymentInfoBtn: document.getElementById('resetPaymentInfoBtn'), qrCodeContainer: document.getElementById('qrCodeContainer'),
                    qrCodeImage: document.getElementById('qrCodeImage'), qrAmount: document.getElementById('qrAmount'), qrLoadingText: document.getElementById('qrLoadingText'), qrInfoText: document.getElementById('qrInfoText')
                };
                this.initPaymentEventListeners();
            }

            initPaymentEventListeners() {
                 this.paymentElements.openPaymentTakeaway.addEventListener('click', () => this.togglePaymentOptions(true));
                 this.paymentElements.openPaymentDineIn.addEventListener('click', () => this.togglePaymentOptions(true));
                 this.paymentElements.openPaymentItemized.addEventListener('click', () => this.togglePaymentOptions(true));

                // Main QR button - NOW ONLY FOR DINE-IN
                this.paymentElements.generateBankQR.addEventListener('click', (event) => {
                    if (this.activeTab === 'dineIn') {
                         this.generateVietQR(this.lastCalculatedAmount, 'Tổng thanh toán (Ăn tại quán)', event.target);
                    } else {
                        alert('Nút này chỉ dùng cho tab "Ăn tại quán". Sử dụng nút "Tạo QR" bên cạnh mỗi giao dịch cho các tab khác.');
                    }
                });

                this.paymentElements.resetPaymentInfoBtn.addEventListener('click', () => this.resetPaymentInfo());

                // Event delegation for individual QR buttons (in results area) - Handles Takeaway & Itemized
                 this.resultElements.itemizedResultDetails.addEventListener('click', (event) => {
                    const qrButton = event.target.closest('.generate-transaction-qr');
                     if (qrButton) {
                         const amount = parseFloat(qrButton.dataset.amount);
                         const transactionTextElement = qrButton.previousElementSibling;
                         // Try to get a more descriptive text (person's name or transaction details)
                         let description = `Thanh toán`;
                         if (transactionTextElement) {
                             const nameMatch = transactionTextElement.textContent.match(/^([^:]+):/); // Get text before colon
                             if (nameMatch && nameMatch[1]) {
                                 description = `TT cho ${nameMatch[1].trim()}`; // e.g., "TT cho Người 1"
                             } else {
                                // For itemized transfers "A chuyển B: ..."
                                const transferMatch = transactionTextElement.textContent.match(/^(.+?):/);
                                if (transferMatch && transferMatch[1]) {
                                    description = transferMatch[1].trim();
                                }
                             }
                         }

                         if (!isNaN(amount) && amount > 0) {
                              if (!this.paymentElements.accountNo.value || !this.paymentElements.accountName.value || !this.paymentElements.bankSelect.value) {
                                 this.togglePaymentOptions(true);
                                 alert('Vui lòng nhập đầy đủ thông tin ngân hàng người nhận trước khi tạo QR.');
                                 this.paymentElements.paymentOptions.scrollIntoView({ behavior: 'smooth', block: 'center' });
                              } else {
                                 this.generateVietQR(amount, description, qrButton);
                              }
                         } else {
                             alert('Số tiền không hợp lệ để tạo QR.');
                         }
                     }
                 });

                 // QR Image load/error handlers
                 this.paymentElements.qrCodeImage.onerror = () => {
                     console.error("Failed to load VietQR image.");
                     this.paymentElements.qrLoadingText.textContent = 'Lỗi khi tải mã QR. Kiểm tra lại thông tin.';
                     this.paymentElements.qrLoadingText.style.display = 'block';
                     this.paymentElements.qrCodeImage.style.display = 'none';
                     this.currentQrImageUrl = null;
                     this.clearQrActions();
                     // Re-enable the original trigger button
                     if (this.currentTriggerButton) { this.toggleLoadingState(false, this.currentTriggerButton); this.currentTriggerButton = null; }
                 };
                 this.paymentElements.qrCodeImage.onload = () => {
                     this.paymentElements.qrLoadingText.style.display = 'none';
                     this.paymentElements.qrCodeImage.style.display = 'block';
                     this.addQrActions();
                     // Re-enable the original trigger button
                     if (this.currentTriggerButton) { this.toggleLoadingState(false, this.currentTriggerButton); this.currentTriggerButton = null; }
                 };
            }

            initEventListeners() {
                // Tab switching
                Object.entries(this.tabs).forEach(([tabName, tabElement]) => {
                    tabElement.addEventListener('click', () => this.switchTab(tabName));
                });

                // --- Takeaway Listeners (Modified) ---
                if (this.takeawayInputs.shippingCost) {
                     this.takeawayInputs.shippingCost.addEventListener('input', this.debounce(() => { this.takeawayShared.shippingCost = this.takeawayInputs.shippingCost.value; this.calculateTakeaway(); this.saveData(); }, 300));
                }
                if (this.takeawayInputs.discount) {
                    this.takeawayInputs.discount.addEventListener('input', this.debounce(() => { this.takeawayShared.discount = this.takeawayInputs.discount.value; this.calculateTakeaway(); this.saveData(); }, 300));
                }
                if (this.takeawayInputs.addPersonBtn) {
                    this.takeawayInputs.addPersonBtn.addEventListener('click', () => { this.addTakeawayPerson(); }); // Calc/Save handled within
                }
                // Event delegation for takeaway table
                if (this.takeawayInputs.peopleTableBody) {
                    this.takeawayInputs.peopleTableBody.addEventListener('input', this.debounce((event) => {
                        const target = event.target;
                        const row = target.closest('tr');
                        if (!row) return;
                        const index = parseInt(row.dataset.index);
                        if (isNaN(index) || !this.takeawayPeople[index]) return;

                        if (target.classList.contains('takeaway-person-name')) {
                            this.takeawayPeople[index].name = target.value;
                            this.saveData(); // Name change doesn't require recalc
                        } else if (target.classList.contains('takeaway-person-cost')) {
                            this.takeawayPeople[index].foodCost = target.value;
                            this.calculateTakeaway(); // Recalc on cost change
                            this.saveData();
                        }
                    }, 300));

                    this.takeawayInputs.peopleTableBody.addEventListener('click', (event) => {
                        if (event.target.classList.contains('takeaway-delete-btn')) {
                            const index = parseInt(event.target.closest('tr').dataset.index);
                            if (!isNaN(index)) { this.deleteTakeawayPerson(index); }
                        }
                    });
                }

                // --- Dine-in Listeners (Unchanged) ---
                Object.values(this.dineInInputs).forEach(input => { input.addEventListener('input', this.debounce(() => { this.calculateDineIn(); this.saveData(); }, 300)); });

                // --- Itemized Listeners (Unchanged) ---
                this.itemizedElements.addItemBtn.addEventListener('click', () => { this.addNewItem(); this.saveData(); });
                this.itemizedElements.addPersonBtn.addEventListener('click', () => { this.addNewPerson(); this.saveData(); });
                 // Delegation for itemized table handled within its functions (attachItemEventListeners)

                // --- General Listeners ---
                this.resetBtn.addEventListener('click', () => this.resetActiveTab());
                [this.paymentElements.bankSelect, this.paymentElements.accountNo, this.paymentElements.accountName].forEach(input => {
                    input.addEventListener('input', this.debounce(() => { this.updateGenerateQRButtonState(); this.saveData(); }, 200));
                });
                this.updateGenerateQRButtonState(); // Initial state
            }

            // --- Takeaway Tab Person Management ---
            addTakeawayPerson() {
                const newIndex = this.takeawayPeople.length;
                this.takeawayPeople.push({ name: `Người ${newIndex + 1}`, foodCost: '' });
                this.renderTakeawayTable();
                this.calculateTakeaway();
                this.saveData();
                 const newRow = this.takeawayInputs.peopleTableBody?.querySelector(`tr[data-index="${newIndex}"]`);
                 const nameInput = newRow?.querySelector('.takeaway-person-name');
                 if (nameInput) nameInput.focus();
            }

            deleteTakeawayPerson(indexToDelete) {
                if (indexToDelete < 0 || indexToDelete >= this.takeawayPeople.length) return;
                if (this.takeawayPeople.length <= 1) { alert("Phải có ít nhất một người để order."); return; }
                const personName = this.takeawayPeople[indexToDelete].name || `Người ${indexToDelete + 1}`;
                if (confirm(`Bạn có chắc muốn xoá "${personName}" khỏi danh sách order?`)) {
                    this.takeawayPeople.splice(indexToDelete, 1);
                    this.renderTakeawayTable();
                    this.calculateTakeaway();
                    this.saveData();
                }
            }

            renderTakeawayTable() {
                const tableBody = this.takeawayInputs.peopleTableBody;
                if (!tableBody) return;
                tableBody.innerHTML = '';
                this.takeawayPeople.forEach((person, index) => {
                    const row = document.createElement('tr');
                    row.dataset.index = index;
                    // IMPORTANT: Added data-label attributes matching the CSS ::before selectors
                    row.innerHTML = `
                        <td data-label="Tên người order"><input type="text" class="takeaway-person-name" value="${this.escapeHtml(person.name || '')}" placeholder="Tên người ${index + 1}"></td>
                        <td data-label="Tiền ăn"><input type="number" class="takeaway-person-cost" value="${this.escapeHtml(String(person.foodCost || ''))}" min="0" step="any" inputmode="decimal" placeholder="Giá (x1000)"></td>
                        <td data-label="Xoá"><button class="takeaway-delete-btn delete-btn btn btn-sm" aria-label="Xoá ${this.escapeHtml(person.name || `Người ${index + 1}`)}">✕</button></td>
                    `;
                    tableBody.appendChild(row);
                });
                // Disable delete button if only one person
                 const deleteButtons = tableBody.querySelectorAll('.takeaway-delete-btn');
                 if (this.takeawayPeople.length <= 1 && deleteButtons.length === 1) {
                     deleteButtons[0].disabled = true;
                 } else {
                     deleteButtons.forEach(btn => { btn.disabled = false; });
                 }
            }

            // --- Update QR Button State (Modified) ---
            updateGenerateQRButtonState() {
                const inputsFilled = this.paymentElements.bankSelect.value && this.paymentElements.accountNo.value.trim().length > 0 && this.paymentElements.accountName.value.trim().length > 0;
                const showMainQRButton = this.activeTab === 'dineIn'; // Only DineIn uses the main button
                const hasValidAmount = this.lastCalculatedAmount > 0;

                if (showMainQRButton) {
                    this.paymentElements.generateBankQR.style.display = '';
                    this.paymentElements.generateBankQR.disabled = !(inputsFilled && hasValidAmount);
                    this.paymentElements.generateBankQR.textContent = 'Tạo QR Thanh toán (Tổng)';
                } else {
                    this.paymentElements.generateBankQR.style.display = 'none'; // Hide for Takeaway and Itemized
                    this.paymentElements.generateBankQR.disabled = true;
                }
            }

            populateBankSelect() {
                const select = this.paymentElements.bankSelect;
                const currentVal = select.value;
                select.innerHTML = '<option value="" disabled selected>Chọn ngân hàng</option>'; // Select placeholder by default
                banks.sort((a, b) => a.shortName.localeCompare(b.shortName)).forEach(bank => {
                    const option = document.createElement('option');
                    option.value = bank.bin;
                    option.textContent = `${bank.shortName} - ${bank.name}`;
                    select.appendChild(option);
                });
                if (currentVal && select.querySelector(`option[value="${currentVal}"]`)) {
                    select.value = currentVal; // Restore if valid
                }
                if (!select.value) { select.selectedIndex = 0; } // Fallback to placeholder
            }

            // --- VietQR Generation (Unchanged logic, triggered by diff buttons) ---
            generateVietQR(amount, description = 'Thanh toan', triggerButton = null) {
                if (!amount || amount <= 0 || isNaN(amount)) { alert('Số tiền không hợp lệ để tạo QR.'); if (triggerButton) this.toggleLoadingState(false, triggerButton); return; }
                if (this.paymentElements.paymentOptions.style.display === 'none') { this.togglePaymentOptions(true); }

                const bankDetails = { accountNo: this.paymentElements.accountNo.value.trim(), accountName: this.paymentElements.accountName.value.trim().toUpperCase(), acqId: this.paymentElements.bankSelect.value, addInfo: description.replace(/:.*$/, '').trim().substring(0, 25) || 'Thanh toan' };
                let errors = [];
                if (!bankDetails.acqId) errors.push("Vui lòng chọn ngân hàng.");
                if (!bankDetails.accountNo || !/^\d+$/.test(bankDetails.accountNo)) errors.push("Số tài khoản không hợp lệ.");
                if (!bankDetails.accountName || bankDetails.accountName.length < 2 || bankDetails.accountName.length > 50) errors.push("Tên tài khoản không hợp lệ.");
                if (errors.length > 0) { alert("Lỗi thông tin thanh toán:\n- " + errors.join("\n- ")); this.paymentElements.accountNo.focus(); if (triggerButton) this.toggleLoadingState(false, triggerButton); return; }

                const selectedBank = banks.find(bank => bank.bin === bankDetails.acqId);
                if (!selectedBank || !selectedBank.code) { alert('Không tìm thấy mã ngân hàng (code).'); if (triggerButton) this.toggleLoadingState(false, triggerButton); return; }
                const bankImgCode = selectedBank.code;
                const template = 'compact2';
                const encodedAccountName = encodeURIComponent(bankDetails.accountName);
                const encodedAddInfo = encodeURIComponent(bankDetails.addInfo);
                const integerAmount = Math.round(amount);
                const qrImageUrl = `https://img.vietqr.io/image/${bankImgCode}-${bankDetails.accountNo}-${template}.png?amount=${integerAmount}&addInfo=${encodedAddInfo}&accountName=${encodedAccountName}`;

                this.currentQrImageUrl = qrImageUrl;
                this.currentTriggerButton = triggerButton; // Store the button
                console.log("Generating VietQR Image URL:", qrImageUrl);

                if (triggerButton) this.toggleLoadingState(true, triggerButton);
                this.paymentElements.qrCodeContainer.style.display = 'block';
                this.paymentElements.qrLoadingText.textContent = 'Đang tải mã QR...';
                this.paymentElements.qrLoadingText.style.display = 'block';
                this.paymentElements.qrCodeImage.style.display = 'none';
                this.clearQrActions();
                this.paymentElements.qrCodeImage.src = qrImageUrl; // Trigger load/error
                this.paymentElements.qrAmount.textContent = `${this.formatCurrency(integerAmount)} VND`;
                this.paymentElements.qrInfoText.textContent = `(Mã QR cho ${this.escapeHtml(description)}: ${this.formatCurrency(integerAmount)} VND)`;
                this.paymentElements.qrCodeContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // --- QR Actions (Share/Save - Using Fetch/Blob for Save) ---
             addQrActions() {
                this.clearQrActions();
                if (!this.currentQrImageUrl || !this.paymentElements.qrCodeContainer) return;

                const integerAmount = Math.round(parseFloat(this.paymentElements.qrAmount.textContent.replace(/[^\d]/g, '')) || 0);
                const paymentText = this.paymentElements.qrInfoText.textContent.replace(/^\(|\)$/g, '');
                const qrActionsContainer = document.createElement('div');
                qrActionsContainer.id = 'qrActionsContainer';

                const shareButton = document.createElement('button');
                shareButton.id = 'shareQrCode'; shareButton.className = 'btn btn-sm btn-qr-action'; shareButton.textContent = 'Chia sẻ'; shareButton.title = 'Chia sẻ mã QR này';
                shareButton.addEventListener('click', async () => {
                    if (!this.currentQrImageUrl) { alert('Không có mã QR để chia sẻ.'); return; }
                    this.toggleLoadingState(true, shareButton, 'Chia sẻ');
                    let file = null;
                    try {
                        const response = await fetch(this.currentQrImageUrl); if (!response.ok) throw new Error(`Tải ảnh thất bại (${response.status})`);
                        const blob = await response.blob(); file = new File([blob], 'VietQR.png', { type: blob.type });
                        if (navigator.canShare && navigator.canShare({ files: [file] })) { await navigator.share({ title: 'Mã QR Thanh Toán', text: paymentText, files: [file] }); }
                        else if (navigator.share) { await navigator.share({ title: 'Mã QR Thanh Toán', text: `${paymentText}\nLink ảnh: ${this.currentQrImageUrl}` }); }
                        else { alert('Chia sẻ không được hỗ trợ. Thử Lưu QR và gửi ảnh.'); }
                    } catch (error) { console.error('Lỗi khi chia sẻ:', error); if (error.name !== 'AbortError') { alert(`Không thể chia sẻ QR. Lỗi: ${error.message}.`); } }
                    finally { this.toggleLoadingState(false, shareButton, 'Chia sẻ'); }
                });

                const saveButton = document.createElement('button');
                saveButton.id = 'saveQrCode'; saveButton.className = 'btn btn-sm btn-qr-action'; saveButton.textContent = 'Lưu QR'; saveButton.title = 'Tải mã QR này về máy';
                saveButton.addEventListener('click', async () => {
                    if (!this.currentQrImageUrl) { alert('Không có mã QR để lưu.'); return; }
                    this.toggleLoadingState(true, saveButton, 'Lưu QR'); let blobUrl = null;
                    try {
                        const response = await fetch(this.currentQrImageUrl); if (!response.ok) throw new Error(`Tải ảnh thất bại (${response.status} ${response.statusText})`);
                        const blob = await response.blob(); blobUrl = URL.createObjectURL(blob);
                        const currentIntegerAmount = Math.round(parseFloat(this.paymentElements.qrAmount.textContent.replace(/[^\d]/g, '')) || 0);
                        const bankName = banks.find(b => b.bin === this.paymentElements.bankSelect.value)?.shortName || 'Bank';
                        const accNoLast4 = this.paymentElements.accountNo.value.slice(-4);
                        const filename = `VietQR_${bankName}_${accNoLast4}_${currentIntegerAmount}.png`;
                        const link = document.createElement('a'); link.href = blobUrl; link.download = filename;
                        document.body.appendChild(link); link.click(); document.body.removeChild(link);
                    } catch (error) { console.error('Lỗi khi lưu QR:', error); alert(`Không thể tự động lưu QR. Lỗi: ${error.message}. Thử nhấn chuột phải/giữ vào ảnh QR và chọn "Lưu hình ảnh thành...".`); }
                    finally { if (blobUrl) URL.revokeObjectURL(blobUrl); this.toggleLoadingState(false, saveButton, 'Lưu QR'); }
                });

                qrActionsContainer.appendChild(shareButton); qrActionsContainer.appendChild(saveButton);
                this.paymentElements.qrInfoText.insertAdjacentElement('afterend', qrActionsContainer);
             }

             clearQrActions() { const e = document.getElementById('qrActionsContainer'); if (e) e.remove(); }

            toggleLoadingState(isLoading, button, originalText = null) {
                 if (!button) return;
                 if (isLoading && !button.dataset.originalText) { button.dataset.originalText = button.textContent; }
                 const defaultText = originalText || button.dataset.originalText || button.textContent; // Get text to restore
                 const loadingText = '...';
                 button.disabled = isLoading;
                 button.textContent = isLoading ? loadingText : defaultText;
                 if (!isLoading) { delete button.dataset.originalText; }
            }

            switchTab(tabName) {
                if (!this.tabs[tabName]) return; this.activeTab = tabName;
                Object.entries(this.tabs).forEach(([n, e]) => { e.classList.toggle('active', n === tabName); e.setAttribute('aria-selected', n === tabName); });
                Object.entries(this.forms).forEach(([n, e]) => { e.style.display = n === tabName ? 'block' : 'none'; });
                this.itemizedElements.itemizedPaymentTrigger.style.display = tabName === 'itemized' ? 'flex' : 'none';
                this.resultElements.amountToPay.textContent = ''; this.resultElements.additionalInfo.innerHTML = ''; this.resultElements.itemizedResultDetails.innerHTML = '';
                this.resultElements.progressBar.style.width = '0%'; this.resultElements.progressText.textContent = '';
                if (this.paymentElements.qrCodeContainer.style.display !== 'none') { this.paymentElements.qrCodeContainer.style.display = 'none'; this.clearQrActions(); this.currentQrImageUrl = null; }
                if (tabName === 'takeaway') this.calculateTakeaway(); else if (tabName === 'dineIn') this.calculateDineIn(); else if (tabName === 'itemized') this.calculateItemized();
                this.updateGenerateQRButtonState(); this.saveData();
            }

            // --- Calculation Logic ---
            calculateTakeaway() {
                if (this.activeTab !== 'takeaway') return;

                // --- Reset Results Area ---
                this.lastCalculatedAmount = 0;
                this.resultElements.amountToPay.textContent = '';
                this.resultElements.itemizedResultDetails.innerHTML = '';
                this.resultElements.additionalInfo.innerHTML = '';
                this.resultElements.progressBar.style.width = '0%';
                this.resultElements.progressText.textContent = '';
                if (this.paymentElements.qrCodeContainer.style.display !== 'none') {
                   this.paymentElements.qrCodeContainer.style.display = 'none';
                   this.clearQrActions();
                   this.currentQrImageUrl = null;
                }

                // --- Get Inputs ---
                const peopleData = this.takeawayPeople;
                const numPeople = peopleData.length;
                const shippingCost = (parseFloat(this.takeawayShared.shippingCost) || 0) * 1000;
                const discount = (parseFloat(this.takeawayShared.discount) || 0) * 1000;

                if (numPeople === 0) {
                    this.resultElements.progressText.textContent = 'Chưa có người nào.';
                    return;
                }

                // --- Validate and Calculate Total Food Cost ---
                let totalFoodCost = 0;
                let allCostsValid = true;
                const individualCosts = peopleData.map((person, index) => {
                    const costInput = String(person.foodCost || ''); // Ensure it's a string
                    const cost = parseFloat(costInput) * 1000 || 0;
                     // Check if input was non-empty but resulted in NaN or negative
                     if (costInput !== '' && (isNaN(parseFloat(costInput)) || parseFloat(costInput) < 0)) {
                         allCostsValid = false;
                         // Optionally mark the input field with an error class
                         const inputElement = this.takeawayInputs.peopleTableBody?.querySelector(`tr[data-index="${index}"] .takeaway-person-cost`);
                         if (inputElement) inputElement.classList.add('error');
                     } else {
                        // Remove error class if valid
                        const inputElement = this.takeawayInputs.peopleTableBody?.querySelector(`tr[data-index="${index}"] .takeaway-person-cost`);
                        if (inputElement) inputElement.classList.remove('error');
                     }
                     totalFoodCost += cost;
                     return { name: person.name || `Người ${index + 1}`, foodCost: cost };
                });

                if (!allCostsValid) {
                    this.resultElements.progressText.textContent = 'Lỗi: Tiền ăn không hợp lệ.';
                    this.resultElements.itemizedResultDetails.innerHTML = '<p style="color: var(--error-color);">Vui lòng kiểm tra lại tiền ăn của mỗi người (phải là số không âm).</p>';
                    return;
                }

                // --- Calculate Shared Costs Per Person (Equal Split) ---
                const netSharedCost = shippingCost - discount;
                let sharedCostPerPerson = 0;
                if (numPeople > 0) {
                    sharedCostPerPerson = netSharedCost / numPeople;
                }

                const totalBillAfterDiscount = totalFoodCost + netSharedCost;

                // --- Calculate Individual Totals ---
                const results = [];
                individualCosts.forEach(person => {
                    const personTotalExact = person.foodCost + sharedCostPerPerson;
                    const personTotalRounded = this.roundToThousand(personTotalExact);

                    results.push({
                        name: person.name,
                        amount: personTotalRounded, // Rounded total for QR/display
                        exactAmount: personTotalExact, // Exact total for info
                        foodCost: person.foodCost,
                        sharedCost: sharedCostPerPerson
                    });
                });

                // --- Display Results ---
                this.resultElements.amountToPay.textContent = "Số tiền mỗi người cần trả:";

                if (results.length === 0) {
                    this.resultElements.itemizedResultDetails.innerHTML = '<p>Chưa có dữ liệu để tính.</p>';
                } else {
                     this.resultElements.itemizedResultDetails.innerHTML = ''; // Clear previous results first
                     results.forEach(result => {
                         const formattedAmount = this.formatCurrency(result.amount);
                         const formattedExactAmount = this.formatCurrency(result.exactAmount);
                         const formattedFood = this.formatCurrency(result.foodCost);
                         const formattedShared = this.formatCurrency(result.sharedCost);
                         const sharedCostSign = result.sharedCost >= 0 ? '+' : '-';
                         const absFormattedShared = this.formatCurrency(Math.abs(result.sharedCost));

                         const resultDiv = document.createElement('div');
                         resultDiv.classList.add('transaction-line');
                         resultDiv.innerHTML = `
                              <span class="transaction-text">
                                   ${this.escapeHtml(result.name)}: <strong>${formattedAmount} VND</strong>
                                   <small style="display:block; color: var(--text-light);">
                                        (Tiền ăn: ${formattedFood} ${sharedCostSign} Phí chung: ${absFormattedShared} = ${formattedExactAmount} VND)
                                   </small>
                              </span>
                              ${result.amount > 0 ?
                                  `<button class="btn btn-sm generate-transaction-qr"
                                           data-amount="${result.amount}"
                                           title="Tạo QR thanh toán cho ${this.escapeHtml(result.name)}">Tạo QR</button>`
                                  : ''
                              }
                          `;
                         this.resultElements.itemizedResultDetails.appendChild(resultDiv);
                     });
                }

                // Update progress bar/text
                let progressPercentage = 0;
                 const totalBillBeforeDiscount = totalFoodCost + shippingCost;
                 if (totalBillBeforeDiscount > 0 && discount < totalBillBeforeDiscount) {
                     progressPercentage = Math.max(0, Math.min((totalBillAfterDiscount / totalBillBeforeDiscount) * 100, 100));
                 } else if (totalBillAfterDiscount <= 0) {
                     progressPercentage = 0;
                 } else if (totalBillBeforeDiscount <=0 && totalBillAfterDiscount > 0) {
                    progressPercentage = 100;
                 }

                this.resultElements.progressBar.style.width = `${progressPercentage}%`;
                this.resultElements.progressText.textContent = `Tổng cộng: ${this.formatCurrency(totalBillAfterDiscount)} (Đồ ăn: ${this.formatCurrency(totalFoodCost)}, Ship: ${this.formatCurrency(shippingCost)}, Giảm: ${this.formatCurrency(discount)})`;

                this.updateGenerateQRButtonState(); // Ensure main QR button is hidden/disabled
            }

            calculateDineIn() { // --- Unchanged ---
                if (this.activeTab !== 'dineIn') return;
                const totalFoodCost = (parseFloat(this.dineInInputs.totalFoodCost.value) || 0) * 1000; const notEatenCost = (parseFloat(this.dineInInputs.notEatenCost.value) || 0) * 1000; const numDiners = parseInt(this.dineInInputs.numDiners.value) || 1;
                const isValid = numDiners > 0 && totalFoodCost >= notEatenCost && !isNaN(totalFoodCost) && !isNaN(notEatenCost);
                const foodCostToSplit = isValid ? Math.max(0, totalFoodCost - notEatenCost) : 0;
                let amountPerPerson = (isValid && numDiners > 0) ? foodCostToSplit / numDiners : 0;
                const roundedAmount = this.roundToThousand(amountPerPerson);
                this.lastCalculatedAmount = roundedAmount; // Used by generateBankQR for this tab

                if (!isValid) {
                    this.resultElements.amountToPay.textContent = 'Dữ liệu không hợp lệ';
                    this.resultElements.progressBar.style.width = `0%`;
                    this.resultElements.progressText.textContent = 'Kiểm tra lại các giá trị nhập vào.';
                    this.resultElements.additionalInfo.innerHTML = '';
                    this.resultElements.itemizedResultDetails.innerHTML = '';
                } else {
                    this.resultElements.amountToPay.textContent = this.formatCurrency(roundedAmount) + ' / người';
                    let progressPercentage = (totalFoodCost > 0) ? Math.max(0, Math.min((foodCostToSplit / totalFoodCost) * 100, 100)) : 0;
                    this.resultElements.progressBar.style.width = `${progressPercentage}%`;
                    this.resultElements.progressText.textContent = `Tiền chung: ${this.formatCurrency(foodCostToSplit)} / ${numDiners} người (Tổng bill ${this.formatCurrency(totalFoodCost)})`;
                    this.resultElements.additionalInfo.innerHTML = `Chính xác: ${this.formatCurrency(amountPerPerson)}<br>((Tổng ${this.formatCurrency(totalFoodCost)} - Không ăn chung ${this.formatCurrency(notEatenCost)}) / ${numDiners} người)`;
                    this.resultElements.itemizedResultDetails.innerHTML = '';
                }

                this.updateGenerateQRButtonState();
                if (this.lastCalculatedAmount <= 0 && this.paymentElements.qrCodeContainer.style.display !== 'none') { this.paymentElements.qrCodeContainer.style.display = 'none'; this.clearQrActions(); this.currentQrImageUrl = null; }
            }

            calculateItemized() {
                if (this.activeTab !== 'itemized') return;
                this.lastCalculatedAmount = 0; this.resultElements.amountToPay.textContent = ''; this.resultElements.itemizedResultDetails.innerHTML = ''; this.resultElements.additionalInfo.innerHTML = ''; this.resultElements.progressBar.style.width = '0%'; this.resultElements.progressText.textContent = '';
                if (this.paymentElements.qrCodeContainer.style.display !== 'none') { this.paymentElements.qrCodeContainer.style.display = 'none'; this.clearQrActions(); this.currentQrImageUrl = null; }

                if (this.items.length === 0) {
                    this.resultElements.amountToPay.textContent = 'Chưa có món ăn nào.';
                    this.resultElements.progressText.textContent = 'Thêm món ăn...';
                    this.updateGenerateQRButtonState();
                    return;
                }

                let allValidPrice = true;
                this.items.forEach((item, index) => {
                    const priceInput = String(item.price || '');
                    const inputElement = this.itemizedElements.itemsTable?.querySelector(`tr[data-index="${index}"] .item-price`);
                    if (priceInput !== '' && (isNaN(parseFloat(priceInput)) || parseFloat(priceInput) < 0)) {
                        allValidPrice = false;
                        if (inputElement) inputElement.classList.add('error');
                    } else {
                        if (inputElement) inputElement.classList.remove('error');
                    }
                });

                if (!allValidPrice) {
                    this.resultElements.amountToPay.textContent = 'Lỗi giá tiền';
                    this.resultElements.additionalInfo.innerHTML = 'Kiểm tra lại giá trị nhập vào ô "Giá" (phải là số không âm).';
                    this.resultElements.progressText.textContent = 'Lỗi giá tiền';
                    this.updateGenerateQRButtonState(); return;
                }

                const missingPayers = this.items.some(item => (parseFloat(item.price) || 0) > 0 && (!Array.isArray(item.payers) || item.payers.length === 0));
                if (missingPayers) {
                    this.resultElements.amountToPay.textContent = 'Thiếu thông tin';
                    this.resultElements.additionalInfo.innerHTML = 'Vui lòng chọn <strong>người trả</strong> cho mỗi món có giá tiền.';
                    this.resultElements.progressText.textContent = 'Thiếu người trả';
                    this.updateGenerateQRButtonState(); return;
                }

                const personCosts = Array(this.people.length).fill(0);
                const personPayments = Array(this.people.length).fill(0);
                let totalBill = 0;
                const tolerance = 1; // Tolerance for floating point comparisons

                this.items.forEach(item => {
                    const itemPrice = (parseFloat(item.price) || 0) * 1000;
                    totalBill += itemPrice;
                    const eaters = Array.isArray(item.eaters) ? item.eaters : [];
                    const payers = Array.isArray(item.payers) ? item.payers : [];

                    if (eaters.length > 0 && itemPrice > 0) {
                        const costPer = itemPrice / eaters.length;
                        eaters.forEach(idx => {
                            if (idx >= 0 && idx < personCosts.length) {
                                personCosts[idx] += costPer;
                            }
                        });
                    }
                    if (payers.length > 0 && itemPrice > 0) {
                        const payPer = itemPrice / payers.length;
                        payers.forEach(idx => {
                            if (idx >= 0 && idx < personPayments.length) {
                                personPayments[idx] += payPer;
                            }
                        });
                    }
                });

                const totalPaid = personPayments.reduce((s, p) => s + p, 0);
                const progressPercentage = totalBill > 0 ? Math.min(100, Math.max(0, (totalPaid / totalBill) * 100)) : (this.items.length > 0 ? 100 : 0);

                const netAmounts = personCosts.map((cost, index) => ({
                    index,
                    net: personPayments[index] - cost
                })).filter(p => Math.abs(p.net) > tolerance); // Only consider non-trivial balances

                this.resultElements.progressBar.style.width = `${progressPercentage}%`;
                this.resultElements.progressText.textContent = `Tổng Bill: ${this.formatCurrency(totalBill)} (${Math.round(progressPercentage)}% đã trả)`;

                if (netAmounts.length === 0) {
                    if (totalBill <= tolerance && this.items.length > 0) {
                        this.resultElements.amountToPay.textContent = 'Tổng bill là 0.';
                        this.resultElements.itemizedResultDetails.innerHTML = `<p style="color: var(--text-light);">Không cần giao dịch.</p>`;
                    } else if (totalBill > tolerance) {
                        this.resultElements.amountToPay.textContent = 'Đã cân bằng!';
                        this.resultElements.itemizedResultDetails.innerHTML = `<p style="color: var(--success-color);">Không cần chuyển khoản thêm.</p>`;
                    } else {
                        // This case should already be handled by the initial items.length check
                        this.resultElements.amountToPay.textContent = 'Chưa có món ăn nào.';
                    }
                    this.updateGenerateQRButtonState();
                    return;
                }

                const transactions = this.computeTransactions(netAmounts);

                this.resultElements.amountToPay.textContent = 'Các giao dịch cần thực hiện:';
                this.resultElements.itemizedResultDetails.innerHTML = ''; // Clear previous transactions

                if (transactions.length === 0 && netAmounts.length > 0) {
                     // This might happen if rounding errors cancel out exactly
                     this.resultElements.itemizedResultDetails.innerHTML = `<p style="color: var(--text-light);">Các khoản chênh lệch nhỏ, không cần giao dịch.</p>`;
                } else {
                    transactions.forEach(t => {
                        const roundedAmount = this.roundToThousand(t.amount);
                        if (roundedAmount <= 0) return; // Don't show zero or negative transactions
                        const formattedAmount = this.formatCurrency(roundedAmount);
                        const transactionDiv = document.createElement('div');
                        transactionDiv.classList.add('transaction-line');
                        transactionDiv.innerHTML = `
                            <span class="transaction-text">${this.escapeHtml(this.people[t.fromIndex])} chuyển ${this.escapeHtml(this.people[t.toIndex])}: <strong>${formattedAmount} VND</strong></span>
                            <button class="btn btn-sm generate-transaction-qr"
                                    data-amount="${roundedAmount}"
                                    title="Tạo QR cho giao dịch ${this.escapeHtml(this.people[t.fromIndex])} → ${this.escapeHtml(this.people[t.toIndex])}">Tạo QR</button>
                        `;
                        this.resultElements.itemizedResultDetails.appendChild(transactionDiv);
                    });
                     if (this.resultElements.itemizedResultDetails.children.length === 0) {
                         // If all transactions were rounded to 0
                         this.resultElements.itemizedResultDetails.innerHTML = `<p style="color: var(--text-light);">Các khoản chênh lệch nhỏ, không cần giao dịch.</p>`;
                     }
                }
                this.updateGenerateQRButtonState();
            }

            computeTransactions(netAmounts) {
                const tolerance = 1; // Use the same tolerance
                let debtors = netAmounts.filter(p => p.net < -tolerance)
                                    .map(p => ({ ...p })) // Create copies
                                    .sort((a, b) => a.net - b.net); // Sort by most negative first
                let creditors = netAmounts.filter(p => p.net > tolerance)
                                      .map(p => ({ ...p })) // Create copies
                                      .sort((a, b) => b.net - a.net); // Sort by most positive first

                const transactions = [];
                let dIdx = 0; // Debtor index
                let cIdx = 0; // Creditor index

                while (dIdx < debtors.length && cIdx < creditors.length) {
                    const debtor = debtors[dIdx];
                    const creditor = creditors[cIdx];
                    const amount = Math.min(-debtor.net, creditor.net);

                    if (amount > tolerance) {
                        transactions.push({
                            fromIndex: debtor.index,
                            toIndex: creditor.index,
                            amount: amount
                        });
                        debtor.net += amount;
                        creditor.net -= amount;
                    }

                    // Move to the next debtor/creditor if their balance is settled (within tolerance)
                    if (Math.abs(debtor.net) < tolerance) {
                        dIdx++;
                    }
                    if (Math.abs(creditor.net) < tolerance) {
                        cIdx++;
                    }
                }
                return transactions;
            }

            togglePaymentOptions(show) {
                const p = this.paymentElements.paymentOptions;
                const shown = p.style.display !== 'none';
                if (show && !shown) {
                    p.style.display = 'block';
                    p.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else if (!show && shown) {
                    p.style.display = 'none';
                }
            }

            resetPaymentInfo() {
                if (confirm('Xác nhận xoá thông tin Ngân hàng, Số tài khoản, Tên tài khoản?')) {
                    this.paymentElements.bankSelect.value = '';
                    this.paymentElements.accountNo.value = '';
                    this.paymentElements.accountName.value = '';
                    this.updateGenerateQRButtonState();
                    this.saveData();
                    if(this.paymentElements.qrCodeContainer.style.display !== 'none') {
                        this.paymentElements.qrCodeContainer.style.display = 'none';
                        this.clearQrActions();
                        this.currentQrImageUrl = null;
                    }
                    if(this.paymentElements.bankSelect.options.length > 0) this.paymentElements.bankSelect.selectedIndex = 0;
                }
            }

            // --- Data Persistence (Modified) ---
            loadSavedData() {
                const savedData = localStorage.getItem('billSplitterData_v2');
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        // Load Takeaway data
                        if (data.takeaway) {
                             this.takeawayPeople = (Array.isArray(data.takeaway.people) && data.takeaway.people.length > 0)
                                ? data.takeaway.people.map(p => ({ name: typeof p.name === 'string' ? p.name : '', foodCost: String(p.foodCost || '') }))
                                : [{ name: 'Người 1', foodCost: '' }];
                             this.takeawayShared = { shippingCost: data.takeaway.shippingCost || '', discount: data.takeaway.discount || '' };
                            if (this.takeawayInputs.shippingCost) this.takeawayInputs.shippingCost.value = this.takeawayShared.shippingCost;
                            if (this.takeawayInputs.discount) this.takeawayInputs.discount.value = this.takeawayShared.discount;
                        } else {
                            this.takeawayPeople = [{ name: 'Người 1', foodCost: '' }];
                            this.takeawayShared = { shippingCost: '', discount: '' };
                        }
                        // Load DineIn data
                        if (data.dineIn) {
                            this.dineInInputs.totalFoodCost.value = data.dineIn.totalFoodCost || '';
                            this.dineInInputs.notEatenCost.value = data.dineIn.notEatenCost || '';
                            this.dineInInputs.numDiners.value = data.dineIn.numDiners || '';
                        }
                        // Load Itemized data
                        if (data.itemized) {
                             this.people = (Array.isArray(data.itemized.people) && data.itemized.people.length > 0) ? data.itemized.people.map(p => String(p)) : ['Người 1', 'Người 2', 'Người 3'];
                             this.items = Array.isArray(data.itemized.items) ? data.itemized.items.map(item => ({
                                name: String(item.name || ''),
                                price: String(item.price || ''),
                                eaters: Array.isArray(item.eaters) ? item.eaters.filter(idx => typeof idx === 'number' && idx >= 0 && idx < this.people.length) : [], // Validate indices
                                payers: Array.isArray(item.payers) ? item.payers.filter(idx => typeof idx === 'number' && idx >= 0 && idx < this.people.length) : [] // Validate indices
                            })) : [];
                            this.refreshItemizedTable(); // Render loaded itemized table
                        } else {
                            this.people = ['Người 1', 'Người 2', 'Người 3'];
                            this.items = [];
                            this.refreshItemizedTable();
                        }
                        // Load Payment data
                        if(data.payment) {
                            this.paymentElements.bankSelect.value = data.payment.acqId || '';
                            this.paymentElements.accountNo.value = data.payment.accountNo || '';
                            this.paymentElements.accountName.value = data.payment.accountName || '';
                            if (!this.paymentElements.bankSelect.value && this.paymentElements.bankSelect.options.length > 0) {
                                this.paymentElements.bankSelect.selectedIndex = 0; // Reset to placeholder if saved value is invalid/empty
                            }
                        }
                        // Load active tab
                        this.activeTab = data.activeTab && this.tabs[data.activeTab] ? data.activeTab : 'takeaway';
                    } catch (e) {
                        console.error("Error parsing saved data:", e);
                        localStorage.removeItem('billSplitterData_v2'); // Clear corrupted data
                        this.resetState(true); // Reset to default
                    }
                } else {
                    this.resetState(true); // No saved data, reset to default
                }
                // NOTE: renderTakeawayTable() is called after this in constructor
            }

             resetState(resetPayment = false) {
                this.activeTab = 'takeaway';
                // Reset Takeaway
                this.takeawayPeople = [{ name: 'Người 1', foodCost: '' }]; this.takeawayShared = { shippingCost: '', discount: '' };
                if (this.takeawayInputs.shippingCost) this.takeawayInputs.shippingCost.value = ''; if (this.takeawayInputs.discount) this.takeawayInputs.discount.value = '';
                this.renderTakeawayTable(); // Render default state
                // Reset DineIn
                Object.values(this.dineInInputs).forEach(input => input.value = '');
                // Reset Itemized
                this.people = ['Người 1', 'Người 2', 'Người 3']; this.items = []; this.refreshItemizedTable();
                // Reset Payment (optional)
                if (resetPayment) {
                    this.paymentElements.bankSelect.value = '';
                    this.paymentElements.accountNo.value = '';
                    this.paymentElements.accountName.value = '';
                    if(this.paymentElements.bankSelect.options.length > 0) this.paymentElements.bankSelect.selectedIndex = 0;
                }
                // Reset Results & QR
                this.lastCalculatedAmount = 0;
                this.resultElements.amountToPay.textContent = '';
                this.resultElements.additionalInfo.innerHTML = '';
                this.resultElements.itemizedResultDetails.innerHTML = '';
                this.resultElements.progressBar.style.width = '0%';
                this.resultElements.progressText.textContent = '';
                this.paymentElements.qrCodeContainer.style.display = 'none';
                this.clearQrActions();
                this.currentQrImageUrl = null;
                this.updateGenerateQRButtonState();
             }

            saveData() {
                 const dataToSave = {
                     activeTab: this.activeTab,
                     takeaway: {
                         people: this.takeawayPeople.map(p => ({ name: p.name || '', foodCost: String(p.foodCost || '') })),
                         shippingCost: this.takeawayShared.shippingCost || '',
                         discount: this.takeawayShared.discount || ''
                     },
                     dineIn: {
                         totalFoodCost: this.dineInInputs.totalFoodCost.value,
                         notEatenCost: this.dineInInputs.notEatenCost.value,
                         numDiners: this.dineInInputs.numDiners.value
                     },
                     itemized: {
                         people: this.people,
                         items: this.items.map(item => ({
                            name: String(item.name || ''),
                            price: String(item.price || ''),
                            eaters: Array.isArray(item.eaters) ? item.eaters : [], // Assume indices are valid by this point
                            payers: Array.isArray(item.payers) ? item.payers : []  // Assume indices are valid by this point
                        }))
                     },
                     payment: {
                         acqId: this.paymentElements.bankSelect.value,
                         accountNo: this.paymentElements.accountNo.value,
                         accountName: this.paymentElements.accountName.value
                     }
                 };
                 try {
                    localStorage.setItem('billSplitterData_v2', JSON.stringify(dataToSave));
                 } catch (e) {
                    console.error("Error saving data:", e);
                    // Optionally notify the user that saving failed
                 }
             }

            resetActiveTab() {
                const activeTabName = this.tabs[this.activeTab]?.textContent || 'hiện tại';
                if (confirm(`Xác nhận xoá dữ liệu tính toán cho tab "${activeTabName}"? Thông tin thanh toán sẽ được giữ lại.`)) {
                   if (this.activeTab === 'takeaway') {
                       this.takeawayPeople = [{ name: 'Người 1', foodCost: '' }];
                       this.takeawayShared = { shippingCost: '', discount: '' };
                       if(this.takeawayInputs.shippingCost) this.takeawayInputs.shippingCost.value = '';
                       if(this.takeawayInputs.discount) this.takeawayInputs.discount.value = '';
                       this.renderTakeawayTable();
                       this.calculateTakeaway();
                   } else if (this.activeTab === 'dineIn') {
                       Object.values(this.dineInInputs).forEach(input => input.value = '');
                       this.calculateDineIn();
                   } else if (this.activeTab === 'itemized') {
                       this.people = ['Người 1', 'Người 2', 'Người 3'];
                       this.items = [];
                       this.refreshItemizedTable();
                       this.calculateItemized();
                   }
                   // Clear results area for the reset tab
                   this.lastCalculatedAmount = 0;
                   this.resultElements.amountToPay.textContent = '';
                   this.resultElements.additionalInfo.innerHTML = '';
                   this.resultElements.itemizedResultDetails.innerHTML = '';
                   this.resultElements.progressBar.style.width = '0%';
                   this.resultElements.progressText.textContent = '';
                   if (this.paymentElements.qrCodeContainer.style.display !== 'none') {
                       this.paymentElements.qrCodeContainer.style.display = 'none';
                       this.clearQrActions();
                       this.currentQrImageUrl = null;
                   }
                   this.saveData(); // Save the reset state
                }
            }

            refreshItemizedTable() {
                const tableBody = this.itemizedElements.itemsTable;
                if (!tableBody) return;
                tableBody.innerHTML = '';
                // Don't return early if items.length is 0, still need to clear the table
                // if (this.items.length === 0 && this.activeTab === 'itemized') { return; }

                this.items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.dataset.index = index;
                    // Added data-label for consistency with mobile stacking CSS
                    row.innerHTML = `
                        <td data-label="Món ăn"><input type="text" class="item-name" value="${this.escapeHtml(item.name || '')}" placeholder="Tên món ${index + 1}"></td>
                        <td data-label="Giá"><input type="number" class="item-price" value="${this.escapeHtml(String(item.price || ''))}" min="0" step="any" inputmode="decimal" placeholder="Giá (x1000)"></td>
                        <td data-label="Người ăn"><div class="people-selector eaters-selector" data-index="${index}">${this.renderPeopleSelector(index, 'eaters')}</div></td>
                        <td data-label="Người trả"><div class="people-selector payers-selector" data-index="${index}">${this.renderPeopleSelector(index, 'payers')}</div></td>
                        <td data-label="Xoá"><button class="delete-btn btn btn-sm" data-index="${index}" aria-label="Xoá món ${this.escapeHtml(item.name || `món ${index + 1}`)}">✕</button></td>
                    `;
                    tableBody.appendChild(row);
                    this.attachItemEventListeners(row, index);
                });
             }

             attachItemEventListeners(row, itemIndex) {
                 const nameInput = row.querySelector('.item-name');
                 const priceInput = row.querySelector('.item-price');
                 const deleteBtn = row.querySelector('.delete-btn');
                 const eatersSel = row.querySelector('.eaters-selector');
                 const payersSel = row.querySelector('.payers-selector');

                 if (nameInput) {
                    nameInput.addEventListener('input', this.debounce((e) => {
                        if (this.items[itemIndex]) { this.items[itemIndex].name = e.target.value; this.saveData(); }
                    }, 300));
                 }
                 if (priceInput) {
                    priceInput.addEventListener('input', this.debounce((e) => {
                        if (this.items[itemIndex]) { this.items[itemIndex].price = e.target.value; this.calculateItemized(); this.saveData(); }
                    }, 300));
                 }
                 if (deleteBtn) {
                     // Use a bound function to ensure 'this' context and allow removal
                     if (!this.boundHandleDeleteItemClick) {
                         this.boundHandleDeleteItemClick = this.handleDeleteItemClick.bind(this);
                     }
                     // Remove potential previous listener before adding new one (important for redraws)
                     deleteBtn.removeEventListener('click', this.boundHandleDeleteItemClick);
                     deleteBtn.addEventListener('click', this.boundHandleDeleteItemClick);
                 }
                 if (eatersSel) this.attachSelectorEventListeners(eatersSel);
                 if (payersSel) this.attachSelectorEventListeners(payersSel);
             }

             handleDeleteItemClick(event) {
                 const button = event.target.closest('.delete-btn');
                 if (button && button.dataset.index != null) {
                     const index = parseInt(button.dataset.index);
                     if (!isNaN(index)) {
                         this.deleteItem(index); // Call the actual delete logic
                     }
                 }
             }

             deleteItem(indexToDelete) { // New method for actual deletion
                 if (indexToDelete < 0 || indexToDelete >= this.items.length) return;
                 const itemName = this.items[indexToDelete].name || `Món ${indexToDelete + 1}`;
                 // Optional: Confirm before deleting
                 // if (confirm(`Bạn có chắc muốn xoá "${itemName}"?`)) {
                     this.items.splice(indexToDelete, 1);
                     this.refreshItemizedTable(); // Redraw table
                     this.calculateItemized(); // Recalculate
                     this.saveData(); // Save changes
                 // }
             }

             renderPeopleSelector(itemIndex, type = 'eaters') {
                const item = this.items[itemIndex];
                if (!item) return '';
                const selectedIndices = (type === 'eaters' ? item.eaters : item.payers) || [];
                // Ensure selectedIndices is always an array
                const validIndices = Array.isArray(selectedIndices) ? selectedIndices : [];

                return this.people.map((person, personIndex) => {
                    const isSelected = validIndices.includes(personIndex);
                    return `<span class="person-tag ${isSelected ? 'selected' : ''}"
                                  role="button" tabindex="0" aria-pressed="${isSelected}"
                                  data-item-index="${itemIndex}" data-person-index="${personIndex}" data-type="${type}">
                                  ${this.escapeHtml(person)}
                           </span>`;
                }).join('');
             }

             attachSelectorEventListeners(selectorContainer) {
                 // Use bound functions for event listeners
                 if (!this.boundHandlePersonTagClick) this.boundHandlePersonTagClick = this.handlePersonTagClick.bind(this);
                 if (!this.boundHandlePersonTagKeydown) this.boundHandlePersonTagKeydown = this.handlePersonTagKeydown.bind(this);

                 selectorContainer.querySelectorAll('.person-tag').forEach(tag => {
                     // Remove existing listeners before adding new ones
                     tag.removeEventListener('click', this.boundHandlePersonTagClick);
                     tag.removeEventListener('keydown', this.boundHandlePersonTagKeydown);
                     tag.addEventListener('click', this.boundHandlePersonTagClick);
                     tag.addEventListener('keydown', this.boundHandlePersonTagKeydown);
                 });
             }

             handlePersonTagClick(event) {
                const tag = event.target.closest('.person-tag');
                if (!tag) return;
                const itemIndex = parseInt(tag.dataset.itemIndex);
                const personIndex = parseInt(tag.dataset.personIndex);
                const type = tag.dataset.type;
                if (isNaN(itemIndex) || isNaN(personIndex) || !type) return;
                this.togglePersonSelection(itemIndex, personIndex, type);
             }

             handlePersonTagKeydown(event) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault(); // Prevent scrolling or other default actions
                    this.handlePersonTagClick(event); // Treat as click
                }
             }

             togglePersonSelection(itemIndex, personIndex, type = 'eaters') {
                const item = this.items[itemIndex];
                if (!item) return;

                // Initialize arrays if they don't exist
                if (type === 'eaters') {
                    item.eaters = Array.isArray(item.eaters) ? item.eaters : [];
                } else { // payers
                    item.payers = Array.isArray(item.payers) ? item.payers : [];
                }

                const targetArray = type === 'eaters' ? item.eaters : item.payers;
                const position = targetArray.indexOf(personIndex);

                if (position === -1) {
                    targetArray.push(personIndex); // Add person
                } else {
                    targetArray.splice(position, 1); // Remove person
                }

                // --- Efficiently update only the changed tag ---
                const selectorClass = type === 'eaters' ? '.eaters-selector' : '.payers-selector';
                const row = this.itemizedElements.itemsTable?.querySelector(`tr[data-index="${itemIndex}"]`);
                const tag = row?.querySelector(`${selectorClass} .person-tag[data-person-index="${personIndex}"]`);

                if (tag) {
                    tag.classList.toggle('selected', position === -1);
                    tag.setAttribute('aria-pressed', position === -1);
                } else {
                    // Fallback to redraw the whole selector if the tag wasn't found (shouldn't happen often)
                    const selectorDiv = row?.querySelector(selectorClass);
                    if (selectorDiv) {
                       selectorDiv.innerHTML = this.renderPeopleSelector(itemIndex, type);
                       this.attachSelectorEventListeners(selectorDiv);
                    }
                }

                this.calculateItemized(); // Recalculate totals
                this.saveData(); // Save the updated state
             }

             addNewPerson() {
                const defaultName = `Người ${this.people.length + 1}`;
                const personName = prompt('Nhập tên người mới:', defaultName);
                if (!personName || personName.trim() === '') return; // User cancelled or entered empty name

                const trimmedName = personName.trim();
                if (this.people.some(p => p.toLowerCase() === trimmedName.toLowerCase())) {
                    alert(`Tên "${trimmedName}" đã tồn tại.`);
                    return;
                }
                this.people.push(trimmedName);
                this.refreshItemizedTable(); // Redraw table to include the new person in selectors
                this.calculateItemized(); // Recalculate (though likely no change yet)
                this.saveData(); // Save the new list of people
             }

             addNewItem() {
                const newItem = {
                    name: '',
                    price: '',
                    eaters: [],
                    payers: []
                };
                this.items.push(newItem);
                this.refreshItemizedTable();
                this.calculateItemized();
                this.saveData();

                const newIndex = this.items.length - 1;
                const newRow = this.itemizedElements.itemsTable?.querySelector(`tr[data-index="${newIndex}"]`);
                const nameInput = newRow?.querySelector('.item-name');
                if (nameInput) nameInput.focus();
             }

            // --- Formatting Helpers (Unchanged) ---
            roundToThousand(amount) { const n = parseFloat(amount); return isNaN(n) ? 0 : Math.round(n / 1000) * 1000; }
            formatCurrency(amount) { const n = parseFloat(amount); return isNaN(n) ? '0' : new Intl.NumberFormat('vi-VN').format(Math.round(n)); }
            debounce(func, wait) { let t; return (...a) => { const c = this; clearTimeout(t); t = setTimeout(() => func.apply(c, a), wait); }; }
            escapeHtml(unsafe) {
                 if (typeof unsafe !== 'string') return unsafe; // Return non-strings as-is
                 return unsafe
                      .replace(/&/g, "&amp;")
                      .replace(/</g, "&lt;")
                      .replace(/>/g, "&gt;")
                      .replace(/"/g, "&quot;")
                      .replace(/'/g, "&#039;");
            }

        } // End of BillSplitter class

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize the class after the DOM is fully loaded
            window.billSplitter = new BillSplitter();
        });
    </script>
</body>
</html>
