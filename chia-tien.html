<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chia tiền ăn</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-light: #f0f7ff;
            --primary-dark: #1e40af;
            --text-color: #333;
            --text-light: #6c757d;
            --border-color: #ddd;
            --background-color: #f8fafc;
            --container-bg: white;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --error-color: #dc3545;
            --success-color: #198754;
            --radius: 8px;
            --progress-bg: #e9ecef;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #3b82f6;
                --primary-light: #1e3a8a;
                --primary-dark: #60a5fa;
                --text-color: #e5e7eb;
                --text-light: #9ca3af;
                --border-color: #374151;
                --background-color: #111827;
                --container-bg: #1f2937;
                --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
                --progress-bg: #374151;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            max-width: 750px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
        }

        .container {
            background-color: var(--container-bg);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        h1, h2, h3 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 20px;
        }

        .tab-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-buttons {
            display: flex;
        }

        .tab-button {
            padding: 10px 20px;
            background-color: transparent;
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: var(--radius) var(--radius) 0 0;
            cursor: pointer;
            margin-right: 5px;
            color: var(--text-color);
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            background-color: var(--primary-light);
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .reset-btn {
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s ease;
        }

        .reset-btn:hover {
            background-color: var(--primary-dark);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--progress-bg);
            font-weight: 600;
        }

        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        label {
            flex: 1;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--container-bg);
            color: var(--text-color);
            transition: border 0.2s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        input.error {
            border-color: var(--error-color);
        }

        .error-message {
            color: var(--error-color);
            font-size: 12px;
            margin-top: 4px;
        }

        .progress-container {
            margin: 20px 0;
            background-color: var(--progress-bg);
            border-radius: var(--radius);
            height: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.5s;
        }

        .progress-text {
            text-align: center;
            margin-top: 5px;
            color: var(--text-color);
            font-size: 14px;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            background-color: var(--primary-light);
            border-radius: var(--radius);
            text-align: center;
        }

        .result-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
            margin: 10px 0;
        }

        .helper-text {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }

        .credit {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            color: var(--text-light);
        }

        .btn {
            padding: 10px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }

        .btn:hover {
            background-color: var(--primary-dark);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        #itemizedForm {
            margin: 20px 0;
        }

        #addItemBtn, #addPersonBtn {
            margin-bottom: 10px;
        }

        #itemsTable .delete-btn {
            background-color: var(--error-color);
            padding: 4px 8px;
            border-radius: 4px;
            border: none;
            color: white;
            cursor: pointer;
        }

        .people-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .person-tag {
            background-color: var(--primary-light);
            color: var(--primary-color);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--primary-color);
        }

        .person-tag.selected {
            background-color: var(--primary-color);
            color: white;
        }

        #itemsTable th:nth-child(3), #itemsTable td:nth-child(3),
        #itemsTable th:nth-child(4), #itemsTable td:nth-child(4) {
            min-width: 120px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px 5px;
            }
            
            .tab-button {
                padding: 8px 12px;
                font-size: 14px;
            }

            .result-value {
                font-size: 20px;
            }

            .reset-btn {
                padding: 8px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chia tiền ăn</h1>
        
        <div class="tab-navigation" role="tablist">
            <div class="tab-buttons">
                <button id="takeawayTab" class="tab-button active" role="tab" aria-selected="true" aria-controls="takeawayForm">Order về</button>
                <button id="dineInTab" class="tab-button" role="tab" aria-selected="false" aria-controls="dineInForm">Ăn tại quán</button>
                <button id="itemizedTab" class="tab-button" role="tab" aria-selected="false" aria-controls="itemizedForm">Tính từng món</button>
            </div>
            <button id="resetActiveTabBtn" class="reset-btn" title="Làm mới">↻</button>
        </div>
        
        <!-- Takeaway mode form -->
        <div id="takeawayForm" role="tabpanel" aria-labelledby="takeawayTab">
            <table>
                <tr>
                    <th>Danh mục</th>
                    <th>Giá (×1000 VND)</th>
                </tr>
                <tr>
                    <td><label for="foodCost">Tiền ăn</label></td>
                    <td>
                        <div class="input-wrapper">
                            <input type="number" id="foodCost" placeholder="e.g., 100" min="0" step="any" aria-describedby="foodCostError">
                            <div id="foodCostError" class="error-message"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td><label for="shippingCost">Tiền ship</label></td>
                    <td>
                        <div class="input-wrapper">
                            <input type="number" id="shippingCost" placeholder="e.g., 15" min="0" step="any" aria-describedby="shippingCostError">
                            <div id="shippingCostError" class="error-message"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td><label for="discount">Giảm giá</label></td>
                    <td>
                        <div class="input-wrapper">
                            <input type="number" id="discount" placeholder="e.g., 5" min="0" step="any" aria-describedby="discountError">
                            <div id="discountError" class="error-message"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td><label for="numPeople">Số người</label></td>
                    <td>
                        <div class="input-wrapper">
                            <input type="number" id="numPeople" placeholder="e.g., 3" min="1" step="1" aria-describedby="numPeopleError">
                            <div id="numPeopleError" class="error-message"></div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- Dine-in mode form -->
        <div id="dineInForm" role="tabpanel" aria-labelledby="dineInTab" style="display: none;">
            <table>
                <tr>
                    <th>Danh mục</th>
                    <th>Giá (×1000 VND)</th>
                </tr>
                <tr>
                    <td><label for="totalFoodCost">Tổng tiền ăn</label></td>
                    <td>
                        <div class="input-wrapper">
                            <input type="number" id="totalFoodCost" placeholder="e.g., 100" min="0" step="any" aria-describedby="totalFoodCostError">
                            <div id="totalFoodCostError" class="error-message"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td><label for="notEatenCost">Món không ăn</label></td>
                    <td>
                        <div class="input-wrapper">
                            <input type="number" id="notEatenCost" placeholder="e.g., 0" min="0" step="any" aria-describedby="notEatenCostError">
                            <div id="notEatenCostError" class="error-message"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td><label for="numDiners">Số người ăn</label></td>
                    <td>
                        <div class="input-wrapper">
                            <input type="number" id="numDiners" placeholder="e.g., 3" min="1" step="1" aria-describedby="numDinersError">
                            <div id="numDinersError" class="error-message"></div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- Itemized mode form -->
        <div id="itemizedForm" role="tabpanel" aria-labelledby="itemizedTab" style="display: none;">
            <button id="addItemBtn" class="btn">+ Thêm món</button>
            <button id="addPersonBtn" class="btn">+ Thêm người</button>
            <table id="itemsTable">
                <thead>
                    <tr>
                        <th>Món ăn</th>
                        <th>Giá (×1000 VND)</th>
                        <th>Người ăn</th>
                        <th>Người trả</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Items will be added dynamically -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5">
                            <div class="helper-text">Chọn từng người ăn và người trả cho món tương ứng. Có thể có nhiều người trả cho một món.</div>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progressText" class="progress-text"></div>
        
        <div class="result">
            <span id="amountToPay" class="result-value"></span>
            <p id="additionalInfo" class="helper-text"></p>
        </div>
        
        <div class="credit">
            Created by quanganhdeptrai
        </div>
    </div>

    <script>
        class BillSplitter {
            constructor() {
                this.activeTab = 'takeaway';
                this.people = ['Người 1', 'Người 2', 'Người 3'];
                this.items = [];
                
                this.initElements();
                this.loadSavedData();
                this.initEventListeners();
                this.calculateTakeaway();
            }
            
            initElements() {
                this.tabs = {
                    takeaway: document.getElementById('takeawayTab'),
                    dineIn: document.getElementById('dineInTab'),
                    itemized: document.getElementById('itemizedTab')
                };
                
                this.forms = {
                    takeaway: document.getElementById('takeawayForm'),
                    dineIn: document.getElementById('dineInForm'),
                    itemized: document.getElementById('itemizedForm')
                };
                
                this.takeawayInputs = {
                    foodCost: document.getElementById('foodCost'),
                    shippingCost: document.getElementById('shippingCost'),
                    discount: document.getElementById('discount'),
                    numPeople: document.getElementById('numPeople')
                };
                
                this.dineInInputs = {
                    totalFoodCost: document.getElementById('totalFoodCost'),
                    notEatenCost: document.getElementById('notEatenCost'),
                    numDiners: document.getElementById('numDiners')
                };
                
                this.itemizedElements = {
                    addItemBtn: document.getElementById('addItemBtn'),
                    addPersonBtn: document.getElementById('addPersonBtn'),
                    itemsTable: document.getElementById('itemsTable').querySelector('tbody')
                };
                
                this.resultElements = {
                    amountToPay: document.getElementById('amountToPay'),
                    progressBar: document.getElementById('progressBar'),
                    progressText: document.getElementById('progressText'),
                    additionalInfo: document.getElementById('additionalInfo')
                };

                this.resetBtn = document.getElementById('resetActiveTabBtn');
            }
            
            initEventListeners() {
                Object.entries(this.tabs).forEach(([tabName, tabElement]) => {
                    tabElement.addEventListener('click', () => this.switchTab(tabName));
                });
                
                Object.values(this.takeawayInputs).forEach(input => {
                    input.addEventListener('input', this.debounce(() => {
                        this.calculateTakeaway();
                        this.saveData();
                    }, 300));
                });
                
                Object.values(this.dineInInputs).forEach(input => {
                    input.addEventListener('input', this.debounce(() => {
                        this.calculateDineIn();
                        this.saveData();
                    }, 300));
                });
                
                this.itemizedElements.addItemBtn.addEventListener('click', () => {
                    this.addNewItem();
                    this.saveData();
                });
                this.itemizedElements.addPersonBtn.addEventListener('click', () => {
                    this.addNewPerson();
                    this.saveData();
                });

                this.resetBtn.addEventListener('click', () => this.resetActiveTab());
            }
            
            switchTab(tabName) {
                this.activeTab = tabName;
                
                Object.entries(this.tabs).forEach(([name, element]) => {
                    if (name === tabName) {
                        element.classList.add('active');
                        element.setAttribute('aria-selected', 'true');
                    } else {
                        element.classList.remove('active');
                        element.setAttribute('aria-selected', 'false');
                    }
                });
                
                Object.entries(this.forms).forEach(([name, element]) => {
                    element.style.display = name === tabName ? 'block' : 'none';
                });
                
                if (tabName === 'takeaway') this.calculateTakeaway();
                else if (tabName === 'dineIn') this.calculateDineIn();
                else if (tabName === 'itemized') this.calculateItemized();
                this.saveData();
            }
            
            calculateTakeaway() {
                if (this.activeTab !== 'takeaway') return;
                
                const foodCost = (parseFloat(this.takeawayInputs.foodCost.value) || 0) * 1000;
                const shippingCost = (parseFloat(this.takeawayInputs.shippingCost.value) || 0) * 1000;
                const discount = (parseFloat(this.takeawayInputs.discount.value) || 0) * 1000;
                const numPeople = parseInt(this.takeawayInputs.numPeople.value) || 1;
                
                let amountToPay = foodCost + (shippingCost - discount) / numPeople;
                amountToPay = this.roundToThousand(amountToPay);
                
                this.resultElements.amountToPay.textContent = this.formatCurrency(amountToPay);
                
                let progressPercentage = 0;
                if (amountToPay > 0) {
                    progressPercentage = (foodCost / amountToPay) * 100;
                    progressPercentage = Math.min(progressPercentage, 100);
                }
                
                this.resultElements.progressBar.style.width = `${progressPercentage}%`;
                this.resultElements.progressText.textContent = 
                    `Tiền ăn: ${this.formatCurrency(foodCost)} (${Math.round(progressPercentage)}%) / Tiền cần trả: ${this.formatCurrency(amountToPay)}`;
                
                const shipPerPerson = (shippingCost - discount) / numPeople;
                const exactAmount = foodCost + shipPerPerson;
                this.resultElements.additionalInfo.textContent = 
                    `Chính xác: ${this.formatCurrency(exactAmount)} → Làm tròn: ${this.formatCurrency(amountToPay)}\n` +
                    `(Tiền ăn ${this.formatCurrency(foodCost)} + (Ship ${this.formatCurrency(shippingCost)} - Giảm giá ${this.formatCurrency(discount)})/${numPeople} người)`;
            }
            
            calculateDineIn() {
                if (this.activeTab !== 'dineIn') return;
                
                const totalFoodCost = (parseFloat(this.dineInInputs.totalFoodCost.value) || 0) * 1000;
                const notEatenCost = (parseFloat(this.dineInInputs.notEatenCost.value) || 0) * 1000;
                const numDiners = parseInt(this.dineInInputs.numDiners.value) || 1;
                
                const foodCostToSplit = Math.max(0, totalFoodCost - notEatenCost);
                let amountToPay = foodCostToSplit / numDiners;
                amountToPay = this.roundToThousand(amountToPay);
                
                this.resultElements.amountToPay.textContent = this.formatCurrency(amountToPay);
                
                let progressPercentage = 0;
                if (totalFoodCost > 0) {
                    progressPercentage = (foodCostToSplit / totalFoodCost) * 100;
                    progressPercentage = Math.min(progressPercentage, 100);
                }
                
                this.resultElements.progressBar.style.width = `${progressPercentage}%`;
                this.resultElements.progressText.textContent = 
                    `Món ăn của mình: ${this.formatCurrency(foodCostToSplit)} (${Math.round(progressPercentage)}%) / Tổng: ${this.formatCurrency(totalFoodCost)}`;
                
                const exactAmount = foodCostToSplit / numDiners;
                this.resultElements.additionalInfo.textContent = 
                    `Chính xác: ${this.formatCurrency(exactAmount)} → Làm tròn: ${this.formatCurrency(amountToPay)}\n` +
                    `((Tổng hóa đơn ${this.formatCurrency(totalFoodCost)} - Món không ăn ${this.formatCurrency(notEatenCost)})/${numDiners} người)`;
            }
            
            addNewItem() {
                const itemIndex = this.items.length;
                this.items.push({
                    name: `Món ăn ${itemIndex + 1}`,
                    price: 0,
                    eaters: [],
                    payers: []
                });
                
                const row = document.createElement('tr');
                row.dataset.index = itemIndex;
                row.innerHTML = `
                    <td><input type="text" class="item-name" value="${this.items[itemIndex].name}" placeholder="Tên món"></td>
                    <td><input type="number" class="item-price" value="0" min="0" step="any"></td>
                    <td><div class="people-selector eaters-selector" data-index="${itemIndex}">${this.renderPeopleSelector(itemIndex, 'eaters')}</div></td>
                    <td><div class="people-selector payers-selector" data-index="${itemIndex}">${this.renderPeopleSelector(itemIndex, 'payers')}</div></td>
                    <td><button class="delete-btn" data-index="${itemIndex}">✕</button></td>
                `;
                
                this.itemizedElements.itemsTable.appendChild(row);
                this.attachItemEventListeners(row, itemIndex);
                this.calculateItemized();
            }
            
            renderPeopleSelector(itemIndex, type = 'eaters') {
                const isPayers = type === 'payers';
                const selectedValue = isPayers ? this.items[itemIndex].payers : this.items[itemIndex].eaters;
                return this.people.map((person, personIndex) => {
                    const isSelected = selectedValue.includes(personIndex);
                    return `<span class="person-tag ${isSelected ? 'selected' : ''}" data-person-index="${personIndex}">${person}</span>`;
                }).join('');
            }
            
            togglePersonSelection(itemIndex, personIndex, type = 'eaters') {
                const targetArray = type === 'eaters' ? this.items[itemIndex].eaters : this.items[itemIndex].payers;
                const personPosition = targetArray.indexOf(personIndex);
                
                if (personPosition === -1) targetArray.push(personIndex);
                else targetArray.splice(personPosition, 1);
                
                const selectorClass = type === 'eaters' ? '.eaters-selector' : '.payers-selector';
                const selector = document.querySelector(`${selectorClass}[data-index="${itemIndex}"]`);
                selector.innerHTML = this.renderPeopleSelector(itemIndex, type);
                
                const tags = selector.querySelectorAll('.person-tag');
                tags.forEach(tag => {
                    tag.addEventListener('click', (e) => {
                        const pIndex = parseInt(e.target.dataset.personIndex);
                        this.togglePersonSelection(itemIndex, pIndex, type);
                    });
                });
                
                this.calculateItemized();
                this.saveData();
            }
            
            deleteItem(index) {
                this.items.splice(index, 1);
                const row = this.itemizedElements.itemsTable.querySelector(`tr[data-index="${index}"]`);
                if (row) row.remove();
                this.recalculateItemIndices();
                this.calculateItemized();
                this.saveData();
            }
            
            recalculateItemIndices() {
                const rows = this.itemizedElements.itemsTable.querySelectorAll('tr');
                rows.forEach((row, newIndex) => {
                    row.dataset.index = newIndex;
                    const eatersSelector = row.querySelector('.eaters-selector');
                    if (eatersSelector) eatersSelector.dataset.index = newIndex;
                    const payersSelector = row.querySelector('.payers-selector');
                    if (payersSelector) payersSelector.dataset.index = newIndex;
                    const deleteBtn = row.querySelector('.delete-btn');
                    if (deleteBtn) deleteBtn.dataset.index = newIndex;
                });
            }
            
            addNewPerson() {
                const personName = prompt('Nhập tên người:', `Người ${this.people.length + 1}`);
                if (!personName) return;
                
                this.people.push(personName);
                this.refreshItemizedTable();
                this.calculateItemized();
                this.saveData();
            }
            
            calculateItemized() {
                if (this.activeTab !== 'itemized') return;
                
                const allItemsHavePayers = this.items.every(item => item.payers && item.payers.length > 0);
                if (!allItemsHavePayers) {
                    this.resultElements.amountToPay.textContent = '';
                    this.resultElements.additionalInfo.textContent = 'Vui lòng chọn ít nhất một người trả cho mỗi món';
                    this.resultElements.progressBar.style.width = '0%';
                    this.resultElements.progressText.textContent = '';
                    return;
                }
                
                const personCosts = Array(this.people.length).fill(0);
                const personPayments = Array(this.people.length).fill(0);
                
                this.items.forEach(item => {
                    const itemPrice = item.price * 1000;
                    const eaters = item.eaters;
                    const payers = item.payers;
                    
                    if (eaters.length > 0) {
                        const pricePerPerson = itemPrice / eaters.length;
                        eaters.forEach(personIndex => {
                            personCosts[personIndex] += pricePerPerson;
                        });
                    }
                    
                    if (payers.length > 0) {
                        const payerShare = itemPrice / payers.length;
                        payers.forEach(payerIndex => {
                            personPayments[payerIndex] += payerShare;
                        });
                    }
                });
                
                const totalBill = this.items.reduce((sum, item) => sum + item.price * 1000, 0);
                const totalPaid = personPayments.reduce((sum, paid) => sum + paid, 0);
                const progressPercentage = totalBill > 0 ? (totalPaid / totalBill) * 100 : 0;
                
                const netAmounts = personCosts.map((cost, index) => {
                    const paid = personPayments[index];
                    const net = paid - cost;
                    return { index, cost, paid, net };
                }).filter(person => person.cost > 0 || person.paid > 0);
                
                if (netAmounts.length === 0) {
                    this.resultElements.amountToPay.textContent = '';
                    this.resultElements.additionalInfo.innerHTML = 'Thêm món ăn, chọn người ăn và người trả để tính tiền';
                    this.resultElements.progressBar.style.width = '0%';
                    this.resultElements.progressText.textContent = '';
                    return;
                }
                
                const transactions = this.computeTransactions(netAmounts);
                
                this.resultElements.amountToPay.textContent = 'Các giao dịch cần thực hiện:';
                if (transactions.length === 0) {
                    this.resultElements.additionalInfo.innerHTML = 'Tất cả đã thanh toán đủ, không cần chuyển khoản';
                } else {
                    const transactionText = transactions.map(t => {
                        const roundedAmount = this.roundToThousand(t.amount);
                        const formattedAmount = this.formatCurrency(roundedAmount);
                        return `${t.from} chuyển cho ${t.to} ${formattedAmount} VND`;
                    }).join('<br>');
                    this.resultElements.additionalInfo.innerHTML = transactionText;
                }
                
                this.resultElements.progressBar.style.width = `${Math.min(progressPercentage, 100)}%`;
                this.resultElements.progressText.textContent = 
                    `Đã trả: ${this.formatCurrency(totalPaid)} (${Math.round(progressPercentage)}%) / Tổng: ${this.formatCurrency(totalBill)}`;
            }
            
            computeTransactions(netAmounts) {
                const debtors = netAmounts.filter(person => person.net < 0).sort((a, b) => a.net - b.net);
                const creditors = netAmounts.filter(person => person.net > 0).sort((a, b) => b.net - a.net);
                const transactions = [];
                
                while (debtors.length > 0 && creditors.length > 0) {
                    const debtor = debtors[0];
                    const creditor = creditors[0];
                    const amount = Math.min(-debtor.net, creditor.net);
                    transactions.push({
                        from: this.people[debtor.index],
                        to: this.people[creditor.index],
                        amount: amount
                    });
                    debtor.net += amount;
                    creditor.net -= amount;
                    if (Math.abs(debtor.net) < 1e-6) debtors.shift();
                    if (Math.abs(creditor.net) < 1e-6) creditors.shift();
                }
                
                return transactions;
            }
            
            loadSavedData() {
                const savedData = localStorage.getItem('billSplitterData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.takeaway) {
                        this.takeawayInputs.foodCost.value = data.takeaway.foodCost || '';
                        this.takeawayInputs.shippingCost.value = data.takeaway.shippingCost || '';
                        this.takeawayInputs.discount.value = data.takeaway.discount || '';
                        this.takeawayInputs.numPeople.value = data.takeaway.numPeople || '';
                    }
                    if (data.dineIn) {
                        this.dineInInputs.totalFoodCost.value = data.dineIn.totalFoodCost || '';
                        this.dineInInputs.notEatenCost.value = data.dineIn.notEatenCost || '';
                        this.dineInInputs.numDiners.value = data.dineIn.numDiners || '';
                    }
                    if (data.itemized) {
                        this.people = data.itemized.people || this.people;
                        this.items = data.itemized.items || [];
                        this.refreshItemizedTable();
                    }
                    this.activeTab = data.activeTab || 'takeaway';
                    this.switchTab(this.activeTab);
                }
            }
            
            saveData() {
                const data = {
                    activeTab: this.activeTab,
                    takeaway: {
                        foodCost: this.takeawayInputs.foodCost.value,
                        shippingCost: this.takeawayInputs.shippingCost.value,
                        discount: this.takeawayInputs.discount.value,
                        numPeople: this.takeawayInputs.numPeople.value
                    },
                    dineIn: {
                        totalFoodCost: this.dineInInputs.totalFoodCost.value,
                        notEatenCost: this.dineInInputs.notEatenCost.value,
                        numDiners: this.dineInInputs.numDiners.value
                    },
                    itemized: {
                        people: this.people,
                        items: this.items
                    }
                };
                localStorage.setItem('billSplitterData', JSON.stringify(data));
            }
            
            resetActiveTab() {
                if (this.activeTab === 'takeaway') {
                    Object.values(this.takeawayInputs).forEach(input => input.value = '');
                    this.calculateTakeaway();
                } else if (this.activeTab === 'dineIn') {
                    Object.values(this.dineInInputs).forEach(input => input.value = '');
                    this.calculateDineIn();
                } else if (this.activeTab === 'itemized') {
                    this.people = ['Người 1', 'Người 2', 'Người 3'];
                    this.items = [];
                    this.itemizedElements.itemsTable.innerHTML = '';
                    this.calculateItemized();
                }
                this.saveData();
            }
            
            refreshItemizedTable() {
                this.itemizedElements.itemsTable.innerHTML = '';
                this.items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.dataset.index = index;
                    row.innerHTML = `
                        <td><input type="text" class="item-name" value="${item.name}" placeholder="Tên món"></td>
                        <td><input type="number" class="item-price" value="${item.price}" min="0" step="any"></td>
                        <td><div class="people-selector eaters-selector" data-index="${index}">${this.renderPeopleSelector(index, 'eaters')}</div></td>
                        <td><div class="people-selector payers-selector" data-index="${index}">${this.renderPeopleSelector(index, 'payers')}</div></td>
                        <td><button class="delete-btn" data-index="${index}">✕</button></td>
                    `;
                    this.itemizedElements.itemsTable.appendChild(row);
                    this.attachItemEventListeners(row, index);
                });
            }
            
            attachItemEventListeners(row, itemIndex) {
                const nameInput = row.querySelector('.item-name');
                const priceInput = row.querySelector('.item-price');
                const deleteBtn = row.querySelector('.delete-btn');
                const eaterTags = row.querySelectorAll('.eaters-selector .person-tag');
                const payerTags = row.querySelectorAll('.payers-selector .person-tag');
                
                nameInput.addEventListener('input', (e) => {
                    this.items[itemIndex].name = e.target.value;
                    this.calculateItemized();
                    this.saveData();
                });
                
                priceInput.addEventListener('input', (e) => {
                    this.items[itemIndex].price = parseFloat(e.target.value) || 0;
                    this.calculateItemized();
                    this.saveData();
                });
                
                deleteBtn.addEventListener('click', () => {
                    this.deleteItem(itemIndex);
                });
                
                eaterTags.forEach(tag => {
                    tag.addEventListener('click', (e) => {
                        const personIndex = parseInt(e.target.dataset.personIndex);
                        this.togglePersonSelection(itemIndex, personIndex, 'eaters');
                    });
                });
                
                payerTags.forEach(tag => {
                    tag.addEventListener('click', (e) => {
                        const personIndex = parseInt(e.target.dataset.personIndex);
                        this.togglePersonSelection(itemIndex, personIndex, 'payers');
                    });
                });
            }
            
            roundToThousand(amount) {
                return Math.round(amount / 1000) * 1000;
            }
            
            formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN').format(Math.round(amount));
            }
            
            debounce(func, wait) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new BillSplitter();
        });
    </script>
</body>
</html>
