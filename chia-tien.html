<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <!-- Crucial for responsiveness: sets viewport width to device width, initial zoom level -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chia tiền ăn</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-light: #f0f7ff;
            --primary-dark: #1e40af;
            --text-color: #333;
            --text-light: #6c757d;
            --border-color: #ddd;
            --background-color: #f8fafc;
            --container-bg: white;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --error-color: #dc3545;
            --success-color: #198754;
            --radius: 8px;
            --progress-bg: #e9ecef;
            /* Use system font stack for better cross-platform rendering */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            /* Slightly larger base font size for better mobile readability */
            font-size: 16px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #3b82f6;
                --primary-light: #1e3a8a;
                --primary-dark: #60a5fa;
                --text-color: #e5e7eb;
                --text-light: #9ca3af;
                --border-color: #374151;
                --background-color: #111827;
                --container-bg: #1f2937;
                --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
                --progress-bg: #374151;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
             /* Smooth scrolling for anchor links or scrollIntoView */
             scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            /* Removed max-width here, apply it to container instead */
            margin: 0 auto;
            padding: 15px; /* Slightly reduced default padding */
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6; /* Increased line-height for readability */
            -webkit-text-size-adjust: 100%; /* Prevent font scaling on iOS */
             text-size-adjust: 100%; /* Standard property */
        }

        .container {
            background-color: var(--container-bg);
            border-radius: var(--radius);
            /* Add max-width here */
            max-width: 750px;
            margin: 0 auto; /* Center container */
            padding: 20px;
            box-shadow: var(--shadow);
        }

        h1 { /* Slightly reduce heading size */
            font-size: 1.75rem;
        }

        h1, h2, h3 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 20px;
            line-height: 1.3;
        }
        h4 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: center; /* Keeps text centered despite flex */
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        /* Mobile-first styles for tab navigation */
        .tab-navigation {
            display: flex;
            /* Allow wrapping on very small screens */
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            gap: 10px; /* Add gap for wrapped items */
        }

        .tab-buttons {
            display: flex;
             /* Allow tab buttons to wrap if needed */
            flex-wrap: wrap;
            gap: 5px; /* Add gap between wrapped buttons */
        }

        .tab-button {
             /* Slightly reduced padding for mobile */
            padding: 8px 15px;
            background-color: transparent;
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: var(--radius) var(--radius) 0 0;
            cursor: pointer;
            /* Removed margin-right, using gap now */
            color: var(--text-color);
            transition: all 0.2s ease;
             /* Ensure minimum tappable size */
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.95rem; /* Slightly smaller font for mobile tabs */
        }

        .tab-button:hover {
            background-color: var(--primary-light);
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .reset-btn {
             /* Slightly reduced padding for mobile */
            padding: 8px 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem; /* Use rem for font size */
            transition: background-color 0.2s ease;
            line-height: 1;
            /* Ensure minimum tappable size */
            min-height: 44px;
            min-width: 44px; /* Ensure reset button is tappable */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .reset-btn:hover {
            background-color: var(--primary-dark);
        }

        #resetPaymentInfoBtn {
            font-size: 0.8rem;
            padding: 4px 8px;
            background-color: var(--text-light);
            min-height: auto; /* Override default reset btn size */
            min-width: auto;
        }
         #resetPaymentInfoBtn:hover {
            background-color: var(--error-color);
        }

        /* Table Styles (kept simple) */
         table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.95rem; /* Relative font size */
        }

        th, td {
             /* Adjust padding slightly for mobile */
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            /* Helps prevent text overflow */
            word-wrap: break-word;
            vertical-align: middle; /* Align content vertically */
        }

        th {
            background-color: var(--progress-bg);
            font-weight: 600;
            white-space: nowrap; /* Prevent header text wrapping */
        }

        /* Form group styling (if using divs instead of table rows) */
        /* Not strictly needed if tables are used, but demonstrates mobile-first */
        .form-group {
            display: flex;
             /* Stack label/input by default */
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px; /* Increased spacing */
        }

        label {
             /* Style for labels within tables or form-groups */
             /* margin-right: 0; */
            margin-bottom: 5px; /* Space between label and input when stacked */
            font-weight: 500; /* Slightly bolder labels */
            display: block; /* Ensure label takes its own line if needed */
        }

        .input-wrapper {
             /* Full width when stacked or within table cell */
            width: 100%;
            position: relative;
        }

        /* Input Styles */
        input, select, textarea { /* Added textarea */
            width: 100%;
            padding: 12px; /* Slightly larger padding for easier tapping */
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--container-bg);
            color: var(--text-color);
            transition: border 0.2s ease;
            font-size: 1rem; /* Ensure inputs have readable font size (>=16px avoids iOS zoom) */
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
             /* Optional: Add subtle shadow on focus */
            /* box-shadow: 0 0 0 2px var(--primary-light); */
        }

        input[type="number"] {
             /* Ensure number inputs are usable on mobile */
             -moz-appearance: textfield; /* Firefox */
        }
        /* Optional: Hide spinners for number inputs */
        /* input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        } */

        input.error {
            border-color: var(--error-color);
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.85rem;
            margin-top: 4px;
            display: block; /* Ensure it appears below */
        }

        /* Progress Bar */
        .progress-container {
            margin: 20px 0;
            background-color: var(--progress-bg);
            border-radius: var(--radius);
            height: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.5s;
        }

        .progress-text {
            text-align: center;
            margin-top: 5px;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        /* Result Display */
        .result {
            margin-top: 20px;
            padding: 15px; /* Reduced padding for mobile */
            background-color: var(--primary-light);
            border-radius: var(--radius);
            text-align: center;
        }

        .result-value {
             /* Slightly reduced font size for mobile */
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
            margin: 10px 0;
             word-wrap: break-word; /* Prevent long numbers from overflowing */
        }

        .helper-text {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 5px;
            line-height: 1.6;
        }

        /* Transaction Lines (Itemized Result) */
        .transaction-line {
            display: flex;
             /* Stack vertically by default on mobile */
            flex-direction: column;
            align-items: flex-start; /* Align items left */
            padding: 10px 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 1rem;
            gap: 8px; /* Add gap between text and button when stacked */
        }
        .transaction-line:last-child {
            border-bottom: none;
        }
        .transaction-text {
             /* Takes full width when stacked */
             /* No extra styles needed for column layout */
        }
         .transaction-line .btn { /* Style button within transaction */
             /* Use gap instead of margin */
             align-self: flex-start; /* Align button left */
         }

        /* Footer Credit */
        .credit {
            text-align: center;
            margin-top: 20px;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* General Button Styles */
        .btn {
            padding: 12px 18px; /* Larger padding for easier tapping */
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem; /* Consistent button font size */
            transition: background-color 0.2s ease;
            white-space: nowrap;
            line-height: 1.2;
             /* Ensure minimum tappable size */
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary-dark);
        }
        /* Make buttons take full width sometimes if needed */
        /* .btn-block { display: block; width: 100%; } */

        /* Smaller Buttons */
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-height: 36px; /* Smaller min-height for small buttons */
        }

        .btn-qr-action {
             margin: 0 5px; /* Spacing for QR action buttons */
        }

        /* Itemized Form Specifics */
        #itemizedForm {
            margin: 20px 0;
        }
        /* Wrapper for itemized table for scrolling on mobile */
        .itemized-table-container {
            width: 100%;
            overflow-x: auto; /* Enable horizontal scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
             margin-bottom: 10px; /* Add space below scrolled table */
        }
        #itemsTable {
             /* Ensure table doesn't force container wider unnecessarily */
             /* min-width: 500px; */ /* Set a min-width if needed, but overflow handles it */
        }
        /* Adjust item table cell padding */
        #itemsTable th, #itemsTable td {
            padding: 8px 6px; /* Slightly tighter padding */
        }
        #itemsTable th:nth-child(1), /* Name */
        #itemsTable td:nth-child(1) {
            min-width: 100px; /* Give name some space */
        }
        #itemsTable th:nth-child(2), /* Price */
        #itemsTable td:nth-child(2) {
            min-width: 60px; /* Price column */
        }
        #itemsTable th:nth-child(3), /* Eaters */
        #itemsTable td:nth-child(3) {
            min-width: 150px; /* Allow space for tags */
        }
        #itemsTable th:nth-child(4), /* Payers */
        #itemsTable td:nth-child(4) {
            min-width: 150px; /* Allow space for tags */
        }
        #itemsTable th:nth-child(5), /* Delete */
        #itemsTable td:nth-child(5) {
             text-align: center;
        }


        #addItemBtn, #addPersonBtn {
            margin-bottom: 10px;
            margin-right: 5px;
        }

        #itemsTable .delete-btn {
            background-color: var(--error-color);
            padding: 4px 8px;
            border-radius: 4px;
            border: none;
            color: white;
            cursor: pointer;
            min-height: auto; /* Override default btn size */
            min-width: 30px;
        }

        /* People Selector Tags */
        .people-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .person-tag {
            background-color: var(--primary-light);
            color: var(--primary-color);
            padding: 3px 10px; /* Slightly larger padding */
            border-radius: 15px; /* More rounded */
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid var(--primary-color);
            white-space: nowrap; /* Prevent wrapping */
            line-height: 1.4; /* Improve vertical spacing */
        }

        .person-tag.selected {
            background-color: var(--primary-color);
            color: white;
        }

        /* Payment Section */
        .payment-options-container {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--primary-light);
            border-radius: var(--radius);
        }

        .payment-buttons {
            display: flex;
            justify-content: space-around; /* Or center/flex-start */
            margin-top: 15px;
            gap: 10px; /* Add gap between buttons if multiple */
             flex-wrap: wrap; /* Allow buttons to wrap */
        }

        /* Payment Info Form (inside container) */
        #paymentOptions {
            /* Display controlled by JS */
            padding: 15px;
            background-color: white;
            border-radius: var(--radius);
            margin-top: 20px; /* Spacing when shown */
        }

        /* QR Code Display */
        #qrCodeContainer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: white; /* Use container bg or white */
            border-radius: var(--radius);
            min-height: 150px; /* Placeholder height */
            display: none; /* Controlled by JS */
            box-shadow: var(--shadow);
        }
        #qrCodeImage {
            display: block;
            /* Adjust max-width for mobile */
            max-width: 280px;
            width: 100%; /* Scale down if container is smaller */
            height: auto;
            margin: 10px auto 15px auto;
            border: 1px solid var(--border-color);
            background-color: var(--progress-bg); /* Placeholder bg */
        }
        .qr-loading-text {
             font-style: italic;
             color: var(--text-light);
             margin-top: 10px;
         }
         #qrCodeContainer p {
             margin-bottom: 8px;
             word-wrap: break-word; /* Wrap long info text */
         }
         #qrActionsContainer {
             margin-top: 15px;
             display: flex;
             justify-content: center;
             gap: 15px;
              flex-wrap: wrap; /* Allow actions to wrap on mobile */
         }

        /* --- Media Query for Larger Screens (Tablet/Desktop) --- */
        /* Apply styles when screen width is 600px or wider */
        @media (min-width: 600px) {
            body {
                 padding: 20px; /* Restore larger padding */
            }
            .container {
                padding: 30px; /* More padding on larger screens */
            }
             h1 {
                 font-size: 2rem; /* Restore larger heading */
             }
             .tab-navigation {
                 flex-wrap: nowrap; /* Prevent wrapping */
             }
            .tab-buttons {
                flex-wrap: nowrap; /* Prevent wrapping */
                gap: 0; /* Remove gap if no longer needed */
            }
            .tab-button {
                 padding: 10px 20px; /* Restore original padding */
                 margin-right: 5px; /* Add margin back */
                 font-size: 1rem; /* Restore font size */
            }
            .tab-button:last-child {
                 margin-right: 0;
            }
            .reset-btn {
                 padding: 10px; /* Restore original padding */
            }

            /* Switch simple forms back to two columns */
            /* Targeting tds within the specific forms */
            #takeawayForm table td:first-child,
            #dineInForm table td:first-child {
                width: 150px; /* Give label column a width */
                text-align: right;
                padding-right: 15px;
                font-weight: 500;
            }
            #takeawayForm table td:last-child,
            #dineInForm table td:last-child {
                /* Input column takes remaining space */
            }
             /* For payment options form-group layout */
            .form-group {
                 /* Switch back to horizontal layout */
                flex-direction: row;
                align-items: center;
                margin-bottom: 10px;
            }
            .form-group label {
                 /* Adjust flex basis for label */
                 flex: 0 0 120px; /* Fixed width label */
                 margin-right: 10px;
                 margin-bottom: 0; /* Remove bottom margin */
                 text-align: right; /* Align label text right */
            }
            .form-group .input-wrapper {
                 flex: 1 1 auto; /* Allow input to take available space */
                 width: auto; /* Reset width */
            }

            .transaction-line {
                 /* Switch back to horizontal layout */
                flex-direction: row;
                align-items: center;
                 gap: 15px;
            }
            .transaction-text {
                 flex-grow: 1; /* Allow text to take space */
                 margin-right: 10px; /* Space before button */
            }
             .transaction-line .btn {
                 margin-top: 0; /* Remove top margin */
                 align-self: center; /* Re-center button */
                 flex-shrink: 0; /* Prevent button shrinking */
             }
             #qrCodeImage {
                 max-width: 300px; /* Allow slightly larger QR on desktop */
             }
             #qrActionsContainer {
                 flex-wrap: nowrap; /* Prevent actions wrapping */
             }
             /* Remove horizontal scroll on itemized table if desired */
             .itemized-table-container {
                 /* overflow-x: visible; */ /* Uncomment to disable scroll */
             }
              /* #itemsTable {
                 min-width: 0;
             } */
        }

    </style>
</head>
<body>
    <!-- Container limits width and centers content -->
    <div class="container">
        <h1>Chia tiền ăn</h1>

        <div class="tab-navigation" role="tablist">
            <div class="tab-buttons">
                <button id="takeawayTab" class="tab-button active" role="tab" aria-selected="true" aria-controls="takeawayForm">Order về</button>
                <button id="dineInTab" class="tab-button" role="tab" aria-selected="false" aria-controls="dineInForm">Ăn tại quán</button>
                <button id="itemizedTab" class="tab-button" role="tab" aria-selected="false" aria-controls="itemizedForm">Tính từng món</button>
            </div>
            <button id="resetActiveTabBtn" class="reset-btn" title="Làm mới dữ liệu tab hiện tại">↻</button>
        </div>

        <!-- Takeaway Form -->
        <div id="takeawayForm" role="tabpanel" aria-labelledby="takeawayTab">
            <!-- Using table for layout consistency with original -->
            <table>
                <tbody>
                    <tr>
                        <td><label for="foodCost">Tiền ăn (k)</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="foodCost" placeholder="VND x1000. VD: 100" min="0" step="any" inputmode="decimal" aria-describedby="foodCostError">
                                <div id="foodCostError" class="error-message"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="shippingCost">Tiền ship (k)</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="shippingCost" placeholder="VND x1000. VD: 15" min="0" step="any" inputmode="decimal" aria-describedby="shippingCostError">
                                <div id="shippingCostError" class="error-message"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="discount">Giảm giá (k)</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="discount" placeholder="VND x1000. VD: 5" min="0" step="any" inputmode="decimal" aria-describedby="discountError">
                                <div id="discountError" class="error-message"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="numPeople">Số người chia</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="numPeople" placeholder="VD: 3" min="1" step="1" inputmode="numeric" aria-describedby="numPeopleError">
                                <div id="numPeopleError" class="error-message"></div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
             <div class="payment-buttons">
                 <button id="openPaymentTakeaway" class="btn">Thanh toán</button>
             </div>
        </div>

        <!-- Dine-in Form -->
        <div id="dineInForm" role="tabpanel" aria-labelledby="dineInTab" style="display: none;">
            <table>
                 <tbody>
                    <tr>
                        <td><label for="totalFoodCost">Tổng tiền ăn (k)</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="totalFoodCost" placeholder="VND x1000. VD: 100" min="0" step="any" inputmode="decimal" aria-describedby="totalFoodCostError">
                                <div id="totalFoodCostError" class="error-message"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="notEatenCost">Món k ăn chung (k)</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="notEatenCost" placeholder="VND x1000. VD: 0" min="0" step="any" inputmode="decimal" aria-describedby="notEatenCostError">
                                <div id="notEatenCostError" class="error-message"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="numDiners">Số người ăn (chung)</label></td>
                        <td>
                            <div class="input-wrapper">
                                <input type="number" id="numDiners" placeholder="VD: 3" min="1" step="1" inputmode="numeric" aria-describedby="numDinersError">
                                <div id="numDinersError" class="error-message"></div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
             <div class="payment-buttons">
                 <button id="openPaymentDineIn" class="btn">Thanh toán</button>
             </div>
        </div>

        <!-- Itemized Form -->
        <div id="itemizedForm" role="tabpanel" aria-labelledby="itemizedTab" style="display: none;">
             <!-- Buttons outside the scrollable table container -->
            <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
                <button id="addItemBtn" class="btn btn-sm">+ Thêm món</button>
                <button id="addPersonBtn" class="btn btn-sm">+ Thêm người</button>
            </div>
             <!-- Div to allow horizontal scrolling on mobile -->
            <div class="itemized-table-container">
                <table id="itemsTable">
                    <thead>
                        <tr>
                            <th>Món ăn</th>
                            <th>Giá (k)</th> <!-- Shorter header -->
                            <th>Người ăn</th>
                            <th>Người trả</th>
                            <th>Xoá</th> <!-- Shorter header -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Items will be added dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="helper-text" style="margin-top:0;">Chọn người ăn và người đã trả tiền cho từng món.</div>
        </div>

        <!-- Progress & Result -->
        <div class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progressText" class="progress-text"></div>

        <div class="result">
            <span id="amountToPay" class="result-value"></span>
            <div id="itemizedResultDetails"></div>
            <p id="additionalInfo" class="helper-text"></p>
        </div>

         <!-- Payment Section -->
        <div class="payment-options-container">
             <!-- Button to trigger payment info for Itemized tab -->
             <div id="itemizedPaymentTrigger" class="payment-buttons" style="display: none;">
                 <button id="openPaymentItemized" class="btn">Nhập thông tin thanh toán</button>
             </div>

             <!-- Payment Info Form (using form groups for better mobile layout control) -->
            <div id="paymentOptions" style="display: none;">
                 <h4>
                     <span style="flex-grow: 1;">Nhập thông tin người nhận</span>
                     <button id="resetPaymentInfoBtn" class="reset-btn btn-sm" title="Làm mới thông tin thanh toán">↻</button>
                 </h4>
                <p class="helper-text" style="text-align:center; margin-bottom:15px;">(Dùng để tạo mã QR)</p>

                <div class="form-group">
                    <label for="bankSelect">Ngân hàng:</label>
                    <div class="input-wrapper">
                         <select id="bankSelect" aria-label="Chọn ngân hàng"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="accountNo">Số tài khoản:</label>
                     <div class="input-wrapper">
                        <input type="text" id="accountNo" inputmode="numeric" placeholder="Nhập số tài khoản người nhận">
                     </div>
                </div>
                <div class="form-group">
                    <label for="accountName">Tên tài khoản:</label>
                     <div class="input-wrapper">
                         <input type="text" id="accountName" placeholder="Tên tài khoản (không dấu, viết hoa)">
                     </div>
                </div>
                 <div class="payment-buttons">
                     <button id="generateBankQR" class="btn" disabled>Tạo QR Thanh toán (Tổng)</button>
                </div>
                <p class="helper-text" style="text-align:center; margin-top:10px;">Tạo QR cho tổng tiền (tab Order Về / Ăn Tại Quán) hoặc dùng nút "Tạo QR" bên cạnh mỗi giao dịch (tab Từng Món).</p>
            </div>

             <!-- QR Code Display Area -->
             <div id="qrCodeContainer">
                 <p id="qrLoadingText" class="qr-loading-text" style="display: none;">Đang tải mã QR...</p>
                 <img id="qrCodeImage" alt="VietQR Code" style="display: none;">
                 <p>Quét mã để thanh toán: <strong id="qrAmount"></strong></p>
                 <p class="helper-text" id="qrInfoText">(Mã QR được tạo cho giao dịch/số tiền được yêu cầu)</p>
                 <!-- Action buttons (Share/Save) will be added here by JS -->
             </div>
        </div>

        <!-- Footer Credit -->
        <div class="credit">
            Created by quanganhdeptrai
        </div>
    </div> <!-- End of container -->

    <script>
        // Bank data array (remains the same)
        const banks = [
             {"id":17,"name":"Ngân hàng TMCP Công thương Việt Nam","code":"ICB","bin":"970415","shortName":"VietinBank"},
            {"id":43,"name":"Ngân hàng TMCP Ngoại Thương Việt Nam","code":"VCB","bin":"970436","shortName":"Vietcombank"},
            {"id":4,"name":"Ngân hàng TMCP Đầu tư và Phát triển Việt Nam","code":"BIDV","bin":"970418","shortName":"BIDV"},
            {"id":42,"name":"Ngân hàng Nông nghiệp và Phát triển Nông thôn Việt Nam","code":"VBA","bin":"970405","shortName":"Agribank"},
            {"id":26,"name":"Ngân hàng TMCP Phương Đông","code":"OCB","bin":"970448","shortName":"OCB"},
            {"id":21,"name":"Ngân hàng TMCP Quân đội","code":"MB","bin":"970422","shortName":"MBBank"},
            {"id":38,"name":"Ngân hàng TMCP Kỹ thương Việt Nam","code":"TCB","bin":"970407","shortName":"Techcombank"},
            {"id":2,"name":"Ngân hàng TMCP Á Châu","code":"ACB","bin":"970416","shortName":"ACB"},
            {"id":47,"name":"Ngân hàng TMCP Việt Nam Thịnh Vượng","code":"VPB","bin":"970432","shortName":"VPBank"},
            {"id":39,"name":"Ngân hàng TMCP Tiên Phong","code":"TPB","bin":"970423","shortName":"TPBank"},
            {"id":36,"name":"Ngân hàng TMCP Sài Gòn Thương Tín","code":"STB","bin":"970403","shortName":"Sacombank"},
            {"id":12,"name":"Ngân hàng TMCP Phát triển Thành phố Hồ Chí Minh","code":"HDB","bin":"970437","shortName":"HDBank"},
            {"id":44,"name":"Ngân hàng TMCP Bản Việt","code":"VCCB","bin":"970454","shortName":"VietCapitalBank"},
            {"id":31,"name":"Ngân hàng TMCP Sài Gòn","code":"SCB","bin":"970429","shortName":"SCB"},
            {"id":45,"name":"Ngân hàng TMCP Quốc tế Việt Nam","code":"VIB","bin":"970441","shortName":"VIB"},
            {"id":35,"name":"Ngân hàng TMCP Sài Gòn - Hà Nội","code":"SHB","bin":"970443","shortName":"SHB"},
            {"id":10,"name":"Ngân hàng TMCP Xuất Nhập khẩu Việt Nam","code":"EIB","bin":"970431","shortName":"Eximbank"},
            {"id":22,"name":"Ngân hàng TMCP Hàng Hải","code":"MSB","bin":"970426","shortName":"MSB"},
            {"id":53,"name":"TMCP Việt Nam Thịnh Vượng - Ngân hàng số CAKE by VPBank","code":"CAKE","bin":"546034","shortName":"CAKE"},
            {"id":54,"name":"TMCP Việt Nam Thịnh Vượng - Ngân hàng số Ubank by VPBank","code":"Ubank","bin":"546035","shortName":"Ubank"},
            {"id":58,"name":"Ngân hàng số Timo by Ban Viet Bank (Timo)","code":"TIMO","bin":"963388","shortName":"Timo"}, // Updated Name
            {"id":57,"name":"Tổng Công ty Dịch vụ số Viettel - Chi nhánh tập đoàn công nghiệp viễn thông Quân Đội","code":"VTLMONEY","bin":"971005","shortName":"ViettelMoney"},
            {"id":56,"name":"VNPT Money","code":"VNPTMONEY","bin":"971011","shortName":"VNPTMoney"},
            {"id":34,"name":"Ngân hàng TMCP Sài Gòn Công Thương","code":"SGICB","bin":"970400","shortName":"SaigonBank"},
            {"id":3,"name":"Ngân hàng TMCP Bắc Á","code":"BAB","bin":"970409","shortName":"BacABank"},
            {"id":30,"name":"Ngân hàng TMCP Đại Chúng Việt Nam","code":"PVCB","bin":"970412","shortName":"PVcomBank"},
            {"id":27,"name":"Ngân hàng Thương mại TNHH MTV Đại Dương","code":"Oceanbank","bin":"970414","shortName":"Oceanbank"},
            {"id":24,"name":"Ngân hàng TMCP Quốc Dân","code":"NCB","bin":"970419","shortName":"NCB"},
            {"id":37,"name":"Ngân hàng TNHH MTV Shinhan Việt Nam","code":"SHBVN","bin":"970424","shortName":"ShinhanBank"},
            {"id":1,"name":"Ngân hàng TMCP An Bình","code":"ABB","bin":"970425","shortName":"ABBANK"},
            {"id":41,"name":"Ngân hàng TMCP Việt Á","code":"VAB","bin":"970427","shortName":"VietABank"},
            {"id":23,"name":"Ngân hàng TMCP Nam Á","code":"NAB","bin":"970428","shortName":"NamABank"},
            {"id":29,"name":"Ngân hàng TMCP Xăng dầu Petrolimex","code":"PGB","bin":"970430","shortName":"PGBank"},
            {"id":46,"name":"Ngân hàng TMCP Việt Nam Thương Tín","code":"VIETBANK","bin":"970433","shortName":"VietBank"},
            {"id":5,"name":"Ngân hàng TMCP Bảo Việt","code":"BVB","bin":"970438","shortName":"BaoVietBank"},
            {"id":33,"name":"Ngân hàng TMCP Đông Nam Á","code":"SEAB","bin":"970440","shortName":"SeABank"},
            {"id":52,"name":"Ngân hàng Hợp tác xã Việt Nam","code":"COOPBANK","bin":"970446","shortName":"COOPBANK"},
            {"id":20,"name":"Ngân hàng TMCP Lộc Phát Việt Nam","code":"LPB","bin":"970449","shortName":"LPBank"},
            {"id":19,"name":"Ngân hàng TMCP Kiên Long","code":"KLB","bin":"970452","shortName":"KienLongBank"},
            {"id":55,"name":"Ngân hàng Đại chúng TNHH Kasikornbank (KBank)","code":"KBank","bin":"668888","shortName":"KBank"}, // Updated Name
            {"id":50,"name":"Ngân hàng Kookmin - Chi nhánh Hà Nội","code":"KBHN","bin":"970462","shortName":"KookminHN"},
            {"id":60,"name":"Ngân hàng KEB Hana – Chi nhánh Thành phố Hồ Chí Minh","code":"KEBHANAHCM","bin":"970466","shortName":"KEBHanaHCM"},
            {"id":61,"name":"Ngân hàng KEB Hana – Chi nhánh Hà Nội","code":"KEBHANAHN","bin":"970467","shortName":"KEBHANAHN"},
            {"id":62,"name":"Công ty Tài chính TNHH MTV Mirae Asset (Việt Nam)","code":"MAFC","bin":"977777","shortName":"MAFC"},
            {"id":59,"name":"Ngân hàng Citibank, N.A. - Chi nhánh Hà Nội","code":"CITIBANK","bin":"533948","shortName":"Citibank"},
            {"id":51,"name":"Ngân hàng Kookmin - Chi nhánh Thành phố Hồ Chí Minh","code":"KBHCM","bin":"970463","shortName":"KookminHCM"},
            {"id":63,"name":"Ngân hàng Chính sách Xã hội","code":"VBSP","bin":"999888","shortName":"VBSP"},
            {"id":49,"name":"Ngân hàng TNHH MTV Woori Việt Nam","code":"WVN","bin":"970457","shortName":"Woori"},
            {"id":48,"name":"Ngân hàng Liên doanh Việt - Nga","code":"VRB","bin":"970421","shortName":"VRB"},
            {"id":40,"name":"Ngân hàng United Overseas - Chi nhánh TP. Hồ Chí Minh","code":"UOB","bin":"970458","shortName":"UnitedOverseas"},
            {"id":32,"name":"Ngân hàng TNHH MTV Standard Chartered Bank Việt Nam","code":"SCVN","bin":"970410","shortName":"StandardChartered"},
            {"id":28,"name":"Ngân hàng TNHH MTV Public Việt Nam","code":"PBVN","bin":"970439","shortName":"PublicBank"},
            {"id":25,"name":"Ngân hàng Nonghyup - Chi nhánh Hà Nội","code":"NHB HN","bin":"801011","shortName":"Nonghyup"},
            {"id":18,"name":"Ngân hàng TNHH Indovina","code":"IVB","bin":"970434","shortName":"IndovinaBank"},
            {"id":16,"name":"Ngân hàng Công nghiệp Hàn Quốc - Chi nhánh TP. Hồ Chí Minh","code":"IBK - HCM","bin":"970456","shortName":"IBKHCM"},
            {"id":15,"name":"Ngân hàng Công nghiệp Hàn Quốc - Chi nhánh Hà Nội","code":"IBK - HN","bin":"970455","shortName":"IBKHN"},
            {"id":14,"name":"Ngân hàng TNHH MTV HSBC (Việt Nam)","code":"HSBC","bin":"458761","shortName":"HSBC"},
            {"id":13,"name":"Ngân hàng TNHH MTV Hong Leong Việt Nam","code":"HLBVN","bin":"970442","shortName":"HongLeong"},
            {"id":11,"name":"Ngân hàng Thương mại TNHH MTV Dầu Khí Toàn Cầu","code":"GPB","bin":"970408","shortName":"GPBank"},
            {"id":9,"name":"Ngân hàng TMCP Đông Á","code":"DOB","bin":"970406","shortName":"DongABank"},
            {"id":8,"name":"DBS Bank Ltd - Chi nhánh Thành phố Hồ Chí Minh","code":"DBS","bin":"796500","shortName":"DBSBank"},
            {"id":7,"name":"Ngân hàng TNHH MTV CIMB Việt Nam","code":"CIMB","bin":"422589","shortName":"CIMB"},
            {"id":6,"name":"Ngân hàng Thương mại TNHH MTV Xây dựng Việt Nam","code":"CBB","bin":"970444","shortName":"CBBank"}
        ];

        class BillSplitter {
            constructor() {
                this.activeTab = 'takeaway';
                this.people = ['Người 1', 'Người 2', 'Người 3'];
                this.items = [];
                this.lastCalculatedAmount = 0;
                this.currentQrImageUrl = null;

                this.initElements();
                this.initPaymentElements();
                this.loadSavedData(); // Load data first
                this.initEventListeners();
                this.populateBankSelect(); // Populate banks after loading potential saved selection
                this.switchTab(this.activeTab); // Switch to loaded or default tab + run initial calculation
            }

            initElements() {
                this.tabs = {
                    takeaway: document.getElementById('takeawayTab'),
                    dineIn: document.getElementById('dineInTab'),
                    itemized: document.getElementById('itemizedTab')
                };

                this.forms = {
                    takeaway: document.getElementById('takeawayForm'),
                    dineIn: document.getElementById('dineInForm'),
                    itemized: document.getElementById('itemizedForm')
                };

                this.takeawayInputs = {
                    foodCost: document.getElementById('foodCost'),
                    shippingCost: document.getElementById('shippingCost'),
                    discount: document.getElementById('discount'),
                    numPeople: document.getElementById('numPeople')
                };

                this.dineInInputs = {
                    totalFoodCost: document.getElementById('totalFoodCost'),
                    notEatenCost: document.getElementById('notEatenCost'),
                    numDiners: document.getElementById('numDiners')
                };

                this.itemizedElements = {
                    addItemBtn: document.getElementById('addItemBtn'),
                    addPersonBtn: document.getElementById('addPersonBtn'),
                    itemsTableContainer: document.querySelector('.itemized-table-container'), // Reference the container
                    itemsTable: document.getElementById('itemsTable').querySelector('tbody'), // Target tbody
                    itemizedPaymentTrigger: document.getElementById('itemizedPaymentTrigger'),
                };

                this.resultElements = {
                    amountToPay: document.getElementById('amountToPay'),
                    itemizedResultDetails: document.getElementById('itemizedResultDetails'),
                    progressBar: document.getElementById('progressBar'),
                    progressText: document.getElementById('progressText'),
                    additionalInfo: document.getElementById('additionalInfo')
                };

                this.resetBtn = document.getElementById('resetActiveTabBtn');
            }

            initPaymentElements() {
                this.paymentElements = {
                    openPaymentTakeaway: document.getElementById('openPaymentTakeaway'),
                    openPaymentDineIn: document.getElementById('openPaymentDineIn'),
                    openPaymentItemized: document.getElementById('openPaymentItemized'),
                    paymentOptions: document.getElementById('paymentOptions'),
                    bankSelect: document.getElementById('bankSelect'),
                    accountNo: document.getElementById('accountNo'),
                    accountName: document.getElementById('accountName'),
                    generateBankQR: document.getElementById('generateBankQR'),
                    resetPaymentInfoBtn: document.getElementById('resetPaymentInfoBtn'),
                    qrCodeContainer: document.getElementById('qrCodeContainer'),
                    qrCodeImage: document.getElementById('qrCodeImage'),
                    qrAmount: document.getElementById('qrAmount'),
                    qrLoadingText: document.getElementById('qrLoadingText'),
                    qrInfoText: document.getElementById('qrInfoText')
                };
                this.initPaymentEventListeners(); // Initialize listeners specific to payment
            }

            initPaymentEventListeners() {
                 // Buttons to show the payment form
                 this.paymentElements.openPaymentTakeaway.addEventListener('click', () => this.togglePaymentOptions(true));
                 this.paymentElements.openPaymentDineIn.addEventListener('click', () => this.togglePaymentOptions(true));
                 this.paymentElements.openPaymentItemized.addEventListener('click', () => this.togglePaymentOptions(true));

                // Main QR generator button (for Takeaway/Dine-in tabs)
                this.paymentElements.generateBankQR.addEventListener('click', (event) => {
                    if (this.activeTab === 'takeaway' || this.activeTab === 'dineIn') {
                         this.generateVietQR(this.lastCalculatedAmount, 'Tổng thanh toán', event.target);
                    } else {
                         // Button should be hidden/disabled anyway, but good to have fallback logic
                        alert('Sử dụng nút "Tạo QR" bên cạnh mỗi giao dịch để tạo mã QR cho tab này.');
                    }
                });

                // Reset payment info button
                this.paymentElements.resetPaymentInfoBtn.addEventListener('click', () => this.resetPaymentInfo());

                // Event delegation for dynamically generated QR buttons within itemized results
                 this.resultElements.itemizedResultDetails.addEventListener('click', (event) => {
                    const qrButton = event.target.closest('.generate-transaction-qr');
                     if (qrButton) {
                         const amount = parseFloat(qrButton.dataset.amount);
                         const transactionTextElement = qrButton.previousElementSibling; // Get the text span before the button
                         const description = transactionTextElement ? transactionTextElement.textContent.split(':')[0].trim() : 'Thanh toán món'; // Extract 'A transfers to B' part

                         if (!isNaN(amount) && amount > 0) {
                             // Check if payment info is filled *before* generating QR
                              if (!this.paymentElements.accountNo.value || !this.paymentElements.accountName.value || !this.paymentElements.bankSelect.value) {
                                 this.togglePaymentOptions(true); // Show the form if hidden
                                 alert('Vui lòng nhập đầy đủ thông tin ngân hàng người nhận trước khi tạo QR.');
                                 // Scroll to payment options for user convenience
                                 this.paymentElements.paymentOptions.scrollIntoView({ behavior: 'smooth', block: 'center' });

                             } else {
                                 // Generate QR with specific description from transaction line
                                 this.generateVietQR(amount, description, qrButton);
                             }
                         } else {
                             alert('Số tiền không hợp lệ để tạo QR.');
                         }
                     }
                 });

                 // QR Image load/error handlers
                this.paymentElements.qrCodeImage.onerror = () => {
                     console.error("Failed to load VietQR image.");
                     this.paymentElements.qrLoadingText.textContent = 'Lỗi khi tải mã QR. Kiểm tra lại thông tin.';
                     this.paymentElements.qrLoadingText.style.display = 'block';
                     this.paymentElements.qrCodeImage.style.display = 'none';
                     this.currentQrImageUrl = null; // Invalidate current URL
                     this.clearQrActions(); // Remove share/save buttons
                };

                 this.paymentElements.qrCodeImage.onload = () => {
                     this.paymentElements.qrLoadingText.style.display = 'none'; // Hide loading text
                     this.paymentElements.qrCodeImage.style.display = 'block'; // Show image
                     this.addQrActions(); // Add Share/Save buttons
                 };
            }

            initEventListeners() {
                // Tab switching
                Object.entries(this.tabs).forEach(([tabName, tabElement]) => {
                    tabElement.addEventListener('click', () => this.switchTab(tabName));
                });

                // Input listeners with debounce for calculation tabs
                Object.values(this.takeawayInputs).forEach(input => {
                    input.addEventListener('input', this.debounce(() => {
                        this.calculateTakeaway();
                        this.saveData();
                    }, 300));
                });

                Object.values(this.dineInInputs).forEach(input => {
                    input.addEventListener('input', this.debounce(() => {
                        this.calculateDineIn();
                        this.saveData();
                    }, 300));
                });

                // Itemized tab buttons
                this.itemizedElements.addItemBtn.addEventListener('click', () => {
                    this.addNewItem();
                    this.saveData(); // Save after adding item structure
                });
                this.itemizedElements.addPersonBtn.addEventListener('click', () => {
                    this.addNewPerson();
                    this.saveData(); // Save after adding person
                });

                // Top reset button
                this.resetBtn.addEventListener('click', () => this.resetActiveTab());

                // Payment info input listeners (to enable/disable QR button and save)
                [this.paymentElements.bankSelect, this.paymentElements.accountNo, this.paymentElements.accountName].forEach(input => {
                    input.addEventListener('input', this.debounce(() => { // Debounce slightly to avoid rapid state changes
                         this.updateGenerateQRButtonState();
                         this.saveData();
                     }, 200));
                });

                 // Initial state for the main QR button after loading data
                 this.updateGenerateQRButtonState();
            }

             updateGenerateQRButtonState() {
                 const inputsFilled = this.paymentElements.bankSelect.value &&
                                      this.paymentElements.accountNo.value.trim().length > 0 &&
                                      this.paymentElements.accountName.value.trim().length > 0;

                 const isTotalTab = this.activeTab === 'takeaway' || this.activeTab === 'dineIn';
                 const hasValidAmount = this.lastCalculatedAmount > 0;

                 if (isTotalTab) {
                     // Show and enable/disable the main button based on filled inputs and valid amount
                     this.paymentElements.generateBankQR.style.display = ''; // Show button
                     this.paymentElements.generateBankQR.disabled = !(inputsFilled && hasValidAmount);
                     this.paymentElements.generateBankQR.textContent = 'Tạo QR Thanh toán (Tổng)';
                 } else {
                     // Hide the main button on the itemized tab
                     this.paymentElements.generateBankQR.style.display = 'none'; // Hide button
                     this.paymentElements.generateBankQR.disabled = true; // Always disabled when hidden
                     // Optional: Change text when hidden for clarity if needed
                     // this.paymentElements.generateBankQR.textContent = 'Dùng nút "Tạo QR" ở trên';
                 }
             }

            populateBankSelect() {
                const select = this.paymentElements.bankSelect;
                const currentVal = select.value; // Store potentially loaded value
                select.innerHTML = '<option value="" disabled>Chọn ngân hàng</option>'; // Add disabled default option
                // Sort banks alphabetically by shortName for better usability
                banks.sort((a, b) => a.shortName.localeCompare(b.shortName)).forEach(bank => {
                    const option = document.createElement('option');
                    option.value = bank.bin;
                    option.textContent = `${bank.shortName} - ${bank.name}`;
                    select.appendChild(option);
                });
                 // Restore selected value if it existed
                 if (currentVal) {
                     select.value = currentVal;
                 }
                 // Ensure the default "Chọn ngân hàng" is selected if no value/invalid value was loaded
                 if (!select.value) {
                    select.selectedIndex = 0;
                 }
            }

            // --- VietQR Generation Logic (Using Image URL) ---
            generateVietQR(amount, description = 'Thanh toan', triggerButton = null) {
                // Basic amount validation
                if (!amount || amount <= 0 || isNaN(amount)) {
                    alert('Số tiền không hợp lệ để tạo QR.');
                    if (triggerButton) this.toggleLoadingState(false, triggerButton); // Reset button state if applicable
                    return;
                }

                // Ensure payment form is visible if generating QR from itemized list and form is hidden
                // Also useful if user clicks generate on Takeaway/Dine-in before opening payment section
                if (this.paymentElements.paymentOptions.style.display === 'none') {
                    this.togglePaymentOptions(true); // Show the payment form
                }

                // Get and validate bank details from the form
                const bankDetails = {
                    accountNo: this.paymentElements.accountNo.value.trim(),
                    accountName: this.paymentElements.accountName.value.trim().toUpperCase(), // Convert to uppercase as per VietQR recommendation
                    acqId: this.paymentElements.bankSelect.value, // BIN
                     // Clean up description: remove amounts, limit length, ensure fallback
                     addInfo: description.replace(/:.*$/, '').trim().substring(0, 25) || 'Thanh toan'
                };

                 let errors = [];
                if (!bankDetails.acqId) errors.push("Vui lòng chọn ngân hàng.");
                if (!bankDetails.accountNo || !/^\d+$/.test(bankDetails.accountNo)) errors.push("Số tài khoản không hợp lệ (chỉ chứa số).");
                // Basic name validation (exists, reasonable length)
                if (!bankDetails.accountName || bankDetails.accountName.length < 2 || bankDetails.accountName.length > 50) errors.push("Tên tài khoản không hợp lệ (cần nhập, không quá dài).");

                if (errors.length > 0) {
                    alert("Lỗi thông tin thanh toán:\n- " + errors.join("\n- "));
                    this.paymentElements.accountNo.focus(); // Focus first field likely needing correction
                    if (triggerButton) this.toggleLoadingState(false, triggerButton);
                    return;
                }

                // Find the bank's code needed for the image URL
                const selectedBank = banks.find(bank => bank.bin === bankDetails.acqId);
                 if (!selectedBank || !selectedBank.code) {
                    alert('Không tìm thấy thông tin mã ngân hàng (code) hợp lệ cho ngân hàng đã chọn.');
                    if (triggerButton) this.toggleLoadingState(false, triggerButton);
                    return;
                }

                // Prepare parameters for the VietQR Image API
                const bankImgCode = selectedBank.code;
                const template = 'compact2'; // Using a common, clean template
                const encodedAccountName = encodeURIComponent(bankDetails.accountName);
                 const encodedAddInfo = encodeURIComponent(bankDetails.addInfo);
                const integerAmount = Math.round(amount); // API requires integer amount

                // Construct the image URL
                const qrImageUrl = `https://img.vietqr.io/image/${bankImgCode}-${bankDetails.accountNo}-${template}.png?amount=${integerAmount}&addInfo=${encodedAddInfo}&accountName=${encodedAccountName}`;
                this.currentQrImageUrl = qrImageUrl; // Store for potential share/save

                console.log("Generating VietQR Image URL:", qrImageUrl);

                // Update UI: Show loading, then image
                if (triggerButton) this.toggleLoadingState(true, triggerButton); // Show loading state on the button
                this.paymentElements.qrCodeContainer.style.display = 'block'; // Show the QR container
                this.paymentElements.qrLoadingText.textContent = 'Đang tải mã QR...';
                this.paymentElements.qrLoadingText.style.display = 'block'; // Show loading text
                this.paymentElements.qrCodeImage.style.display = 'none'; // Hide old image/placeholder
                this.clearQrActions(); // Remove old Share/Save buttons
                this.paymentElements.qrCodeImage.src = qrImageUrl; // Set the src to trigger load/error handlers
                this.paymentElements.qrAmount.textContent = `${this.formatCurrency(integerAmount)} VND`;
                // Update helper text to show context of the generated QR
                 this.paymentElements.qrInfoText.textContent = `(Mã QR cho ${description}: ${this.formatCurrency(integerAmount)} VND)`;

                // Scroll the QR code into view for better visibility on mobile
                this.paymentElements.qrCodeContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

                 // Note: Loading state on triggerButton is turned off in the image's onload/onerror handlers
            }

            // --- Add Share/Save Buttons under QR Code ---
             addQrActions() {
                this.clearQrActions(); // Ensure no duplicate buttons

                if (!this.currentQrImageUrl || !this.paymentElements.qrCodeContainer) return;

                // Extract amount and description context from the displayed QR info
                 const integerAmount = Math.round(parseFloat(this.paymentElements.qrAmount.textContent.replace(/[^\d]/g, '')) || 0);
                const paymentText = this.paymentElements.qrInfoText.textContent.replace(/^\(|\)$/g, ''); // Get descriptive text, remove parentheses

                // Create container for action buttons
                const qrActionsContainer = document.createElement('div');
                qrActionsContainer.id = 'qrActionsContainer'; // Use ID for easy removal

                // --- Share Button ---
                const shareButton = document.createElement('button');
                shareButton.id = 'shareQrCode';
                shareButton.className = 'btn btn-sm btn-qr-action'; // Use smaller button style
                shareButton.textContent = 'Chia sẻ'; // Shorter text for mobile
                shareButton.title = 'Chia sẻ mã QR này';
                shareButton.addEventListener('click', async () => {
                     if (!this.currentQrImageUrl) { alert('Không có mã QR để chia sẻ.'); return; }
                     this.toggleLoadingState(true, shareButton, 'Chia sẻ'); // Show loading on share button
                     try {
                         // Fetch the QR image as a blob
                         const response = await fetch(this.currentQrImageUrl);
                         if (!response.ok) throw new Error(`Tải ảnh thất bại (${response.status})`);
                         const blob = await response.blob();
                         const file = new File([blob], 'VietQR.png', { type: blob.type });

                         // Use Web Share API if available
                         if (navigator.canShare && navigator.canShare({ files: [file] })) {
                             await navigator.share({ title: 'Mã QR Thanh Toán', text: paymentText, files: [file] });
                         } else if (navigator.share) { // Fallback for text/URL sharing
                             await navigator.share({ title: 'Mã QR Thanh Toán', text: `${paymentText}\nLink ảnh: ${this.currentQrImageUrl}` });
                         } else {
                             alert('Chia sẻ không được hỗ trợ trên trình duyệt/thiết bị này. Bạn có thể thử Lưu QR và gửi ảnh.');
                         }
                     } catch (error) {
                         console.error('Lỗi khi chia sẻ:', error);
                         // Don't alert if user cancelled share dialog (AbortError)
                         if (error.name !== 'AbortError') {
                            alert(`Không thể chia sẻ QR. Lỗi: ${error.message}. Thử lưu và gửi ảnh thủ công.`);
                         }
                     } finally {
                        this.toggleLoadingState(false, shareButton, 'Chia sẻ'); // Hide loading on share button
                     }
                });

                // --- Save Button ---
                const saveButton = document.createElement('button');
                saveButton.id = 'saveQrCode';
                saveButton.className = 'btn btn-sm btn-qr-action'; // Use smaller button style
                saveButton.textContent = 'Lưu QR';
                saveButton.title = 'Tải mã QR này về máy';
                saveButton.addEventListener('click', () => {
                    if (!this.currentQrImageUrl) { alert('Không có mã QR để lưu.'); return; }
                     this.toggleLoadingState(true, saveButton, 'Lưu QR'); // Show loading on save button
                    try {
                        const link = document.createElement('a');
                        link.href = this.currentQrImageUrl;
                        // Create a descriptive filename
                        const bankName = banks.find(b => b.bin === this.paymentElements.bankSelect.value)?.shortName || 'Bank';
                        const accNoLast4 = this.paymentElements.accountNo.value.slice(-4);
                        const filename = `VietQR_${bankName}_${accNoLast4}_${integerAmount}.png`;
                        link.download = filename;

                        // Trigger download
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } catch (error) {
                        console.error('Lỗi khi lưu QR:', error);
                        alert('Không thể tự động lưu QR. Bạn có thể thử nhấn giữ vào ảnh QR và chọn "Lưu ảnh".');
                    } finally {
                         this.toggleLoadingState(false, saveButton, 'Lưu QR'); // Hide loading on save button
                    }
                });

                qrActionsContainer.appendChild(shareButton);
                qrActionsContainer.appendChild(saveButton);

                // Append the actions container below the QR info text within the QR container
                this.paymentElements.qrInfoText.insertAdjacentElement('afterend', qrActionsContainer);
             }

             clearQrActions() {
                 const existingActions = document.getElementById('qrActionsContainer'); // Use global ID defined above
                 if (existingActions) {
                     existingActions.remove();
                 }
             }

            // Helper to toggle loading state on buttons
            toggleLoadingState(isLoading, button, originalText = null) {
                 if (!button) return;

                 // Store original text if entering loading state
                 if (isLoading && !button.dataset.originalText) {
                      button.dataset.originalText = button.textContent;
                 }
                 // Retrieve original text if stored, otherwise guess based on class or default
                 if (!originalText && !isLoading && button.dataset.originalText) {
                     originalText = button.dataset.originalText;
                 } else if (!originalText) {
                     // Basic fallback if original text wasn't stored properly
                     originalText = button.classList.contains('generate-transaction-qr') ? 'Tạo QR' :
                                   (button.id === 'generateBankQR' ? 'Tạo QR Thanh toán (Tổng)' :
                                   (button.id === 'shareQrCode' ? 'Chia sẻ' :
                                   (button.id === 'saveQrCode' ? 'Lưu QR' : '...')));
                 }

                 const loadingText = '...'; // Simple loading indicator

                 button.disabled = isLoading;
                 button.textContent = isLoading ? loadingText : originalText;

                 // Clean up stored text when exiting loading state
                 if (!isLoading) {
                     delete button.dataset.originalText;
                 }
             }
            // --- End VietQR ---

            switchTab(tabName) {
                if (!this.tabs[tabName]) return; // Ignore invalid tab names

                this.activeTab = tabName;

                // Update tab button styles and ARIA attributes
                Object.entries(this.tabs).forEach(([name, element]) => {
                    element.classList.toggle('active', name === tabName);
                    element.setAttribute('aria-selected', name === tabName ? 'true' : 'false');
                });

                // Show/hide corresponding form sections
                Object.entries(this.forms).forEach(([name, element]) => {
                    element.style.display = name === tabName ? 'block' : 'none';
                });

                // Show/hide the itemized-specific payment trigger button
                 this.itemizedElements.itemizedPaymentTrigger.style.display = tabName === 'itemized' ? 'flex' : 'none';

                // Reset calculation results display areas
                this.resultElements.amountToPay.textContent = '';
                this.resultElements.additionalInfo.innerHTML = '';
                this.resultElements.itemizedResultDetails.innerHTML = ''; // Clear specific itemized results
                this.resultElements.progressBar.style.width = '0%';
                this.resultElements.progressText.textContent = '';

                 // Hide QR section when switching tabs (it will regenerate if needed)
                 this.paymentElements.qrCodeContainer.style.display = 'none';
                 this.clearQrActions();
                 this.currentQrImageUrl = null;

                // Recalculate based on the newly active tab's current input values
                if (tabName === 'takeaway') this.calculateTakeaway();
                else if (tabName === 'dineIn') this.calculateDineIn();
                else if (tabName === 'itemized') this.calculateItemized();
                 // Note: calculations also update lastCalculatedAmount

                 // Update the state (visibility/disabled) of the main "Generate QR" button
                 this.updateGenerateQRButtonState();

                 // Save the current state including the active tab
                 this.saveData();
            }

            // --- Calculation Logic ---
            calculateTakeaway() {
                if (this.activeTab !== 'takeaway') return;

                // Get values, default to 0 if invalid/empty, convert 'k' to actual value
                const foodCost = (parseFloat(this.takeawayInputs.foodCost.value) || 0) * 1000;
                const shippingCost = (parseFloat(this.takeawayInputs.shippingCost.value) || 0) * 1000;
                const discount = (parseFloat(this.takeawayInputs.discount.value) || 0) * 1000;
                const numPeople = parseInt(this.takeawayInputs.numPeople.value) || 1; // Default to 1 person if invalid/empty

                 // Validate inputs (optional: add visual error state to inputs)
                 // Basic check: ensure number of people is positive
                 const isValid = numPeople > 0;

                const totalCost = Math.max(0, foodCost + shippingCost - discount); // Ensure total isn't negative
                let amountPerPerson = isValid ? totalCost / numPeople : 0;
                const roundedAmount = this.roundToThousand(amountPerPerson);

                this.lastCalculatedAmount = roundedAmount; // Store for potential QR generation

                // Update result display
                this.resultElements.amountToPay.textContent = this.formatCurrency(roundedAmount) + ' / người';

                // Update progress bar and text
                let progressPercentage = 0;
                const totalBeforeDiscount = foodCost + shippingCost;
                if (totalBeforeDiscount > 0) {
                    // Progress represents the final cost relative to the cost before discount
                    progressPercentage = (totalCost / totalBeforeDiscount) * 100;
                    // Clamp percentage between 0 and 100
                    progressPercentage = Math.max(0, Math.min(progressPercentage, 100));
                }
                this.resultElements.progressBar.style.width = `${progressPercentage}%`;
                this.resultElements.progressText.textContent =
                    `Tổng cộng: ${this.formatCurrency(totalCost)} / ${numPeople} người`;

                // Update additional info (breakdown)
                this.resultElements.additionalInfo.innerHTML =
                    `Chính xác: ${this.formatCurrency(amountPerPerson)}<br>` +
                    `(Ăn ${this.formatCurrency(foodCost)} + Ship ${this.formatCurrency(shippingCost)} - Giảm ${this.formatCurrency(discount)}) / ${numPeople} người`;

                 this.resultElements.itemizedResultDetails.innerHTML = ''; // Ensure itemized area is clear

                 this.updateGenerateQRButtonState(); // Update main QR button availability

                 // Hide QR if amount becomes zero or invalid after calculation
                 if (this.lastCalculatedAmount <= 0) {
                     if (this.paymentElements.qrCodeContainer.style.display !== 'none') {
                         this.paymentElements.qrCodeContainer.style.display = 'none';
                         this.clearQrActions();
                         this.currentQrImageUrl = null;
                     }
                 }
            }

            calculateDineIn() {
                if (this.activeTab !== 'dineIn') return;

                const totalFoodCost = (parseFloat(this.dineInInputs.totalFoodCost.value) || 0) * 1000;
                const notEatenCost = (parseFloat(this.dineInInputs.notEatenCost.value) || 0) * 1000;
                const numDiners = parseInt(this.dineInInputs.numDiners.value) || 1;

                const isValid = numDiners > 0 && totalFoodCost >= notEatenCost;

                const foodCostToSplit = Math.max(0, totalFoodCost - notEatenCost);
                let amountPerPerson = isValid ? foodCostToSplit / numDiners : 0;
                const roundedAmount = this.roundToThousand(amountPerPerson);

                 this.lastCalculatedAmount = roundedAmount; // Store for potential QR generation

                // Update result display
                this.resultElements.amountToPay.textContent = this.formatCurrency(roundedAmount) + ' / người';

                // Update progress bar and text
                let progressPercentage = 0;
                if (totalFoodCost > 0) {
                     // Progress represents the portion of the bill being split commonly
                    progressPercentage = (foodCostToSplit / totalFoodCost) * 100;
                    progressPercentage = Math.max(0, Math.min(progressPercentage, 100));
                }
                this.resultElements.progressBar.style.width = `${progressPercentage}%`;
                this.resultElements.progressText.textContent =
                    `Tiền chung: ${this.formatCurrency(foodCostToSplit)} / ${numDiners} người (Tổng bill ${this.formatCurrency(totalFoodCost)})`;

                // Update additional info (breakdown)
                this.resultElements.additionalInfo.innerHTML =
                    `Chính xác: ${this.formatCurrency(amountPerPerson)}<br>` +
                    `((Tổng ${this.formatCurrency(totalFoodCost)} - Không ăn chung ${this.formatCurrency(notEatenCost)}) / ${numDiners} người)`;

                 this.resultElements.itemizedResultDetails.innerHTML = ''; // Ensure itemized area is clear
                 this.updateGenerateQRButtonState(); // Update main QR button availability

                 // Hide QR if amount becomes zero or invalid
                 if (this.lastCalculatedAmount <= 0) {
                      if (this.paymentElements.qrCodeContainer.style.display !== 'none') {
                         this.paymentElements.qrCodeContainer.style.display = 'none';
                         this.clearQrActions();
                         this.currentQrImageUrl = null;
                      }
                 }
            }

            // --- Itemized Tab Logic ---
            addNewItem() {
                const itemIndex = this.items.length;
                // Initialize with empty strings/arrays
                const newItem = { name: '', price: '', eaters: [], payers: [] };
                this.items.push(newItem);

                 // Create and append the new row element
                const row = document.createElement('tr');
                row.dataset.index = itemIndex; // Store index on the row for later reference
                row.innerHTML = `
                    <td><input type="text" class="item-name" value="" placeholder="Tên món ${itemIndex + 1}"></td>
                    <td><input type="number" class="item-price" value="" min="0" step="any" inputmode="decimal" placeholder="Giá (k)"></td>
                    <td><div class="people-selector eaters-selector" data-index="${itemIndex}">${this.renderPeopleSelector(itemIndex, 'eaters')}</div></td>
                    <td><div class="people-selector payers-selector" data-index="${itemIndex}">${this.renderPeopleSelector(itemIndex, 'payers')}</div></td>
                    <td><button class="delete-btn btn btn-sm" data-index="${itemIndex}" aria-label="Xoá món ${itemIndex + 1}">✕</button></td>
                `;

                this.itemizedElements.itemsTable.appendChild(row);
                this.attachItemEventListeners(row, itemIndex); // Attach listeners to the new row's elements

                 // Focus the name input of the newly added item for quick entry
                 const nameInput = row.querySelector('.item-name');
                 if(nameInput) nameInput.focus();

                this.calculateItemized(); // Recalculate (though likely 0 until price/people are set)
                 // Note: Saving happens in the event listeners for inputs/selections
            }

            // Renders the HTML for person selection tags (eaters or payers) for a specific item
            renderPeopleSelector(itemIndex, type = 'eaters') {
                const item = this.items[itemIndex];
                if (!item) return ''; // Should not happen, but safety check

                // Ensure the target property (eaters/payers) is an array
                const selectedIndices = (type === 'eaters' ? item.eaters : item.payers) || [];
                const validIndices = Array.isArray(selectedIndices) ? selectedIndices : [];

                // Map through the global list of people, creating a tag for each
                return this.people.map((person, personIndex) => {
                    const isSelected = validIndices.includes(personIndex);
                    return `<span class="person-tag ${isSelected ? 'selected' : ''}"
                                  role="button"
                                  tabindex="0"
                                  aria-pressed="${isSelected}"
                                  data-item-index="${itemIndex}"
                                  data-person-index="${personIndex}"
                                  data-type="${type}">${person}</span>`;
                }).join(''); // Join the HTML strings
            }

            // Attaches event listeners (click, keydown) to all person tags within a given container div
             attachSelectorEventListeners(selectorContainer) {
                 selectorContainer.querySelectorAll('.person-tag').forEach(tag => {
                     // Remove potentially old listeners first to prevent duplicates if re-rendering
                     tag.removeEventListener('click', this.handlePersonTagClick);
                     tag.removeEventListener('keydown', this.handlePersonTagKeydown);
                     // Add new listeners, binding `this` correctly
                     tag.addEventListener('click', this.handlePersonTagClick.bind(this));
                     tag.addEventListener('keydown', this.handlePersonTagKeydown.bind(this));
                 });
             }

             // Handles clicks on person tags
             handlePersonTagClick(event) {
                 const tag = event.target.closest('.person-tag');
                 if (!tag) return;
                 // Retrieve data attributes needed to identify the tag's context
                 const itemIndex = parseInt(tag.dataset.itemIndex);
                 const personIndex = parseInt(tag.dataset.personIndex);
                 const type = tag.dataset.type; // 'eaters' or 'payers'

                 if (isNaN(itemIndex) || isNaN(personIndex) || !type) {
                     console.error("Missing or invalid data attributes on person tag:", tag.dataset);
                     return;
                 }
                 // Call the core logic to toggle selection state
                 this.togglePersonSelection(itemIndex, personIndex, type);
             }

             // Handles keyboard interaction (Enter/Space) on person tags for accessibility
             handlePersonTagKeydown(event) {
                 if (event.key === 'Enter' || event.key === ' ') {
                     event.preventDefault(); // Prevent default action (e.g., page scroll on Space)
                     this.handlePersonTagClick(event); // Treat Enter/Space same as a click
                 }
             }

            // Toggles a person's selection status (eater/payer) for a specific item
            togglePersonSelection(itemIndex, personIndex, type = 'eaters') {
                 const item = this.items[itemIndex];
                 if (!item) return; // Safety check

                 // Ensure the target array (eaters/payers) exists and is an array
                 if (type === 'eaters') {
                     item.eaters = Array.isArray(item.eaters) ? item.eaters : [];
                 } else {
                     item.payers = Array.isArray(item.payers) ? item.payers : [];
                 }
                 const targetArray = type === 'eaters' ? item.eaters : item.payers;

                 // Check if the person is already selected
                 const personPosition = targetArray.indexOf(personIndex);

                 if (personPosition === -1) {
                     // Not selected: Add the person's index
                     targetArray.push(personIndex);
                 } else {
                     // Already selected: Remove the person's index
                     targetArray.splice(personPosition, 1);
                 }

                 // --- Efficiently Update Only the Affected Selector UI ---
                 const selectorClass = type === 'eaters' ? '.eaters-selector' : '.payers-selector';
                 // Find the specific row and then the selector div within that row
                 const row = this.itemizedElements.itemsTable.querySelector(`tr[data-index="${itemIndex}"]`);
                 if (row) {
                      const selectorDiv = row.querySelector(selectorClass);
                      if (selectorDiv) {
                         // Re-render only the tags inside this specific selector div
                         selectorDiv.innerHTML = this.renderPeopleSelector(itemIndex, type);
                         // Re-attach listeners to the newly rendered tags within this div
                         this.attachSelectorEventListeners(selectorDiv);
                      } else {
                          console.warn("Could not find selector div", selectorClass, "in row", itemIndex);
                      }
                 } else {
                     console.warn("Could not find row to update selectors for item index:", itemIndex);
                 }

                 // Recalculate balances and save the updated item data
                 this.calculateItemized();
                 this.saveData();
            }

            // Deletes an item from the list and the table
            deleteItem(indexToDelete) {
                 if (indexToDelete < 0 || indexToDelete >= this.items.length) {
                     console.error("Invalid index to delete:", indexToDelete);
                     return; // Index out of bounds
                 }

                 // Remove item from the data array
                 this.items.splice(indexToDelete, 1);

                 // --- Update the UI ---
                 const tableBody = this.itemizedElements.itemsTable; // Reference to tbody
                 const rowToDelete = tableBody.querySelector(`tr[data-index="${indexToDelete}"]`);
                 if (rowToDelete) {
                     rowToDelete.remove(); // Remove the row from the DOM
                 } else {
                      console.warn("Could not find row element to delete for index:", indexToDelete);
                 }

                 // --- Update indices of subsequent rows and their interactive elements ---
                 // Select all remaining rows within the tbody
                 const remainingRows = tableBody.querySelectorAll('tr');
                 remainingRows.forEach((row, newIndex) => {
                     // The `newIndex` is the row's current position (0, 1, 2...)
                     // We only need to potentially update rows whose *original* index was >= the deleted one,
                     // but since we iterate after deletion, `newIndex` is the correct final index.
                     // We just need to update the `data-index` attribute and internal element data attributes.
                     row.dataset.index = newIndex; // Update the row's main index attribute

                     // Update data-item-index on all relevant elements within the row
                     row.querySelectorAll('[data-item-index]').forEach(el => {
                         el.dataset.itemIndex = newIndex;
                         // Special case: Update placeholder text if needed (optional)
                         if (el.classList.contains('item-name') || el.classList.contains('item-price')) {
                             // Example: el.placeholder = `... ${newIndex + 1}`;
                         }
                     });
                     // Update data-index specifically for the delete button within the row
                     const deleteBtn = row.querySelector('.delete-btn');
                     if(deleteBtn) {
                        deleteBtn.dataset.index = newIndex; // Update delete button's index reference
                        deleteBtn.setAttribute('aria-label', `Xoá món ${newIndex + 1}`); // Update accessibility label
                     }
                     // Re-attach listeners for this row, as its index context has changed
                     // (Crucial for selectors and delete button)
                      this.attachItemEventListeners(row, newIndex);
                 });

                 // Recalculate balances and save the modified items array
                 this.calculateItemized();
                 this.saveData();
            }

            addNewPerson() {
                const currentPersonCount = this.people.length;
                const defaultName = `Người ${currentPersonCount + 1}`;
                const personName = prompt('Nhập tên người mới:', defaultName);

                // Validate input: Check if null (cancelled) or empty/whitespace only
                if (!personName || personName.trim() === '') return;

                const trimmedName = personName.trim();

                 // Optional: Check for duplicate names
                 if (this.people.includes(trimmedName)) {
                     alert(`Tên "${trimmedName}" đã tồn tại. Vui lòng chọn tên khác.`);
                     return;
                 }

                // Add the new person to the list
                this.people.push(trimmedName);

                // Refresh the entire itemized table to include the new person in all selectors
                this.refreshItemizedTable();

                // Recalculate balances (as net amounts might change even if items don't)
                this.calculateItemized();

                // Save the updated people list and potentially recalculated item assignments
                this.saveData();
            }

            calculateItemized() {
                 if (this.activeTab !== 'itemized') return;

                 // Reset results display areas first
                 this.lastCalculatedAmount = 0; // Itemized doesn't have a single 'total' amount like other tabs
                 this.resultElements.itemizedResultDetails.innerHTML = '';
                 this.resultElements.amountToPay.textContent = ''; // Title text for results
                 this.resultElements.additionalInfo.innerHTML = ''; // Clear any previous messages
                 this.resultElements.progressBar.style.width = '0%';
                 this.resultElements.progressText.textContent = '';

                 // Always hide the main QR container when recalculating itemized, transaction QR is separate
                 if (this.paymentElements.qrCodeContainer.style.display !== 'none') {
                    this.paymentElements.qrCodeContainer.style.display = 'none';
                    this.clearQrActions();
                    this.currentQrImageUrl = null;
                 }

                 // --- Validation and Early Exit Conditions ---
                 if (this.items.length === 0) {
                      this.resultElements.amountToPay.textContent = 'Chưa có món ăn nào.';
                     this.resultElements.progressText.textContent = 'Thêm món ăn...';
                     return;
                 }

                 // Check if all items have a valid price (either empty string or non-negative number)
                 const allItemsHaveValidPrice = this.items.every(item =>
                     item.price === '' || (!isNaN(parseFloat(item.price)) && parseFloat(item.price) >= 0)
                 );
                 if (!allItemsHaveValidPrice) {
                      this.resultElements.amountToPay.textContent = 'Lỗi giá tiền:';
                      this.resultElements.additionalInfo.innerHTML = 'Một hoặc nhiều món có giá tiền không hợp lệ (không phải số hoặc âm).';
                     this.resultElements.progressText.textContent = 'Lỗi giá tiền';
                      return;
                 }

                 // Check if any item *with a price > 0* is missing a payer
                 const pricedItemsMissingPayers = this.items.some(item => {
                    const price = parseFloat(item.price) || 0;
                    // Ensure payers is an array and check length
                    return price > 0 && (!Array.isArray(item.payers) || item.payers.length === 0);
                 });

                 if (pricedItemsMissingPayers) {
                     this.resultElements.amountToPay.textContent = 'Thiếu thông tin:';
                     this.resultElements.additionalInfo.innerHTML = 'Vui lòng chọn <strong>người trả</strong> cho mỗi món có giá tiền > 0.';
                     this.resultElements.progressText.textContent = 'Thiếu người trả';
                     return; // Stop calculation until payers are assigned
                 }

                 // --- Calculate Costs and Payments per Person ---
                 const personCosts = Array(this.people.length).fill(0);
                 const personPayments = Array(this.people.length).fill(0);
                 let totalBill = 0;

                 this.items.forEach(item => {
                     const itemPrice = (parseFloat(item.price) || 0) * 1000; // Convert 'k' to actual value
                     totalBill += itemPrice; // Accumulate total bill

                     const eaters = Array.isArray(item.eaters) ? item.eaters : [];
                     const payers = Array.isArray(item.payers) ? item.payers : [];

                     // Distribute cost among eaters
                     if (eaters.length > 0 && itemPrice > 0) {
                         const costPerEater = itemPrice / eaters.length;
                         eaters.forEach(personIndex => {
                             // Ensure index is valid before adding cost
                             if (personIndex >= 0 && personIndex < personCosts.length) {
                                 personCosts[personIndex] += costPerEater;
                             } else {
                                 console.warn(`Invalid eater index ${personIndex} found for item "${item.name}"`);
                             }
                         });
                     }

                     // Distribute payment among payers
                     if (payers.length > 0 && itemPrice > 0) {
                         const paymentPerPayer = itemPrice / payers.length;
                         payers.forEach(personIndex => {
                             // Ensure index is valid before adding payment
                             if (personIndex >= 0 && personIndex < personPayments.length) {
                                 personPayments[personIndex] += paymentPerPayer;
                             } else {
                                  console.warn(`Invalid payer index ${personIndex} found for item "${item.name}"`);
                             }
                         });
                     }
                 });

                 const totalPaid = personPayments.reduce((sum, paid) => sum + paid, 0);
                 const tolerance = 1; // Tolerance for floating point comparisons (e.g., 1 VND)

                 // Optional: Warn if total paid doesn't match total bill (usually due to rounding or complex splits)
                  if (Math.abs(totalBill - totalPaid) > tolerance) {
                      console.warn(`Potential discrepancy: Total Bill (${this.formatCurrency(totalBill)}) != Total Paid (${this.formatCurrency(totalPaid)}). Difference: ${this.formatCurrency(totalBill - totalPaid)}.`);
                      // You might want to display a small warning in the UI as well
                      // this.resultElements.additionalInfo.innerHTML += `<br><small style='color:orange;'>Lưu ý: Có thể có chênh lệch nhỏ do làm tròn.</small>`;
                  }

                 // Calculate progress based on how much of the total bill has been assigned as paid
                 const progressPercentage = totalBill > 0 ? Math.min(100, Math.max(0, (totalPaid / totalBill) * 100)) : (this.items.length > 0 ? 100 : 0); // 100% if bill is 0 but items exist, 0% if no items

                 // --- Calculate Net Balances and Transactions ---
                 // Calculate net amount for each person (paid - cost)
                 const netAmounts = personCosts.map((cost, index) => {
                     const paid = personPayments[index];
                     const net = paid - cost; // Positive: owes money back; Negative: needs to pay
                     return { index, cost, paid, net };
                 }).filter(person => Math.abs(person.net) > tolerance); // Only consider people with non-negligible balance

                 // Check if calculation resulted in everyone balanced or if the bill is zero
                 if (netAmounts.length === 0) {
                      if (totalBill <= tolerance && this.items.length > 0) {
                          // Items exist, but total bill is effectively zero
                          this.resultElements.amountToPay.textContent = 'Tổng bill là 0.';
                           this.resultElements.itemizedResultDetails.innerHTML = `<p style="color: var(--text-light);">Không cần giao dịch.</p>`;
                           this.resultElements.progressText.textContent = `Tổng Bill: ${this.formatCurrency(totalBill)} (100%)`;
                           this.resultElements.progressBar.style.width = `100%`;
                      } else if (totalBill > tolerance) {
                          // Bill exists, but everyone's net balance is zero (perfectly balanced payments)
                          this.resultElements.amountToPay.textContent = 'Đã cân bằng!';
                          this.resultElements.itemizedResultDetails.innerHTML = `<p style="color: var(--success-color);">Tất cả mọi người đã trả đủ phần của mình, không cần chuyển khoản thêm.</p>`;
                          this.resultElements.progressText.textContent = `Tổng Bill: ${this.formatCurrency(totalBill)} (${Math.round(progressPercentage)}%)`;
                          this.resultElements.progressBar.style.width = `${progressPercentage}%`;
                      } else {
                          // No items added yet, handled earlier
                           this.resultElements.amountToPay.textContent = 'Chưa có món ăn nào.';
                           this.resultElements.progressText.textContent = 'Thêm món ăn...';
                      }
                      return; // Exit calculation as no transactions needed
                 }

                 // --- Compute Simplified Transactions ---
                 const transactions = this.computeTransactions(netAmounts);

                 // --- Display Transactions ---
                 this.resultElements.amountToPay.textContent = 'Các giao dịch cần thực hiện:';
                 this.resultElements.itemizedResultDetails.innerHTML = ''; // Clear previous transactions

                 if (transactions.length === 0 && netAmounts.length > 0) {
                    // Should not happen if netAmounts > 0, but as a fallback
                    console.warn("Net amounts exist but no transactions generated.");
                     this.resultElements.itemizedResultDetails.innerHTML = `<p style="color: var(--error-color);">Lỗi tính toán cân bằng.</p>`;
                 } else {
                     transactions.forEach(t => {
                         // Round transaction amount to nearest 1000 VND
                         const roundedAmount = this.roundToThousand(t.amount);
                          const formattedAmount = this.formatCurrency(roundedAmount);

                          // Only display transaction if rounded amount is > 0
                          if (roundedAmount <= 0) return;

                         // Create div for each transaction line
                         const transactionDiv = document.createElement('div');
                         transactionDiv.classList.add('transaction-line');
                         // Description for QR code is extracted from this text span
                         transactionDiv.innerHTML = `
                              <span class="transaction-text">${t.from} chuyển ${t.to}: <strong>${formattedAmount} VND</strong></span>
                              <button class="btn btn-sm generate-transaction-qr"
                                      data-amount="${roundedAmount}"
                                      title="Tạo QR cho giao dịch ${t.from} → ${t.to}">Tạo QR</button>
                          `;
                          this.resultElements.itemizedResultDetails.appendChild(transactionDiv);
                      });
                 }

                 // Update overall progress text and bar
                 this.resultElements.progressBar.style.width = `${progressPercentage}%`;
                 this.resultElements.progressText.textContent =
                      `Tổng Bill: ${this.formatCurrency(totalBill)} (${Math.round(progressPercentage)}% thanh toán)`;

                  // Ensure main QR button remains hidden/disabled
                  this.updateGenerateQRButtonState();
            }

            // Algorithm to simplify debts between people
            computeTransactions(netAmounts) {
                 const tolerance = 1; // Use a small tolerance (e.g., 1 VND) to avoid tiny transactions

                 // Separate into debtors (owe money, net < 0) and creditors (are owed money, net > 0)
                 // Make copies to avoid modifying the original array directly during processing
                 let debtors = netAmounts.filter(p => p.net < -tolerance).map(p => ({ ...p })).sort((a, b) => a.net - b.net); // Sort by most negative first
                 let creditors = netAmounts.filter(p => p.net > tolerance).map(p => ({ ...p })).sort((a, b) => b.net - a.net); // Sort by most positive first

                 const transactions = [];
                 let debtorIndex = 0;
                 let creditorIndex = 0;

                 // Loop while there are still debtors and creditors with balances
                 while (debtorIndex < debtors.length && creditorIndex < creditors.length) {
                     const debtor = debtors[debtorIndex];
                     const creditor = creditors[creditorIndex];

                     // Amount to transfer is the minimum of what the debtor owes or the creditor is owed
                     const amountToTransfer = Math.min(-debtor.net, creditor.net);

                     // Only record transaction if the amount is significant
                     if (amountToTransfer > tolerance) {
                         transactions.push({
                             from: this.people[debtor.index], // Get name from original people array
                             to: this.people[creditor.index],   // Get name from original people array
                             amount: amountToTransfer
                         });

                         // Adjust balances of the current debtor and creditor
                         debtor.net += amountToTransfer;
                         creditor.net -= amountToTransfer;
                     }

                     // Move to the next debtor if their balance is now close to zero
                     if (Math.abs(debtor.net) < tolerance) {
                         debtorIndex++;
                     }
                     // Move to the next creditor if their balance is now close to zero
                     if (Math.abs(creditor.net) < tolerance) {
                         creditorIndex++;
                     }
                 }

                 // Log any remaining balances (should be negligible if algorithm worked)
                 // debtors.concat(creditors).forEach(p => {
                 //     if (Math.abs(p.net) > tolerance) {
                 //         console.warn(`Transaction balancing finished with non-zero balance for ${this.people[p.index]}: ${p.net}`);
                 //     }
                 // });

                 return transactions;
            }

            // --- UI Helpers ---
            // Toggles the visibility of the payment options form
             togglePaymentOptions(show) {
                 const paymentDiv = this.paymentElements.paymentOptions;
                 const currentlyShown = paymentDiv.style.display !== 'none';

                 if (show && !currentlyShown) {
                     paymentDiv.style.display = 'block';
                     // Scroll into view smoothly when showing
                     paymentDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 } else if (!show && currentlyShown) {
                     paymentDiv.style.display = 'none';
                 }
                 // If already in the desired state, do nothing.
                 // Note: This doesn't automatically hide the QR code display.
             }

            // Resets the payment information fields
             resetPaymentInfo() {
                 if (confirm('Xác nhận xoá thông tin Ngân hàng, Số tài khoản, Tên tài khoản đã lưu?')) {
                     this.paymentElements.bankSelect.value = ''; // Reset dropdown
                     this.paymentElements.accountNo.value = '';
                     this.paymentElements.accountName.value = '';
                     this.updateGenerateQRButtonState(); // Disable QR button
                     this.saveData(); // Persist the cleared payment info

                     // Hide any existing QR code as the info is now invalid
                     this.paymentElements.qrCodeContainer.style.display = 'none';
                     this.clearQrActions();
                     this.currentQrImageUrl = null;
                 }
             }

            // --- Data Persistence (LocalStorage) ---
            loadSavedData() {
                const savedData = localStorage.getItem('billSplitterData_v2'); // Using a versioned key
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);

                        // Load calculation inputs for Takeaway tab
                        if (data.takeaway) {
                            this.takeawayInputs.foodCost.value = data.takeaway.foodCost || '';
                            this.takeawayInputs.shippingCost.value = data.takeaway.shippingCost || '';
                            this.takeawayInputs.discount.value = data.takeaway.discount || '';
                            this.takeawayInputs.numPeople.value = data.takeaway.numPeople || '';
                        }
                        // Load calculation inputs for Dine-in tab
                        if (data.dineIn) {
                            this.dineInInputs.totalFoodCost.value = data.dineIn.totalFoodCost || '';
                            this.dineInInputs.notEatenCost.value = data.dineIn.notEatenCost || '';
                            this.dineInInputs.numDiners.value = data.dineIn.numDiners || '';
                        }
                        // Load data for Itemized tab
                        if (data.itemized) {
                            // Load people list, ensure it's a valid array, provide default if not
                            this.people = (Array.isArray(data.itemized.people) && data.itemized.people.length > 0)
                                          ? data.itemized.people
                                          : ['Người 1', 'Người 2', 'Người 3']; // Default if saved list is empty/invalid

                            // Load items list, ensure it's an array
                            this.items = Array.isArray(data.itemized.items) ? data.itemized.items : [];

                            // Sanitize loaded items to ensure properties exist and have correct types
                             this.items.forEach(item => {
                                 item.name = typeof item.name === 'string' ? item.name : '';
                                 // Price can be number or string (including empty string)
                                 item.price = (typeof item.price === 'number' || typeof item.price === 'string') ? String(item.price) : '';
                                 item.eaters = Array.isArray(item.eaters) ? item.eaters : [];
                                 item.payers = Array.isArray(item.payers) ? item.payers : [];
                                  // Optional: Filter out invalid indices from eaters/payers if needed
                                  // item.eaters = item.eaters.filter(idx => idx >= 0 && idx < this.people.length);
                                  // item.payers = item.payers.filter(idx => idx >= 0 && idx < this.people.length);
                             });
                            // Render the loaded itemized data into the table UI
                            this.refreshItemizedTable();
                        } else {
                             // If no itemized data saved, initialize with defaults
                             this.people = ['Người 1', 'Người 2', 'Người 3'];
                             this.items = [];
                             this.refreshItemizedTable(); // Ensure table is empty/rendered correctly
                         }

                        // Load saved payment information
                        if(data.payment) {
                             this.paymentElements.bankSelect.value = data.payment.acqId || '';
                             this.paymentElements.accountNo.value = data.payment.accountNo || '';
                             this.paymentElements.accountName.value = data.payment.accountName || '';
                         }

                        // Load last active tab, default to 'takeaway' if invalid/missing
                        this.activeTab = data.activeTab && this.tabs[data.activeTab] ? data.activeTab : 'takeaway';

                    } catch (e) {
                        console.error("Error parsing saved data from localStorage:", e);
                        localStorage.removeItem('billSplitterData_v2'); // Clear corrupted data
                         this.resetState(true); // Reset everything to defaults on error
                    }
                } else {
                     // No saved data found, initialize with defaults
                     this.resetState(true); // Full reset including payment info
                }
                 // Note: Initial UI setup (switchTab, populateBankSelect, updateGenerateQRButtonState)
                 // is called *after* loadSavedData in the constructor.
            }

             // Resets the application state (inputs, items, people), optionally resetting payment info too
             resetState(resetPayment = false) {
                 this.activeTab = 'takeaway'; // Default tab
                 // Reset calculation inputs
                 Object.values(this.takeawayInputs).forEach(input => input.value = '');
                 Object.values(this.dineInInputs).forEach(input => input.value = '');
                 // Reset itemized data
                 this.people = ['Người 1', 'Người 2', 'Người 3']; // Default people
                 this.items = [];
                 this.refreshItemizedTable(); // Clear itemized table UI

                 // Reset payment info if requested
                 if (resetPayment) {
                     this.paymentElements.bankSelect.value = '';
                     this.paymentElements.accountNo.value = '';
                     this.paymentElements.accountName.value = '';
                 }

                 // Clear results and QR display
                 this.lastCalculatedAmount = 0;
                 this.resultElements.amountToPay.textContent = '';
                 this.resultElements.additionalInfo.innerHTML = '';
                 this.resultElements.itemizedResultDetails.innerHTML = '';
                 this.resultElements.progressBar.style.width = '0%';
                 this.resultElements.progressText.textContent = '';
                 this.paymentElements.qrCodeContainer.style.display = 'none';
                 this.clearQrActions();
                 this.currentQrImageUrl = null;

                 // Update button states after reset
                 this.updateGenerateQRButtonState();
             }

             // Saves the current application state to localStorage
             saveData() {
                 const dataToSave = {
                     activeTab: this.activeTab,
                     takeaway: {
                         foodCost: this.takeawayInputs.foodCost.value,
                         shippingCost: this.takeawayInputs.shippingCost.value,
                         discount: this.takeawayInputs.discount.value,
                         numPeople: this.takeawayInputs.numPeople.value
                     },
                     dineIn: {
                         totalFoodCost: this.dineInInputs.totalFoodCost.value,
                         notEatenCost: this.dineInInputs.notEatenCost.value,
                         numDiners: this.dineInInputs.numDiners.value
                     },
                     itemized: {
                         people: this.people,
                         // Save items, ensuring properties are correctly formatted
                         items: this.items.map(item => ({
                             name: item.name || '',
                             price: String(item.price || ''), // Ensure price is saved as string (number or empty)
                             eaters: Array.isArray(item.eaters) ? item.eaters : [],
                             payers: Array.isArray(item.payers) ? item.payers : []
                         }))
                     },
                     payment: {
                         acqId: this.paymentElements.bankSelect.value,
                         accountNo: this.paymentElements.accountNo.value,
                         accountName: this.paymentElements.accountName.value
                     }
                 };
                 try {
                     localStorage.setItem('billSplitterData_v2', JSON.stringify(dataToSave));
                 } catch (e) {
                     console.error("Error saving data to localStorage:", e);
                     // Consider notifying the user if storage fails (e.g., quota exceeded)
                 }
             }

            // Action for the top 'Reset' button (resets only the active tab's calculation data)
            resetActiveTab() {
                 const activeTabName = this.tabs[this.activeTab]?.textContent || 'hiện tại';
                 if (confirm(`Xác nhận xoá dữ liệu tính toán cho tab "${activeTabName}"? Thông tin thanh toán sẽ được giữ lại.`)) {
                    // Clear inputs/data based on the active tab
                    if (this.activeTab === 'takeaway') {
                        Object.values(this.takeawayInputs).forEach(input => input.value = '');
                        this.calculateTakeaway(); // Recalculate (to clear results) & update display
                    } else if (this.activeTab === 'dineIn') {
                        Object.values(this.dineInInputs).forEach(input => input.value = '');
                        this.calculateDineIn(); // Recalculate & update display
                    } else if (this.activeTab === 'itemized') {
                        // Reset people and items for this tab
                        this.people = ['Người 1', 'Người 2', 'Người 3'];
                        this.items = [];
                        this.refreshItemizedTable(); // Clear and re-render table UI
                        this.calculateItemized(); // Recalculate & update display (will show 'no items')
                    }

                    // Persist the cleared calculation data (payment info remains untouched)
                    this.saveData();

                     // Hide QR code display as calculations are reset
                    if (this.paymentElements.qrCodeContainer.style.display !== 'none') {
                       this.paymentElements.qrCodeContainer.style.display = 'none';
                       this.clearQrActions();
                       this.currentQrImageUrl = null;
                    }
                 }
            }

            // Re-renders the entire itemized table based on the current `this.items` and `this.people`
            refreshItemizedTable() {
                const tableBody = this.itemizedElements.itemsTable;
                // Clear current content efficiently
                tableBody.innerHTML = '';

                 // Check if there are items to render
                 if (this.items.length === 0 && this.activeTab === 'itemized') {
                      // Optional: Display a placeholder row if the table is empty
                      // const placeholderRow = document.createElement('tr');
                      // placeholderRow.innerHTML = `<td colspan="5" style="text-align:center; color: var(--text-light); padding: 20px;">Chưa có món nào. Nhấn "+ Thêm món" để bắt đầu.</td>`;
                      // tableBody.appendChild(placeholderRow);
                 } else {
                     // Render each item as a row
                    this.items.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.dataset.index = index; // Set index attribute on the row
                        // Use current item data to populate the row
                        row.innerHTML = `
                            <td><input type="text" class="item-name" value="${item.name || ''}" placeholder="Tên món ${index + 1}"></td>
                            <td><input type="number" class="item-price" value="${item.price || ''}" min="0" step="any" inputmode="decimal" placeholder="Giá (k)"></td>
                            <td><div class="people-selector eaters-selector" data-index="${index}">${this.renderPeopleSelector(index, 'eaters')}</div></td>
                            <td><div class="people-selector payers-selector" data-index="${index}">${this.renderPeopleSelector(index, 'payers')}</div></td>
                            <td><button class="delete-btn btn btn-sm" data-index="${index}" aria-label="Xoá món ${index + 1}">✕</button></td>
                        `;
                        tableBody.appendChild(row);
                        // IMPORTANT: Attach event listeners to the elements within the newly created row
                        this.attachItemEventListeners(row, index);
                    });
                 }
            }

             // Attaches necessary event listeners to the interactive elements within a single item row
             attachItemEventListeners(row, itemIndex) {
                 const nameInput = row.querySelector('.item-name');
                 const priceInput = row.querySelector('.item-price');
                 const deleteBtn = row.querySelector('.delete-btn');
                 const eatersSelectorDiv = row.querySelector('.eaters-selector');
                 const payersSelectorDiv = row.querySelector('.payers-selector');

                 // --- Input Listeners (Name and Price) ---
                 if (nameInput) {
                     // Use 'input' for immediate update, debounced to save data less frequently
                     nameInput.addEventListener('input', this.debounce((e) => {
                         if (this.items[itemIndex]) { // Check item exists
                             this.items[itemIndex].name = e.target.value;
                             this.saveData(); // Save name change
                         } else { console.warn("Item not found at index", itemIndex, "for name input"); }
                     }, 300));
                 }

                 if (priceInput) {
                      // Use 'input', debounced, recalculate on change
                     priceInput.addEventListener('input', this.debounce((e) => {
                         if (this.items[itemIndex]) { // Check item exists
                              // Store price as string from input; calculation will parse it
                             this.items[itemIndex].price = e.target.value;
                             this.calculateItemized(); // Recalculate totals/balances
                             this.saveData(); // Save price change
                         } else { console.warn("Item not found at index", itemIndex, "for price input"); }
                     }, 300));
                 }

                // --- Delete Button Listener ---
                 if (deleteBtn) {
                      // Remove potential old listener first (important if re-attaching)
                      deleteBtn.removeEventListener('click', this.handleDeleteItemClick);
                      // Add new listener, bind `this`
                      deleteBtn.addEventListener('click', this.handleDeleteItemClick.bind(this));
                 } else {
                      console.warn("Delete button not found for row index:", itemIndex);
                 }

                 // --- People Selector Listeners ---
                 // Attach listeners to the tags *inside* the selector divs
                 if (eatersSelectorDiv) {
                     this.attachSelectorEventListeners(eatersSelectorDiv);
                 }
                  if (payersSelectorDiv) {
                     this.attachSelectorEventListeners(payersSelectorDiv);
                 }
             }

             // Bound handler specifically for the delete button click event
             // Ensures `this` refers to the BillSplitter instance
             handleDeleteItemClick(event) {
                 const button = event.target.closest('.delete-btn');
                 // Check if the button exists and has a valid data-index
                 if (button && button.dataset.index != null) {
                    const indexToDelete = parseInt(button.dataset.index);
                     if (!isNaN(indexToDelete)) {
                         // Call the main deleteItem logic
                         this.deleteItem(indexToDelete);
                     } else {
                         console.error("Invalid non-numeric index found on delete button:", button.dataset.index);
                     }
                 } else {
                     console.error("Could not find delete button or its index from click event target:", event.target);
                 }
             }

            // --- Formatting Helpers ---
            // Rounds an amount to the nearest thousand
            roundToThousand(amount) {
                 // Handle non-numeric inputs gracefully
                 const numericAmount = parseFloat(amount);
                 if (isNaN(numericAmount)) return 0;
                 // Round to nearest 1000
                 return Math.round(numericAmount / 1000) * 1000;
            }

            // Formats a number as currency (VND)
            formatCurrency(amount) {
                  const numericAmount = parseFloat(amount);
                 if (isNaN(numericAmount)) return '0';
                 // Use Intl.NumberFormat for locale-aware formatting
                 return new Intl.NumberFormat('vi-VN').format(Math.round(numericAmount));
            }

            // Debounce function to limit the rate at which a function can fire
            debounce(func, wait) {
                let timeout;
                return (...args) => {
                    // Capture the `this` context of where debounce is called (the BillSplitter instance)
                    const context = this;
                    // Clear the previous timeout if it exists
                    clearTimeout(timeout);
                    // Set a new timeout to execute the function after the wait period
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }
        } // End of BillSplitter class

        // --- Initialize the application ---
        document.addEventListener('DOMContentLoaded', () => {
            // Create an instance of the BillSplitter class
            // The constructor handles loading data, setting up UI, and initial calculations
            window.billSplitter = new BillSplitter();
        });
    </script>
</body>
</html>
