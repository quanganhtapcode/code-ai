<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Page Generator</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
            max-width: 700px;
            margin: 40px auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #4285f4;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"],
        input[type="url"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 5px rgba(66, 133, 244, 0.3);
        }
        button {
            background-color: #34a853;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            display: block;
            width: 100%;
            transition: background-color 0.2s ease;
            margin-top: 25px;
        }
        button:hover:not(:disabled) {
            background-color: #2c8e43;
        }
        button:disabled {
             background-color: #cccccc;
             cursor: not-allowed;
        }
        .note {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }
        .session-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .session-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            background-color: #f8f8f8;
        }
        .session-tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
            font-weight: 600;
            color: #4285f4;
        }
        .session-tab.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #eee;
        }
        .session-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background-color: #fff;
        }
        .session-content.active {
            display: block;
        }
        .checkbox-group {
            margin-bottom: 15px;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .radio-option input {
            margin-right: 5px;
        }
        @media (max-width: 600px) {
            body { margin: 20px; padding: 15px; }
            h1 { font-size: 1.5rem; }
            button { padding: 10px 20px; font-size: 1rem; }
            .radio-group { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>

    <h1>Tạo đề - DOF</h1>

    <form id="generator-form">
        <div class="form-group">
            <label for="test-title">Tên bài test:</label>
            <input type="text" id="test-title" name="test-title" placeholder="e.g., LEVEL 2 - Test 1" required>
        </div>
        
        <div class="checkbox-group">
            <label class="checkbox-option">
                <input type="checkbox" id="two-sessions" name="two-sessions"> Generate with two sessions (CFA format)
            </label>
        </div>
        
        <div class="form-group">
            <label>Timer Duration:</label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="timer-duration" value="7920" checked> CFA Level 2 (132 minutes)
                </label>
                <label class="radio-option">
                    <input type="radio" name="timer-duration" value="8100"> CFA Level 1 (135 minutes)
                </label>
                <label class="radio-option">
                    <input type="radio" name="timer-duration" value="custom"> Custom
                    <input type="text" id="custom-minutes" placeholder="Minutes" style="width: 80px; margin-left: 10px;" disabled>
                </label>
            </div>
        </div>
        
        <div class="session-tabs">
            <div class="session-tab active" data-tab="session1">Session 1</div>
            <div class="session-tab disabled" data-tab="session2">Session 2</div>
        </div>
        
        <div class="session-content active" id="session1-content">
            <div class="form-group">
                <label for="doc-link-1">Link Đề Session 1:</label>
                <input type="url" id="doc-link-1" name="doc-link-1" placeholder="Đường link dạng preview" required>
                <p class="note">Example Google Drive: <code>https://drive.google.com/file/d/FILE_ID/preview</code></p>
            </div>
            <div class="form-group">
                <label for="form-link-1">Link Google Form Session 1:</label>
                <input type="url" id="form-link-1" name="form-link-1" placeholder="Đường link dạng viewform" required>
                <p class="note">Example Google Form: <code>https://docs.google.com/forms/d/e/FORM_ID/viewform?usp=pp_url</code></p>
            </div>
        </div>
        
        <div class="session-content" id="session2-content">
            <div class="form-group">
                <label for="doc-link-2">Link Đề Session 2:</label>
                <input type="url" id="doc-link-2" name="doc-link-2" placeholder="Đường link dạng preview">
                <p class="note">Example Google Drive: <code>https://drive.google.com/file/d/FILE_ID/preview</code></p>
            </div>
            <div class="form-group">
                <label for="form-link-2">Link Google Form Session 2:</label>
                <input type="url" id="form-link-2" name="form-link-2" placeholder="Đường link dạng viewform">
                <p class="note">Example Google Form: <code>https://docs.google.com/forms/d/e/FORM_ID/viewform?usp=pp_url</code></p>
            </div>
        </div>
        
        <button type="submit">Generate and Download HTML File</button>
    </form>

    <script>
        // Tab switching functionality
        document.querySelectorAll('.session-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Only allow switching if the tab is not disabled
                if (tab.classList.contains('disabled')) {
                    return; 
                }
                
                // Remove active class from all tabs and content
                document.querySelectorAll('.session-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.session-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
            });
        });
        
        // Two sessions checkbox handler
        document.getElementById('two-sessions').addEventListener('change', function() {
            const session2Tab = document.querySelector('.session-tab[data-tab="session2"]');
            const session2Content = document.getElementById('session2-content'); // Get content div too
            const docLink2 = document.getElementById('doc-link-2');
            const formLink2 = document.getElementById('form-link-2');
            
            if (this.checked) {
                session2Tab.classList.remove('disabled'); // Enable the tab
                docLink2.required = true;
                formLink2.required = true;
            } else {
                session2Tab.classList.add('disabled'); // Disable the tab
                docLink2.required = false;
                formLink2.required = false;
                
                // If on session 2 tab when unchecked, switch back to session 1
                if (session2Tab.classList.contains('active')) {
                    document.querySelector('.session-tab[data-tab="session1"]').click();
                }
                // Ensure Session 2 content is not active if unchecked
                session2Content.classList.remove('active'); 
            }
        });
        
        // Initial state setup based on checkbox
        function initializeSession2TabState() {
             document.getElementById('two-sessions').dispatchEvent(new Event('change'));
        }
        initializeSession2TabState(); // Call on load
        
        // Custom timer handler
        document.querySelectorAll('input[name="timer-duration"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const customInput = document.getElementById('custom-minutes');
                customInput.disabled = this.value !== 'custom';
                if (this.value === 'custom') {
                    customInput.focus();
                }
            });
        });

        document.getElementById('generator-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const testTitle = document.getElementById('test-title').value.trim();
            const docLink1 = document.getElementById('doc-link-1').value.trim();
            const formLink1 = document.getElementById('form-link-1').value.trim();
            const hasTwoSessions = document.getElementById('two-sessions').checked;
            
            // Validate inputs
            if (!testTitle || !docLink1 || !formLink1) {
                alert("Please fill in all required fields for Session 1.");
                return;
            }
            
            // Get timer duration
            let timerDuration = 7920; // Default 2h12m in seconds
            const selectedDuration = document.querySelector('input[name="timer-duration"]:checked').value;
            if (selectedDuration === 'custom') {
                const customMinutes = document.getElementById('custom-minutes').value;
                if (customMinutes && !isNaN(customMinutes)) {
                    timerDuration = parseInt(customMinutes) * 60;
                } else {
                    alert("Please enter a valid number for custom minutes.");
                    return;
                }
            } else {
                timerDuration = parseInt(selectedDuration);
            }
            
            // Check session 2 if needed
            let docLink2 = '';
            let formLink2 = '';
            if (hasTwoSessions) {
                docLink2 = document.getElementById('doc-link-2').value.trim();
                formLink2 = document.getElementById('form-link-2').value.trim();
                if (!docLink2 || !formLink2) {
                    alert("Please fill in all required fields for Session 2.");
                    return;
                }
            }
            
            const filename = sanitizeFilename(`${testTitle}.html`);
            const generatedHtml = createTestHtml(testTitle, docLink1, formLink1, hasTwoSessions, docLink2, formLink2, timerDuration);
            downloadFile(generatedHtml, filename, 'text/html');
        });

        function sanitizeFilename(input) {
            return input.replace(/[\\/:*?"<>|#%&{}]/g, '_').replace(/\s+/g, '_');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function createTestHtml(title, documentUrl1, formUrl1, hasTwoSessions, documentUrl2, formUrl2, timerDurationSeconds) {
            // Structure for Session 2 content (only if hasTwoSessions is true)
            const session2Html = hasTwoSessions ? `
        <!-- Session 2 Container (Initially Hidden) -->
        <div id="session-2-container" class="session-container" style="display: none;">
             <div class="panel document-panel" id="document-panel-2"> 
                 <div class="panel-header">Đề (Session 2)</div> 
                 <div class="panel-content"> 
                     <iframe class="responsive-iframe" id="doc-frame-2" src="${documentUrl2}" allowfullscreen title="Đề Session 2"></iframe> 
                 </div> 
             </div>
             <div class="slicer" id="slicer-2"></div>
             <div class="panel form-panel" id="form-panel-2"> 
                 <div class="panel-header">Google Forms (Session 2)</div> 
                 <div class="panel-content"> 
                     <iframe class="responsive-iframe" id="form-frame-2" src="${formUrl2}" title="Google Forms Session 2"></iframe> 
                 </div> 
             </div>
        </div>` : '';

            return `
<!DOCTYPE html>
<html lang="vi">
<head>
    <title>${title}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-primary: #f8f9fa; 
            --bg-secondary: #ffffff; 
            --text-primary: #212529; 
            --text-secondary: #495057; 
            --accent-color: #4285f4; 
            --secondary-accent: #34a853; 
            --border-color: #dee2e6; 
            --shadow-color: rgba(0, 0, 0, 0.15); 
            --transition-speed: 0.3s; 
            --timer-bg: #e9ecef; 
            --timer-text: #495057; 
            --timer-button-bg: #28a745; 
            --timer-button-pause-bg: #ffc107; 
            --timer-button-text: white; 
            --timer-restart-button-bg: #6c757d; 
            --timer-restart-button-hover-bg: #5a6268; 
            --timer-restart-button-text: white;
            --timer-warning-color: #ff9800;
            --timer-warning-bg: #ff6d00;
            --timer-warning-text: white;
            --cta-button-bg: #4285f4;
            --cta-button-hover-bg: #3367d6;
            --cta-button-text: white;
            --modal-overlay-bg: rgba(0, 0, 0, 0.5);
        }
        [data-theme="dark"] {
            --bg-primary: #121212; 
            --bg-secondary: #1e1e1e; 
            --text-primary: #e0e0e0; 
            --text-secondary: #b0b0b0; 
            --accent-color: #8ab4f8; 
            --secondary-accent: #81c995; 
            --border-color: #333333; 
            --shadow-color: rgba(0, 0, 0, 0.3); 
            --timer-bg: #343a40; 
            --timer-text: #e0e0e0; 
            --timer-button-bg: #81c995; 
            --timer-button-pause-bg: #fdd835; 
            --timer-button-text: #121212; 
            --timer-restart-button-bg: #5a6268; 
            --timer-restart-button-hover-bg: #495057; 
            --timer-restart-button-text: #e0e0e0;
            --timer-warning-color: #ffb74d;
            --timer-warning-bg: #e65100;
            --timer-warning-text: white;
            --cta-button-bg: #8ab4f8;
            --cta-button-hover-bg: #669df6;
            --cta-button-text: #121212;
            --modal-overlay-bg: rgba(0, 0, 0, 0.75);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        body { font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background-color: var(--bg-primary); color: var(--text-primary); min-height: 100vh; display: flex; flex-direction: column; line-height: 1.6; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        header { padding: 10px 20px; background-color: var(--bg-secondary); box-shadow: 0 2px 10px var(--shadow-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap: 10px; }
        .header-left { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; } /* Allow wrap within left section too */
        .title { font-size: 1.4rem; font-weight: 600; color: var(--accent-color); margin: 0; }
        .session-indicator {
            background-color: var(--timer-bg);
            color: var(--timer-text);
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .timer-container { display: flex; align-items: center; gap: 8px; background-color: var(--timer-bg); padding: 5px 10px; border-radius: 6px; flex-wrap: wrap; } /* Added wrap */
        #timer-display { font-size: 1.2rem; font-weight: bold; color: var(--timer-text); font-family: 'Courier New', Courier, monospace; white-space: nowrap; } /* Prevent wrap */
        #timer-control-button, #timer-restart-button { padding: 6px 12px; font-size: 0.9rem; border: none; border-radius: 4px; color: var(--timer-button-text); cursor: pointer; transition: background-color 0.2s ease; }
        #timer-control-button { background-color: var(--timer-button-bg); }
        #timer-control-button.paused { background-color: var(--timer-button-pause-bg); color: #333; }
        #timer-control-button:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.7; }
        #timer-restart-button { background-color: var(--timer-restart-button-bg); color: var(--timer-restart-button-text); }
        #timer-restart-button:hover { background-color: var(--timer-restart-button-hover-bg); }
        .controls { display: flex; gap: 12px; align-items: center; }
        .theme-toggle, .fullscreen-toggle { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; transition: all 0.2s ease; user-select: none; }
        .theme-toggle:hover, .fullscreen-toggle:hover { background-color: var(--accent-color); color: white; }
        
        /* Account Switcher Styles */
        .account-switcher {
            position: relative;
            display: inline-block;
        }
        .account-toggle {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            user-select: none;
        }
        .account-toggle:hover {
            background-color: var(--accent-color);
            color: white;
        }
        .account-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 200px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 4px 12px var(--shadow-color);
            z-index: 1000;
            display: none;
            margin-top: 5px;
            overflow: hidden;
        }
        .account-dropdown.show {
            display: block;
            animation: fadeIn 0.2s ease-in;
        }
        .account-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .account-option:hover {
            background-color: var(--accent-color);
            color: white;
        }
        .account-option.active {
            background-color: rgba(66, 133, 244, 0.1);
            font-weight: 500;
        }
        
        .container { flex: 1; padding: 20px; display: flex; flex-direction: column; min-height: 0; overflow: hidden; position: relative; }
        .session-container { 
            flex: 1; 
            padding: 0; 
            display: flex; 
            flex-direction: row; 
            gap: 10px; 
            min-height: 0; 
            overflow: hidden;
            width: 100%; 
        }
        .panel { background-color: var(--bg-secondary); border-radius: 10px; box-shadow: 0 4px 12px var(--shadow-color); overflow: hidden; display: flex; flex-direction: column; flex-basis: 0; min-width: 0; }
        .document-panel { flex-grow: 3; }
        .form-panel { flex-grow: 2; }
        .panel-header { padding: 14px 18px; background-color: var(--accent-color); color: white; font-weight: 500; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .panel-content { flex: 1; position: relative; overflow: hidden; }
        .responsive-iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        .slicer { width: 8px; background-color: var(--border-color); cursor: col-resize; position: relative; z-index: 10; transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease; flex-shrink: 0; }
        .slicer:hover { background-color: var(--accent-color); transform: scaleX(1.5); }
        .slicer.active { background-color: var(--accent-color); transform: scaleX(1.5); box-shadow: 0 0 8px var(--accent-color); }
        .footer { 
            text-align: center; 
            padding: 12px; 
            background-color: var(--bg-secondary); 
            color: var(--secondary-accent); 
            font-weight: 500; 
            font-style: italic; 
            box-shadow: 0 -2px 10px var(--shadow-color); 
            flex-shrink: 0; 
            position: relative;
        }
        
        /* Session Navigation Button */
        .session-nav-button {
            position: absolute;
            right: 20px;
            bottom: 14px;
            background-color: var(--cta-button-bg);
            color: var(--cta-button-text);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .session-nav-button:hover {
            background-color: var(--cta-button-hover-bg);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--modal-overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-container {
            background-color: var(--bg-secondary);
            border-radius: 10px;
            width: 90%;
            max-width: 550px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }
        .modal-header {
            margin-bottom: 15px;
        }
        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--accent-color);
        }
        .modal-body {
            margin-bottom: 20px;
            color: var(--text-secondary);
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal-button {
            padding: 10px 18px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
        }
        .modal-button-secondary {
            background-color: var(--timer-restart-button-bg);
            color: white;
        }
        .modal-button-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .break-timer-container {
            text-align: center;
            margin: 20px 0;
        }
        .break-timer {
            font-size: 2.5rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: var(--accent-color);
            margin: 15px 0;
        }
        
        .time-warning-notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--timer-warning-bg);
            color: var(--timer-warning-text);
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideDown 0.5s ease, fadeIn 0.5s ease;
            font-weight: bold;
        }

        .time-warning-notification.fade-out {
            animation: fadeOut 1s ease;
        }

        @keyframes slideDown {
            from { top: -100px; }
            to { top: 80px; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @media (max-width: 1100px) { 
            .session-container { 
                flex-direction: column; 
                gap: 20px; 
                overflow: auto;
            } 
            .session-container .slicer { display: none; } 
            .session-container .panel { 
                min-height: 400px; 
                flex-grow: 1; 
                flex-basis: auto; 
                min-width: unset; 
            } 
            .session-container .document-panel, 
            .session-container .form-panel { 
                flex: 1; 
            } 
        }
        
        @media (max-width: 768px) { 
            header { flex-direction: column; gap: 10px; align-items: stretch; } 
            .header-left { justify-content: space-between; width: 100%; } 
            .controls { justify-content: space-between; width: 100%;} 
            .container { padding: 10px; } 
            .panel { min-height: 350px; } 
            .account-dropdown { right: auto; left: 0; }
            .session-nav-button { position: static; margin-top: 10px; width: 100%; justify-content: center; }
        }
        
        @media (max-width: 480px) { 
            .theme-toggle, .fullscreen-toggle, .account-toggle { padding: 6px 8px; font-size: 0.8rem; } 
            .title { font-size: 1.2rem; } 
            #timer-display { font-size: 1rem;}
            #timer-control-button, #timer-restart-button { padding: 5px 10px; font-size: 0.8rem;} 
            .timer-container { gap: 5px; } 
        }
        
        @media print { 
            body { user-select: auto; -webkit-user-select: auto; -moz-user-select: auto; -ms-user-select: auto; } 
            .controls, .slicer, .panel-header, .footer, .timer-container button, .session-nav-button, .session-indicator { display: none; } 
            #timer-display { display: none; }
            .container { display: block; overflow: visible; } 
            .session-container { display: block !important; overflow: visible; }
            #session-2-container { display: block !important; margin-top: 40px; }
            .panel { page-break-inside: avoid; box-shadow: none; margin-bottom: 20px; border: 1px solid var(--border-color); min-height: unset; } 
            .panel-content { height: auto; position: static; } 
            .responsive-iframe { position: static; width: 100%; height: 500px; } 
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <h1 class="title">${title}</h1>
            <div class="session-indicator" id="session-indicator">Session 1</div>
            <div class="timer-container">
                <span id="timer-display">${formatTime(timerDurationSeconds)}</span>
                <button id="timer-control-button">Start Timer</button>
                <button id="timer-restart-button">Restart</button>
            </div>
        </div>
        <div class="controls">
            <div class="account-switcher">
                <button class="account-toggle" title="Switch Google Account">
                    <span id="account-icon">👤</span> Account
                </button>
                <div class="account-dropdown">
                    <div class="account-option" data-account="0">Default Account</div>
                    <div class="account-option" data-account="1">Account 1</div>
                    <div class="account-option" data-account="2">Account 2</div>
                    <div class="account-option" data-account="3">Account 3</div>
                    <div class="account-option" data-account="4">Account 4</div>
                </div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Switch theme (Alt+T)">
                <span id="theme-icon">🌙</span> Theme
            </button>
            <button class="fullscreen-toggle" onclick="toggleFullscreen()" title="Fullscreen (Alt+F)">
                <span id="fullscreen-icon">⛶</span> Fullscreen
            </button>
        </div>
    </header>

    <div class="container" id="main-container"> 
        <!-- Session 1 Container -->
        <div id="session-1-container" class="session-container">
             <div class="panel document-panel" id="document-panel-1"> 
                 <div class="panel-header">Đề (Session 1)</div> 
                 <div class="panel-content"> 
                     <iframe class="responsive-iframe" id="doc-frame-1" src="${documentUrl1}" allowfullscreen title="Đề Session 1"></iframe> 
                 </div> 
             </div>
             <div class="slicer" id="slicer-1"></div>
             <div class="panel form-panel" id="form-panel-1"> 
                 <div class="panel-header">Google Forms (Session 1)</div> 
                 <div class="panel-content"> 
                     <iframe class="responsive-iframe" id="form-frame-1" src="${formUrl1}" title="Google Forms Session 1"></iframe> 
                 </div> 
             </div>
        </div>

        ${session2Html}
    
    </div>

    <footer class="footer">
        <div>From Dawn of Finance with love</div>
        ${hasTwoSessions ? '<button id="next-session-btn" class="session-nav-button">Next Session <span>→</span></button>' : ''}
    </footer>

    <!-- Session Confirmation Modal -->
    <div class="modal-overlay" id="session-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Session Completion</h3>
            </div>
            <div class="modal-body">
                <p>Have you completed Session 1 and are ready to move to Session 2?</p>
                <p>Once you proceed to Session 2, you cannot come back to Session 1.</p>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="modal-cancel">Cancel</button>
                <button class="modal-button modal-button-primary" id="modal-confirm">Yes, proceed to Session 2</button>
            </div>
        </div>
    </div>

    <!-- Break Timer Modal -->
    <div class="modal-overlay" id="break-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Break Time</h3>
            </div>
            <div class="modal-body">
                <p>You have a 30-minute break before Session 2 begins.</p>
                <div class="break-timer-container">
                    <div class="break-timer" id="break-timer">30:00</div>
                    <p>Session 2 will start automatically when the break ends.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-primary" id="skip-break-btn">Skip Break & Start Session 2 Now</button>
            </div>
        </div>
    </div>

    <script>
        // === Global Variables ===
        const initialTimeInSeconds = ${timerDurationSeconds}; 
        let timerInterval = null;
        let timeLeftInSeconds = initialTimeInSeconds;
        let isTimerPaused = true;
        let timerEnded = false;
        let warningShown = false;
        let currentSession = 1;
        let breakInterval = null;
        let breakTimeLeft = 30 * 60; // 30 minutes
        const hasTwoSessions = ${hasTwoSessions};

        // --- DOM Elements ---
        let timerDisplayElement;
        let timerControlButton;
        let timerRestartButton;
        let sessionIndicator;
        let nextSessionBtn;
        let sessionModal;
        let breakModal;
        let breakTimerDisplay;
        let skipBreakBtn;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            timerDisplayElement = document.getElementById('timer-display');
            timerControlButton = document.getElementById('timer-control-button');
            timerRestartButton = document.getElementById('timer-restart-button');
            sessionIndicator = document.getElementById('session-indicator');
            sessionModal = document.getElementById('session-modal');
            breakModal = document.getElementById('break-modal');
            breakTimerDisplay = document.getElementById('break-timer');
            skipBreakBtn = document.getElementById('skip-break-btn');
           
            if (hasTwoSessions) {
                 nextSessionBtn = document.getElementById('next-session-btn');
                 nextSessionBtn.addEventListener('click', showSessionConfirmation);
                 document.getElementById('modal-cancel').addEventListener('click', closeSessionModal);
                 document.getElementById('modal-confirm').addEventListener('click', confirmSessionSwitch);
                 skipBreakBtn.addEventListener('click', skipBreak);
            }

            // Theme setup
            const savedTheme = localStorage.getItem('preferred-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

            // Slicer setup for both sessions
            setupSlicer('slicer-1', 'document-panel-1', 'form-panel-1', 'session-1-container');
            if (hasTwoSessions) {
                setupSlicer('slicer-2', 'document-panel-2', 'form-panel-2', 'session-2-container');
            }

            // Timer Setup
            initializeTimerDisplay();
            timerControlButton.addEventListener('click', handleTimerControlClick);
            timerRestartButton.addEventListener('click', restartTimer);
            
            // Initialize Account Switcher
            initAccountSwitcher();
        });

        // --- Session Navigation Functions ---
        function showSessionConfirmation() {
            if (!isTimerPaused) { pauseTimer(); }
            sessionModal.classList.add('active');
        }
        
        function closeSessionModal() { 
            sessionModal.classList.remove('active'); 
        }
        
        function confirmSessionSwitch() {
            closeSessionModal();
            startBreakTimer();
        }
        
        function startBreakTimer() {
            breakModal.classList.add('active');
            updateBreakTimerDisplay();
            
            breakInterval = setInterval(() => {
                breakTimeLeft--;
                updateBreakTimerDisplay();
                
                if (breakTimeLeft <= 0) {
                    clearInterval(breakInterval);
                    switchToSession2();
                }
            }, 1000);
        }
        
        function updateBreakTimerDisplay() {
            const minutes = Math.floor(breakTimeLeft / 60);
            const seconds = breakTimeLeft % 60;
            breakTimerDisplay.textContent = \`\${String(minutes).padStart(2, '0')}:\${String(seconds).padStart(2, '0')}\`;
        }
        
        function skipBreak() {
            clearInterval(breakInterval);
            breakModal.classList.remove('active');
            switchToSession2();
        }
        
        function switchToSession2() {
            currentSession = 2;
            sessionIndicator.textContent = "Session 2";
            
            // Hide Session 1 container, Show Session 2 container
            document.getElementById('session-1-container').style.display = 'none';
            document.getElementById('session-2-container').style.display = 'flex';

            // Hide next session button
            if (nextSessionBtn) nextSessionBtn.style.display = 'none';
            
            // Reset timer for session 2
            resetTimerForNewSession();
            
            // Close break modal if still open
            breakModal.classList.remove('active');
        }
        
        function resetTimerForNewSession() {
            // Stop the current timer
            stopTimer(false);
            
            // Reset timer state
            timeLeftInSeconds = initialTimeInSeconds;
            isTimerPaused = true;
            timerEnded = false;
            warningShown = false;
            
            // Update the display
            initializeTimerDisplay();
        }

        // --- Theme Toggle ---
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('preferred-theme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        function updateThemeIcon(theme) {
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
        }

        // --- Fullscreen ---
        function toggleFullscreen() {
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            try {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().then(() => {
                        if (fullscreenIcon) fullscreenIcon.textContent = '✕';
                    });
                } else if (document.exitFullscreen) {
                    document.exitFullscreen().then(() => {
                        if (fullscreenIcon) fullscreenIcon.textContent = '⛶';
                    });
                }
            } catch(e) {
                console.error(\`Fullscreen error: \${e.message}\`);
                if (fullscreenIcon) fullscreenIcon.textContent = document.fullscreenElement ? '✕' : '⛶';
            }
        }
        
        document.addEventListener('fullscreenchange', () => {
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            if (fullscreenIcon) fullscreenIcon.textContent = document.fullscreenElement ? '✕' : '⛶';
        });

        // --- Slicer Functionality ---
        function setupSlicer(slicerId, docPanelId, formPanelId, containerId) {
            const slicer = document.getElementById(slicerId);
            const docPanel = document.getElementById(docPanelId);
            const formPanel = document.getElementById(formPanelId);
            const container = document.getElementById(containerId);
            
            if (!slicer || !docPanel || !formPanel || !container) return;
            
            let isDraggingSlicer = false;
            let xPosSlicer = 0;
            let animationFrameIdSlicer = null;

            function updatePanelsSlicer() {
                 if (!isDraggingSlicer) return;
                
                 const containerRect = container.getBoundingClientRect();
                 if (containerRect.width <= 0) {
                     cancelAnimationFrame(animationFrameIdSlicer);
                     return;
                 }
                
                 const slicerWidth = slicer.offsetWidth;
                 const minWidth = 150;
                 
                 let slicerLeft = xPosSlicer - containerRect.left;
                 const minSlicerLeft = minWidth;
                 const maxSlicerLeft = containerRect.width - minWidth - slicerWidth;
                 
                 slicerLeft = Math.max(minSlicerLeft, Math.min(slicerLeft, maxSlicerLeft));
                 
                 const availableWidth = containerRect.width - slicerWidth;
                 
                 if (availableWidth > 0) {
                     const docWidth = slicerLeft;
                     const formWidth = availableWidth - docWidth;
                     
                     const totalFlexGrow = parseFloat(docPanel.style.flexGrow || 3) + parseFloat(formPanel.style.flexGrow || 2);
                     docPanel.style.flexGrow = (docWidth / availableWidth) * totalFlexGrow;
                     formPanel.style.flexGrow = (formWidth / availableWidth) * totalFlexGrow;
                     docPanel.style.flexBasis = '0';
                     formPanel.style.flexBasis = '0';
                 }
                 
                 animationFrameIdSlicer = requestAnimationFrame(updatePanelsSlicer);
            }
            
            slicer.addEventListener('mousedown', (e) => {
                if (window.getComputedStyle(container).display === 'none') return;
                
                isDraggingSlicer = true;
                xPosSlicer = e.clientX;
                slicer.classList.add('active');
                document.body.style.cursor = 'col-resize';
                disableIframePointerEvents(true);
                cancelAnimationFrame(animationFrameIdSlicer);
                animationFrameIdSlicer = requestAnimationFrame(updatePanelsSlicer);
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDraggingSlicer) xPosSlicer = e.clientX;
            }, { passive: true });
            
            document.addEventListener('mouseup', () => {
                if (isDraggingSlicer) {
                    isDraggingSlicer = false;
                    slicer.classList.remove('active');
                    document.body.style.cursor = '';
                    disableIframePointerEvents(false);
                    cancelAnimationFrame(animationFrameIdSlicer);
                }
            });
            
            document.addEventListener('mouseleave', () => {
                 if (isDraggingSlicer) {
                    isDraggingSlicer = false;
                    slicer.classList.remove('active');
                    document.body.style.cursor = '';
                    disableIframePointerEvents(false);
                    cancelAnimationFrame(animationFrameIdSlicer);
                 }
            });
        }

        function disableIframePointerEvents(disable) {
            document.querySelectorAll('.responsive-iframe').forEach(frame => {
                frame.style.pointerEvents = disable ? 'none' : 'auto';
            });
        }

        // --- Window Resize ---
        window.addEventListener('resize', function() {
            const slicer1 = document.getElementById('slicer-1');
            const slicer2 = document.getElementById('slicer-2');
            
            [slicer1, slicer2].forEach(slicer => {
                if (slicer) {
                    const display = window.getComputedStyle(slicer).display;
                    if (display === 'none') {
                        // Ensure any active drag is cancelled when slicer hides (e.g. in responsive layout)
                        slicer.classList.remove('active');
                        document.body.style.cursor = '';
                        disableIframePointerEvents(false);
                    }
                }
            });
        });

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', function(event) {
            if (event.altKey) {
                switch (event.key.toLowerCase()) {
                    case 't':
                        event.preventDefault();
                        toggleTheme();
                        break;
                    case 'f':
                        event.preventDefault();
                        toggleFullscreen();
                        break;
                }
            }
        });

        // --- Timer Functions ---
        function formatTime(totalSeconds) {
            if (totalSeconds < 0) totalSeconds = 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return \`\${String(hours).padStart(2, '0')}:\${String(minutes).padStart(2, '0')}:\${String(seconds).padStart(2, '0')}\`;
        }

        function initializeTimerDisplay() {
            if (timerDisplayElement) {
                timerDisplayElement.textContent = formatTime(timeLeftInSeconds);
                timerDisplayElement.style.color = 'var(--timer-text)';
            }
            if (timerControlButton) {
                timerControlButton.textContent = 'Start Timer';
                timerControlButton.classList.remove('paused');
                timerControlButton.disabled = false;
                
                if (timerDisplayElement && timerDisplayElement.textContent === "Time's Up!") {
                    timerDisplayElement.textContent = formatTime(timeLeftInSeconds);
                }
            }
        }

        function updateTimerDisplay() {
            if (timerDisplayElement) {
                timerDisplayElement.textContent = formatTime(timeLeftInSeconds);
            }
        }
        
        function showWarningNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'time-warning-notification';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 1000);
            }, 5000);
        }

        function startTimer() {
            if (timerEnded || timerInterval !== null) return;
            isTimerPaused = false;
            if (timerControlButton) {
                timerControlButton.textContent = 'Pause';
                timerControlButton.classList.remove('paused');
            }
            timerInterval = setInterval(() => {
                timeLeftInSeconds--;
                updateTimerDisplay();
                
                // 15-minute warning
                if (timeLeftInSeconds === 900 && !warningShown) {
                    if (timerDisplayElement) {
                        timerDisplayElement.style.color = 'var(--timer-warning-color)';
                    }
                    
                    showWarningNotification("⚠️ Caution: 15 minutes remaining!");
                    warningShown = true;
                }
                
                if (timeLeftInSeconds <= 0) {
                    stopTimer(true);
                    alert("Time's up!");
                }
            }, 1000);
        }

        function pauseTimer() {
            if (isTimerPaused || timerEnded || timerInterval === null) return;
            isTimerPaused = true;
            clearInterval(timerInterval);
            timerInterval = null;
            if (timerControlButton) {
                timerControlButton.textContent = 'Resume';
                timerControlButton.classList.add('paused');
            }
        }

        function stopTimer(finished = false) {
            clearInterval(timerInterval);
            timerInterval = null;
            isTimerPaused = true;
            if (finished) {
                timerEnded = true;
                timeLeftInSeconds = 0;
                updateTimerDisplay();
                if (timerDisplayElement) {
                    timerDisplayElement.textContent = "Time's Up!";
                }
                if (timerControlButton) {
                    timerControlButton.textContent = 'Finished';
                    timerControlButton.disabled = true;
                    timerControlButton.classList.remove('paused');
                }
            }
        }

        function handleTimerControlClick() {
            if (timerEnded) return;
            if (isTimerPaused) {
                startTimer();
            } else {
                pauseTimer();
            }
        }

        function restartTimer() {
            stopTimer(false);

            timeLeftInSeconds = initialTimeInSeconds;
            isTimerPaused = true;
            timerEnded = false;
            warningShown = false;

            initializeTimerDisplay();
        }
        
        // --- Account Switching Functionality ---
        function initAccountSwitcher() {
            let currentAccount = 0;
            const accountToggle = document.querySelector('.account-toggle');
            const accountDropdown = document.querySelector('.account-dropdown');
            const accountOptions = document.querySelectorAll('.account-option');

            if (!accountToggle || !accountDropdown) return;

            accountToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                accountDropdown.classList.toggle('show');
            });

            document.addEventListener('click', function() {
                if (accountDropdown) {
                    accountDropdown.classList.remove('show');
                }
            });

            accountDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            if (accountOptions && accountOptions.length > 0) {
                accountOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        const selectedAccount = this.getAttribute('data-account');
                        
                        // Target the active session's form iframe
                        const activeFormId = currentSession === 1 ? 'form-frame-1' : 'form-frame-2';
                        const formIframe = document.getElementById(activeFormId); 
                        
                        if(formIframe) {
                             switchToAccount(selectedAccount, formIframe);
                        } else {
                             console.error("Target form iframe not found:", activeFormId);
                        }
                        
                        // Update active state
                        accountOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Close dropdown
                        accountDropdown.classList.remove('show');
                    });
                });
                
                if (accountOptions[0]) accountOptions[0].classList.add('active');
            }

            function switchToAccount(accountNumber, iframeElement) {
                if (iframeElement) {
                    const currentSrc = iframeElement.src;
                    try {
                        const url = new URL(currentSrc);
                        url.searchParams.set('authuser', accountNumber);
                        iframeElement.src = url.toString();
                        currentAccount = accountNumber;
                        console.log(\`Switched to account \${accountNumber} in \${iframeElement.id}\`);
                    } catch (e) {
                         console.error("Error updating URL for account switch:", e);
                    }
                }
            }
        }
    <\/script>
</body>
</html>
`;
        }
        
        // Helper function to format time for initial display
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
    </script>

</body>
</html>
